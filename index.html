<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>çº¸ä¸Šæ±Ÿæ¹– - é•¿å®‰äºŒåå››è®¡ x è²èŠ±æ¥¼</title>
    
    <!-- 1. å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. å¼•å…¥ Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { margin: 0; overflow: hidden; background-color: #2a231d; touch-action: manipulation; height: 100dvh; }
        #root { height: 100%; }
        
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #d6d3cd; border-radius: 2px; }
        .bg-[#2a231d] .custom-scrollbar::-webkit-scrollbar-thumb { background: #5d4d3d; }

        @keyframes float-up { 0% { transform: translate(-50%, 0) scale(1); opacity: 1; } 100% { transform: translate(-50%, -60px) scale(1.2); opacity: 0; } }
        .animate-float-up { animation: float-up 0.8s ease-out forwards; }
        @keyframes lunge-right { 0% { transform: translateX(0) rotate(-2deg); } 50% { transform: translateX(60px) rotate(5deg); } 100% { transform: translateX(0) rotate(-2deg); } }
        .animate-lunge-right { animation: lunge-right 0.25s ease-in-out; }
        @keyframes lunge-left { 0% { transform: translateX(0) rotate(2deg); } 50% { transform: translateX(-60px) rotate(-5deg); } 100% { transform: translateX(0) rotate(2deg); } }
        .animate-lunge-left { animation: lunge-left 0.25s ease-in-out; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 20% { transform: translateX(-5px) rotate(-5deg); } 40% { transform: translateX(5px) rotate(5deg); } 60% { transform: translateX(-5px); } 80% { transform: translateX(5px); } }
        .animate-shake { animation: shake 0.3s ease-in-out; }
        @keyframes pop-in { 0% { opacity: 0; transform: scale(0.8) translateY(10px); } 100% { opacity: 1; transform: scale(1) translateY(0); } }
        .animate-pop-in { animation: pop-in 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes bounce-sm { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
        .animate-bounce-sm { animation: bounce-sm 0.5s infinite; }
        @keyframes emote-bounce { 
            0% { transform: translate(-50%, 0) scale(0.0); opacity: 0; } 
            20% { transform: translate(-50%, -40px) scale(1.5); opacity: 1; } 
            30% { transform: translate(-50%, -30px) scale(1.2); } 
            40% { transform: translate(-50%, -40px) scale(1.3); } 
            50% { transform: translate(-50%, -35px) scale(1.2); }
            80% { transform: translate(-50%, -35px) scale(1.2); opacity: 1; }
            100% { transform: translate(-50%, -100px) scale(0.5); opacity: 0; } 
        }
        .animate-emote { animation: emote-bounce 3s cubic-bezier(0.68, -0.55, 0.27, 1.55) forwards; }
        @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }
        .animate-fade-in { animation: fade-in 1s ease-out forwards; }
    </style>
    
    <script type="importmap">
        {
            "imports": {
                "react": "https://esm.sh/react@18.2.0",
                "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
                "lucide-react": "https://esm.sh/lucide-react@0.263.1"
            }
        }
    </script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'https://esm.sh/react@18.2.0';
        import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';
        import { Sword, ShoppingBag, Play, Trophy, MessageCircle, Moon, Clock, Zap, Star, Shield, Skull, BookOpen, Wind, Scroll, Feather, Briefcase, User, PenTool, Users, UserPlus, Coins, X, Store, MousePointer, Power, ChevronRight, Lock, Award, Info, Heart, Map, Coffee, KeyRound, Pill, Leaf, Menu, Smile, Settings, Plus, Trash2, Edit3, Save, Image as ImageIcon, Cloud, Loader2, Link } from 'https://esm.sh/lucide-react@0.263.1';
        
        // --- Firebase Imports ---
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, doc, setDoc, onSnapshot, collection } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        // ==========================================
        //  ã€éƒ¨ç½²è¯´æ˜ã€‘ï¼šå°†æ‚¨çš„ Firebase é…ç½®æ›¿æ¢æ‰ä¸‹æ–¹çš„ null
        // ==========================================
        const MANUALLY_PASTE_FIREBASE_CONFIG_HERE ={
  apiKey: "AIzaSyAsR-raXlcfcl4cypSR0lucwa8WZ8NB3-U",
  authDomain: "zsjh-4cd72.firebaseapp.com",
  projectId: "zsjh-4cd72",
  storageBucket: "zsjh-4cd72.firebasestorage.app",
  messagingSenderId: "159277988582",
  appId: "1:159277988582:web:1024db59f3eebe21549927"
}; 
        
        // --- 1. å…¨å±€é…ç½®ä¸å¸¸é‡ ---
        const REST_DURATION = 60; 
        const PARTNER_UNLOCK_LEVEL = 3; 
        const PARTNER_COOLDOWN_BASE = 150; 
        const PARTNER_DURATION = 60000; 
        const INVITE_CODES = ["517", "520", "1314", "qiqi", "guoguo", "admin"]; 
        const SAVE_KEY = "paper_duel_save_v3"; 
        const CONFIG_SAVE_KEY = "paper_duel_config_v1";
        const FIREBASE_CONFIG_KEY = "paper_duel_firebase_config";
        
        const CRIT_IMAGE_URL = "./baoji.png"; 
        const FALLBACK_IMAGE_URL = "https://ui-avatars.com/api/?name=è¡¨æƒ…&background=b91c1c&color=fff&size=128&rounded=true&bold=true";

        // --- Firebase Initialization (Global Scope) ---
        let app, auth, db, appId;
        
        const initFirebase = (config) => {
            try {
                if (!config) return false;
                app = initializeApp(config);
                auth = getAuth(app);
                db = getFirestore(app);
                appId = config.appId || 'default-app-id'; 
                console.log("Firebase initialized successfully");
                return true;
            } catch (e) {
                console.error("Firebase initialization error:", e);
                return false;
            }
        };

        // ä¼˜å…ˆçº§ï¼š1. ä»£ç ç¡¬ç¼–ç  (éƒ¨ç½²ç”¨) -> 2. ç¯å¢ƒæ³¨å…¥ (Canvasç”¨) -> 3. æœ¬åœ°ç¼“å­˜ (è°ƒè¯•ç”¨)
        let firebaseConfig = null;
        
        if (MANUALLY_PASTE_FIREBASE_CONFIG_HERE) {
            firebaseConfig = MANUALLY_PASTE_FIREBASE_CONFIG_HERE;
        } else if (typeof __firebase_config !== 'undefined') {
            firebaseConfig = JSON.parse(__firebase_config);
        } else {
            const localConfig = localStorage.getItem(FIREBASE_CONFIG_KEY);
            if (localConfig) {
                try {
                    firebaseConfig = JSON.parse(localConfig);
                } catch(e) { console.error("Invalid local firebase config"); }
            }
        }
        
        if (firebaseConfig) {
            initFirebase(firebaseConfig);
        } else {
            console.warn("No Firebase config found. Running in offline mode.");
        }

        // --- é»˜è®¤é…ç½® (äº‘ç«¯æ— æ•°æ®æ—¶ä½¿ç”¨) ---
        const DEFAULT_EMOTE_DB = {
            defaults: {
                attack: ["âš”ï¸", "ğŸ‘Š", "ğŸ’¥", "ğŸ˜¤"],
                hit: ["ğŸ˜µ", "ğŸ¤•", "ğŸ’¦", "ğŸ’”"],
                dodge: ["ğŸ‘»", "ğŸ’¨", "ğŸ˜"],
                crit: ["âš¡", "ğŸŒŸ", "â˜ ï¸"],
                skill: ["ğŸ“œ", "âœ¨", "ğŸŒŠ"],
                win: ["âœŒï¸", "ğŸ‘‘", "ğŸ‰"],
                lose: ["ğŸ³ï¸", "ğŸ’€", "ğŸ¥€"]
            },
            players: {
                'xie_huaian': {
                    attack: ["âœ’ï¸", "ğŸ“–", "â™Ÿï¸", "ç®—æ— é—ç­–"],
                    crit: ["./baoji.png", "âš¡ï¸ç ´å±€ï¼"], 
                    hit: ["å’³å’³...", "å¤±ç®—äº†", "ğŸ›¡ï¸"],
                    win: ["â˜•ï¸", "æ‰¿è®©", "æ”¶å®˜"]
                },
                'li_lianhua': {
                    attack: ["ğŸ—¡ï¸", "ğŸƒ", "å©†å¨‘æ­¥"],
                    crit: ["./baoji.png", "å‰‘ç¥å†ä¸–!"],
                    hit: ["æ¯’å‘äº†...", "å“å“Ÿ", "ğŸ’Š"],
                    win: ["å»å»é‡å»å»", "ğŸ¶", "ğŸ¶"]
                }
            },
            enemies: {
                'é’¦å·®å¤§è‡£': { attack: ["å®˜å¨!", "æ‹¿ä¸‹!"], hit: ["å¤§èƒ†åˆæ°‘!", "ğŸ˜°"], lose: ["æˆ‘è¿˜ä¼šå›æ¥çš„..."] },
                'è§’ä¸½è°¯': { attack: ["ğŸ’‹", "ğŸ©¸", "å°Šä¸Š~"], hit: ["ä½ æ€ä¹ˆæ•¢!", "ğŸ’”"], win: ["ç”·äººéƒ½è¯¥æ­»"] },
                'å•å­¤åˆ€': { attack: ["å¤©ä¸‹æ˜¯æˆ‘çš„!", "å¸ˆå¼Ÿ!"], win: ["æˆ‘èµ¢äº†!"] },
                'ä¸è‰¯äºº': { attack: ["å¥‰å‘½è¡Œäº‹", "ğŸ”ª"], hit: ["ç‚¹å­æ‰æ‰‹!"] }
            }
        };

        const DEFAULT_STORY_DIALOGUES = {
          "é’¦å·®å¤§è‡£": [ "è°¢å¤§äººï¼Œè¿™è´¦æœ¬å¥½åƒä¸å¯¹å•Šã€‚", "å®˜åœºå¦‚æˆï¼Œå…¨é æ¼”æŠ€ã€‚" ],
          "å¥½å‹å‘¨å¢¨": [ "æ·®å®‰ï¼Œæ”¶æ‰‹å§ã€‚", "ä¸ºäº†ä¸€ä¸ªçœŸç›¸ï¼Œå€¼å¾—å—ï¼Ÿ" ],
          "ç‹æ ¡å°‰": [ "å¥‰å‘½è¡Œäº‹ï¼Œåˆ«æ€ªå…„å¼Ÿã€‚", "è™è´²è¥çš„åˆ€ï¼Œå¯ä¸é•¿çœ¼ï¼" ],
          "è§æ–‡æ•¬": [ "å“ˆå“ˆå“ˆï¼Œåˆ˜çŸ¥ï¼Œä½ æœç„¶æ²¡æ­»ï¼", "åªè¦æˆ‘æ´»ç€ï¼Œä½ å°±æ°¸è¿œæ˜¯é€ƒçŠ¯ã€‚" ],
          "è§æ­¦é˜³": [ "ä½ å°±æ˜¯é‚£ä¸ªæ¼ç½‘ä¹‹é±¼ï¼Ÿ", "æ•¢åŠ¨è§å®¶çš„äººï¼Œèƒ†å­ä¸å°ï¼" ],
          "è™è´²æš—å«": [ "ç›®æ ‡å‡ºç°ï¼Œæ ¼æ€å‹¿è®ºã€‚", "ä¸ºäº†å¤§ç»Ÿé¢†ï¼" ],
          "è’²é€†å·": [ "è°¢æ·®å®‰ï¼ä½ ä¸ºä»€ä¹ˆä¸æ•‘å¥¹ï¼", "åˆ˜å­è¨€...æˆ‘è¦æ€äº†åˆ˜å­è¨€ï¼" ],
          "é’è¡£": [ "å…¬å­ï¼Œå¥´å®¶é€ä½ ä¸Šè·¯ã€‚", "è¿™æŠŠä¼ï¼Œå¯æ˜¯ä¸ºäº†é®è¡€çš„ã€‚" ],
          "åˆ˜å­è¨€": [ "è¼èšæ’¼æ ‘ï¼Œä¸è‡ªé‡åŠ›ã€‚", "è°¢æ·®å®‰ï¼Œä½ çš„è®¡è°‹åœ¨æˆ‘ç»å¯¹å®åŠ›é¢å‰ï¼Œä¸€æ–‡ä¸å€¼ï¼" ],
          "æ±Ÿæ¹–éƒä¸­": ["çœ‹ä½ å°å ‚å‘é»‘ï¼Œææœ‰è¡€å…‰ä¹‹ç¾ï¼", "æˆ‘çš„è¯å¯æ˜¯ç¥–ä¼ çš„ï¼"],
          "é£ç«å ‚æ¶éœ¸": ["å°‘ç®¡é—²äº‹ï¼", "æŠŠé‚£åªç‹—ç•™ä¸‹ï¼"],
          "å•å­¤åˆ€": ["å¸ˆå¼Ÿï¼Œä½ è¿˜æ˜¯è¿™ä¹ˆå¤©çœŸã€‚", "è¿™å¤©ä¸‹ï¼Œç»ˆç©¶æ˜¯æˆ‘çš„ï¼"],
          "è§’ä¸½è°¯": ["å°Šä¸Šåªèƒ½æ˜¯æˆ‘çš„ï¼", "ç”·äººï¼Œéƒ½è¯¥æ­»ï¼"],
          "ç¬›é£å£°(å½±)": ["æç›¸å¤·ï¼Œå‡ºå‰‘ï¼", "å¤ªæ…¢äº†ï¼"],
          "default": [ "æ‹¿å‘½æ¥ï¼", "ä¼‘æƒ³é€ƒï¼", "ä¸­è®¡äº†ï¼", "å¯æ¶..." ]
        };
        
        const DIALOGUES = {
            player: {
                attack: ["æ­¤å±€å·²å®šã€‚", "ä½ è¾“äº†ã€‚", "å»å»é‡å»å»ã€‚", "è¿™æ‹›å¦‚ä½•ï¼Ÿ", "é“é”¹...æ˜¯ç”¨æ¥åŸ‹ä½ çš„ã€‚", "ä»Šæ—¥å®œè§£ç­¾ï¼Œå¤§å‰ã€‚"],
                hit: ["å’³å’³...æ— å¦¨ã€‚", "è¿™ç‚¹ä»£ä»·...å€¼å¾—ã€‚", "ç¢§èŒ¶ä¹‹æ¯’åˆçŠ¯äº†...", "è¿˜åœ¨è®¡ç®—ä¹‹ä¸­ã€‚", "å“å“Ÿï¼Œè½»ç‚¹ï¼"],
                win: ["æ¸…ç†å¹²å‡€ã€‚", "ä¸‹ä¸€ä¸ªã€‚", "é•¿å®‰çš„é›ªï¼Œåˆçº¢äº†å‡ åˆ†ã€‚", "ä¸è¿‡æ˜¯å¼ƒå­ã€‚", "æ‰¿è®©ã€‚"]
            }
        };

        // --- 2. çº¯å‡½æ•° ---
        const randomInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
        const randomItem = (arr) => arr && arr.length > 0 ? arr[Math.floor(Math.random() * arr.length)] : "";
        const isImageUrl = (str) => typeof str === 'string' && (str.startsWith('./') || str.startsWith('http') || str.startsWith('data:image'));
        
        const getPlayerStats = (p) => {
            let bonusAtk = 0; let bonusHp = 0; let bonusCrit = 0;
            if(p.slots) { Object.values(p.slots).forEach(item => { if (item) { bonusAtk += (item.atk || 0); bonusHp += (item.hp || 0); bonusCrit += (item.crit || 0); } }); }
            if (p.skills && p.skills.some(s => s.type === 'passive_crit_buff')) bonusCrit += 20; 
            const baseHp = p.baseHp || 100; const baseAtk = p.baseAtk || 10; const baseCrit = p.baseCrit || 0;
            return { maxHp: baseHp + bonusHp + (p.level - 1) * 15, atk: baseAtk + bonusAtk + (p.level - 1) * 2, crit: baseCrit + bonusCrit, bonusAtk, bonusHp, bonusCrit };
        };

        // --- 3. æ¸¸æˆé™æ€æ•°æ® ---
        const MINION_DB = { 'xie_huaian': ["æ›´å¤«", "åœ°ç—", "å·¡é€»å«å…µ", "ç‹åºœå®¶ä¸", "ä¸è‰¯äºº", "è’™é¢åˆ€å®¢", "å¤§ç†å¯ºå½¹"], 'li_lianhua': ["é‡‡è¯ç«¥å­", "é‡ç‹—å¸®ä¼—", "è·¯è¾¹ä¹ä¸", "é£ç«å ‚å¼Ÿå­", "é‡‘é¸³ç›Ÿæ¢å­", "ä¸‡åœ£é“æ­»å£«", "æ— åå‰‘å®¢"] };
        const STORY_CONFIGS = {
          'xie_huaian': { 1: { enemyName: "é’¦å·®å¤§è‡£", title: "ç¬¬ä¸€ç« Â·åˆå…¥é•¿å®‰", hpScale: 1.5, atkScale: 1.2 }, 2: { enemyName: "å¥½å‹å‘¨å¢¨", title: "ç¬¬äºŒç« Â·æ—§å‹é‡é€¢", hpScale: 2.0, atkScale: 1.5 }, 3: { enemyName: "ç‹æ ¡å°‰", title: "ç¬¬ä¸‰ç« Â·æš—æµæ¶ŒåŠ¨", hpScale: 2.5, atkScale: 1.8 }, 4: { enemyName: "è§æ–‡æ•¬", title: "ç¬¬å››ç« Â·ç¬‘é¢è™", hpScale: 3.5, atkScale: 2.2 }, 5: { enemyName: "è§æ­¦é˜³", title: "ç¬¬äº”ç« Â·ç¬¬ä¸€å±€Â·ç»ˆ", boss: true, hpScale: 10.0, atkScale: 5.0 }, 6: { enemyName: "è™è´²æš—å«", title: "ç¬¬å…­ç« Â·é€ä¸ªå‡»ç ´", hpScale: 5.0, atkScale: 3.0 }, 7: { enemyName: "è’²é€†å·", title: "ç¬¬ä¸ƒç« Â·é¬¼é¢å¤ä»‡", hpScale: 6.0, atkScale: 3.5 }, 8: { enemyName: "è™è´²æš—å«", title: "ç¬¬å…«ç« Â·é‡é‡åŒ…å›´", hpScale: 7.0, atkScale: 4.0 }, 9: { enemyName: "é’è¡£", title: "ç¬¬ä¹ç« Â·é’è¡£ç´ è£¹", hpScale: 9.0, atkScale: 5.0 }, 10: { enemyName: "åˆ˜å­è¨€", title: "ç¬¬åç« Â·ç¬¬äºŒå±€Â·ç»ˆ", boss: true, hpScale: 20.0, atkScale: 10.0 }, },
          'li_lianhua': { 1: { enemyName: "æ±Ÿæ¹–éƒä¸­", title: "ç¬¬ä¸€ç« Â·ä¸œæµ·ä¹‹æ»¨", hpScale: 1.5, atkScale: 1.2 }, 2: { enemyName: "é£ç«å ‚æ¶éœ¸", title: "ç¬¬äºŒç« Â·åˆéœ²é”‹èŠ’", hpScale: 2.0, atkScale: 1.5 }, 3: { enemyName: "æœ´é”„å±±å°¸", title: "ç¬¬ä¸‰ç« Â·è¯¡æ¡ˆè¿·è¸ª", hpScale: 2.5, atkScale: 1.8 }, 4: { enemyName: "å¦™æ‰‹ç©ºç©º", title: "ç¬¬å››ç« Â·æ•…äººç›¸è§", hpScale: 3.5, atkScale: 2.2 }, 5: { enemyName: "ç¬›é£å£°(å½±)", title: "ç¬¬äº”ç« Â·å®¿å‘½ä¹‹æ•Œ", boss: true, hpScale: 10.0, atkScale: 5.0 }, 6: { enemyName: "é‡‘é¸³ç›Ÿä¼—", title: "ç¬¬å…­ç« Â·ç™¾å·å½’æµ·", hpScale: 5.0, atkScale: 3.0 }, 7: { enemyName: "ä¸‡åœ£é“æ­»å£«", title: "ç¬¬ä¸ƒç« Â·é˜´è°‹æµ®ç°", hpScale: 6.0, atkScale: 3.5 }, 8: { enemyName: "è§’ä¸½è°¯", title: "ç¬¬å…«ç« Â·çº¢è¡£å¦–å¥³", hpScale: 7.0, atkScale: 4.0 }, 9: { enemyName: "å°ç£¬", title: "ç¬¬ä¹ç« Â·è¡€æµ·æ·±ä»‡", hpScale: 9.0, atkScale: 5.0 }, 10: { enemyName: "å•å­¤åˆ€", title: "ç¬¬åç« Â·å¸ˆé—¨æ©æ€¨", boss: true, hpScale: 20.0, atkScale: 10.0 }, }
        };
        const SKILLS_DB = { 'xie_huaian': { 1: { id: 'jiedao', name: "å€Ÿåˆ€æ€äºº", desc: "å€ŸåŠ›æ‰“åŠ›ï¼Œåå¼¹30%ä¼¤å®³", type: "passive_reflect" }, 3: { id: 'diaohu', name: "è°ƒè™ç¦»å±±", desc: "é—ªé¿ç‡æå‡15%", type: "passive_dodge" }, 6: { id: 'fudi', name: "é‡œåº•æŠ½è–ª", desc: "æ”»å‡»å‰Šå‡æ•Œäººæ”»å‡»åŠ›", type: "passive_debuff" }, 9: { id: 'jinchan', name: "é‡‘è‰è„±å£³", desc: "è‡´å‘½å…æ­»å¹¶å›è¡€", type: "passive_resurrect" }, 12: { id: 'lianhuan', name: "è¿ç¯è®¡", desc: "40%å‡ ç‡è¿½åŠ ä¼¤å®³", type: "passive_double" }, 15: { id: 'manutian', name: "ç’å¤©è¿‡æµ·", desc: "æ•Œäºº<40%è¡€æ–©æ€", type: "passive_execute" } }, 'li_lianhua': { 1: { id: 'yangzhouman', name: "æ‰¬å·æ…¢", desc: "æš´å‡»å›å¤ç”Ÿå‘½", type: "passive_heal" }, 3: { id: 'posuobu', name: "å©†å¨‘æ­¥", desc: "é—ªé¿ç‡æå‡15%", type: "passive_dodge" }, 6: { id: 'xiangyi', name: "ç›¸å¤·å¤ªå‰‘", desc: "30%å‡ ç‡äºŒè¿å‡»", type: "passive_double" }, 9: { id: 'bi_cha', name: "ç¢§èŒ¶å‹åˆ¶", desc: "è¡€è¶Šä½æ”»è¶Šé«˜", type: "passive_low_hp" }, 12: { id: 'xiaolou', name: "å°æ¥¼ä¸œé£", desc: "çˆ†ä¼¤æå‡50%", type: "passive_crit_dmg" }, 15: { id: 'mingyue', name: "æ˜æœˆè¥¿æµ·", desc: "é™„åŠ çœŸå®ä¼¤å®³", type: "passive_true_dmg" } } };
        const PARTNERS_DB = { 'xie_huaian': [ { id: 'ye_zheng', name: "å¶é“®", title: "å­¤å‚²å‰‘å®¢", unlockLevel: 3, desc: "ä¸€å‰‘å…‰å¯’", visual: 'ye_zheng', skillName: "ç»å°˜å‰‘", skillDesc: "æé«˜ä¼¤å®³", duration: 60000, cooldown: PARTNER_COOLDOWN_BASE * 2, color: "#18181b" }, { id: 'zhang_mo', name: "å¼ é»˜", title: "åŸè§æ–‡æ•¬", unlockLevel: 4, desc: "ä»¥æ–§è¯é“", visual: 'zhang_mo', skillName: "å¼€å±±æ–§", skillDesc: "å¼ºåŠ›åŠˆç ", duration: 60000, cooldown: PARTNER_COOLDOWN_BASE, color: "#52525b" }, { id: 'pu_nichuan', name: "è’²é€†å·", title: "é¬¼é¢äºº", unlockLevel: 7, desc: "ä¸æ­»ä¸ä¼‘", visual: 'pu_nichuan', skillName: "è¡€ç¥­", skillDesc: "ç–¯ç‹‚æ”»å‡»", duration: 60000, cooldown: PARTNER_COOLDOWN_BASE, color: "#7f1d1d" }, { id: 'bai_wan', name: "ç™½çš–", title: "ç¥ç§˜äºº", unlockLevel: 8, desc: "æ¥å»æ— è¸ª", visual: 'bai_wan', skillName: "è¿·è¸ª", skillDesc: "ååŠ©æ”»å‡»ï¼Œå¹²æ‰°æ•Œäºº", duration: 60000, cooldown: PARTNER_COOLDOWN_BASE, color: "#e5e7eb" } ], 'li_lianhua': [ { id: 'fang_duobing', name: "æ–¹å¤šç—…", title: "å¤©æœºå ‚å°‘ä¸»", unlockLevel: 3, desc: "æœºå…³ç™¾å˜", visual: 'fang_duobing', skillName: "å°”é›…å‰‘", skillDesc: "ä¼¤å®³+æŠ¤ç›¾", duration: 60000, cooldown: PARTNER_COOLDOWN_BASE, color: "#3b82f6" }, { id: 'di_feisheng', name: "ç¬›é£å£°", title: "é‡‘é¸³ç›Ÿä¸»", unlockLevel: 6, desc: "æ‚²é£ç™½æ¨", skillDesc: "æ— è§†é˜²å¾¡çˆ†ä¼¤", duration: 45000, cooldown: PARTNER_COOLDOWN_BASE * 1.5, color: "#b91c1c" } ] };
        const CHARACTERS_DATA = [ { id: 'xie_huaian', name: "è°¢æ·®å®‰", realName: "åˆ˜çŸ¥", desc: "ç™½å‘è°‹å£«ï¼Œæ­¥æ­¥ä¸ºè¥ã€‚", baseHp: 120, baseAtk: 12, baseCrit: 20, visual: 'xie_huaian', themeColor: '#2a231d' }, { id: 'li_lianhua', name: "æè²èŠ±", realName: "æç›¸å¤·", desc: "ç¥ç§˜ç¥åŒ»ï¼Œæ˜”æ—¥å‰‘ç¥ã€‚", baseHp: 140, baseAtk: 15, baseCrit: 10, visual: 'li_lianhua', themeColor: '#064e3b' } ];
        const EQUIPMENT_POOLS = { 
            'xie_huaian': [ 
                { name: "å‰Šæ¢¨å°åˆ€", type: "weapon", visual: "knife", atk: 12, hp: 0, rarity: 1, price: 50, desc: "é”‹åˆ©å¼‚å¸¸" }, 
                { name: "æ—§é“é”¹", type: "weapon", visual: "shovel", atk: 45, hp: 50, rarity: 2, price: 500, desc: "ç®¡æ€ç®¡åŸ‹" }, 
                { name: "ç‹¼æ¯«ç¬”", type: "weapon", visual: "brush", atk: 10, hp: 0, rarity: 1, price: 40, desc: "æ€äººæ— å½¢" }, 
                { name: "ç²¾é’¢ä¼éª¨", type: "weapon", visual: "umbrella_rib", atk: 15, hp: 0, crit: 5, rarity: 1, price: 100, desc: "æš—è—åˆ©å™¨" }, 
                { name: "äºŒåå››è®¡æ‰‹æœ­", type: "weapon", visual: "scroll", atk: 25, hp: 20, crit: 10, rarity: 2, price: 300, desc: "è®°è½½ç€ç»ä¸–è®¡è°‹" }, 
                { name: "ç´ éº»è¡£", type: "clothes", visual: "robe_gray", atk: 0, hp: 50, rarity: 1, price: 50, desc: "æ©äººè€³ç›®" }, 
                { name: "é¹¤æ°…", type: "clothes", visual: "robe_white", atk: 2, hp: 80, rarity: 2, price: 200, desc: "åå£«ä¹‹é£" }, 
                { name: "æŠ¤è…•", type: "guard", visual: "bracer", atk: 1, hp: 30, rarity: 1, price: 60, desc: "çš®è´¨æŠ¤è…•" }, 
                { name: "å¹³å®‰æ‰£", type: "guard", visual: "jade", atk: 0, hp: 40, rarity: 1, price: 80, desc: "æ—§ç‰©" }, 
                { name: "é‡‘ç–®è¯", type: "consumable", visual: "pill", heal: 80, rarity: 1, price: 30, desc: "å›è¡€80" }, 
                { name: "åŠè¾¹æ¥›", type: "consumable", visual: "herb", heal: 50, cure: true, rarity: 2, price: 60, desc: "è§£æ¯’å›è¡€" }, 
                { name: "æ–­æœ¨å‰‘", type: "weapon", visual: "stick", atk: 3, hp: 0, rarity: 1, price: 10, desc: "ç©å…·" }, 
                { name: "çŸ³å­", type: "weapon", visual: "stone", atk: 5, hp: 0, rarity: 1, price: 5, desc: "è·¯è¾¹çš„" } 
            ], 
            'li_lianhua': [ 
                { name: "å°‘å¸ˆå‰‘", type: "weapon", visual: "sword_shaoshi", atk: 35, hp: 0, crit: 10, rarity: 2, price: 600, desc: "å‰‘ç¥ä½©å‰‘" }, 
                { name: "åˆé¢ˆè½¯å‰‘", type: "weapon", visual: "sword_wenjing", atk: 30, hp: 0, crit: 15, rarity: 2, price: 500, desc: "é˜²ä¸èƒœé˜²" }, 
                { name: "é’é’¢å‰‘", type: "weapon", visual: "sword", atk: 15, hp: 0, rarity: 1, price: 80, desc: "æ±Ÿæ¹–å¸¸è§çš„å…µå™¨" }, 
                { name: "ä¸€è¢‹ç³–", type: "guard", visual: "candy", atk: 0, hp: 50, rarity: 1, price: 30, desc: "å¿ƒæƒ…å¥½" }, 
                { name: "ç‹ç‹¸ç²¾é¡¹åœˆ", type: "guard", visual: "collar", atk: 5, hp: 60, rarity: 1, price: 120, desc: "ç‹—ä¹Ÿæ˜¯å¾ˆå‡¶çš„" }, 
                { name: "æ¸¸åŒ»å¸ƒè¢", type: "clothes", visual: "robe_green", atk: 0, hp: 80, rarity: 1, price: 100, desc: "å¹²å‡€æ—§è¡£" }, 
                { name: "è²èŠ±ç‰ä½©", type: "guard", visual: "jade_lotus", atk: 2, hp: 40, rarity: 1, price: 150, desc: "æ¸©æ¶¦" }, 
                { name: "é‡‘ç–®è¯", type: "consumable", visual: "pill", heal: 80, rarity: 1, price: 30, desc: "å›è¡€80" }, 
                { name: "åŠè¾¹æ¥›", type: "consumable", visual: "herb", heal: 50, cure: true, rarity: 2, price: 60, desc: "ç¨€ä¸–è‰è¯ï¼Œè§£æ¯’å¹¶å›å¤50ç‚¹ç”Ÿå‘½" }, 
                { name: "ç”Ÿé”ˆå‰ªåˆ€", type: "weapon", visual: "scissors", atk: 5, hp: 0, rarity: 1, price: 10, desc: "å‰ªè¯æ" }, 
                { name: "è‰é‹", type: "guard", visual: "shoes", atk: 0, hp: 10, rarity: 1, price: 5, desc: "èµ°ä¸¤æ­¥å°±ç£¨ç ´äº†" } 
            ] 
        };

        // --- 4. ç»„ä»¶å®šä¹‰ ---
        
        // SVG çº¸ç‰‡äººç»„ä»¶
        const PaperStickman = ({ color = "black", isEnemy = false, slots = {}, isSleeping = false, charVisual = 'hero', emote = null }) => {
          const weapon = slots.weapon?.visual;
          const clothes = slots.clothes?.visual;
          const guard = slots.guard?.visual;
          
          return (
            <div className="relative w-full h-full">
                {emote && (
                    <div className="absolute -top-32 left-1/2 -translate-x-1/2 z-20 animate-emote pointer-events-none">
                        <div className="bg-white p-1 rounded-lg border-2 border-black shadow-lg flex items-center justify-center min-w-[50px] min-h-[50px]">
                           {/* ä¼˜å…ˆæ˜¾ç¤ºå›¾ç‰‡ï¼Œå¦‚æœæ²¡æœ‰å›¾ç‰‡åˆ™æ˜¾ç¤ºæ–‡å­— */}
                           {isImageUrl(emote.content) ? (
                               <img 
                                 src={emote.content} 
                                 alt="emote" 
                                 className="w-16 h-16 object-contain" 
                                 onError={(e) => { e.target.onerror=null; e.target.src=FALLBACK_IMAGE_URL; }}
                               />
                           ) : <span className="text-3xl p-1">{emote.content}</span>}
                           {/* æ°”æ³¡å°ä¸‰è§’ */}
                           <div className="absolute -bottom-1.5 left-1/2 -translate-x-1/2 w-3 h-3 bg-white border-b-2 border-r-2 border-black transform rotate-45"></div>
                        </div>
                    </div>
                )}
                <svg viewBox="0 0 100 150" className={`w-full h-full drop-shadow-md overflow-visible transition-transform duration-500 ${isSleeping ? 'rotate-90 translate-y-10' : ''}`}>
                  <g stroke={color} strokeWidth="3" fill="none" strokeLinecap="round" strokeLinejoin="round">
                    {isEnemy ? (
                      <>
                         {charVisual === 'é’è¡£' || charVisual === 'è§’ä¸½è°¯' ? (
                            <g stroke="none">
                                <path d="M30 45 L70 45 L80 125 L20 125 Z" fill={charVisual==='è§’ä¸½è°¯'?'#b91c1c':'#d1fae5'} stroke="#333" strokeWidth="1.5" />
                                <circle cx="50" cy="28" r="14" fill="#fce4d4" stroke="#333" strokeWidth="1.5" />
                                <path d="M30 20 L50 40 L70 20 L50 0 Z" fill="#333" /> 
                                <path d="M20 20 Q50 60 80 20" fill="none" stroke="#333" strokeWidth="10" opacity="0.8" /> 
                            </g>
                         ) : (
                            <>
                               <path d="M50 30 L30 60 L70 60 Z" fill="#333" fillOpacity="0.2" />
                               <path d="M50 30 L50 90 L30 140 M50 90 L70 140 M30 60 L70 60" />
                               <circle cx="50" cy="30" r="15" fill={charVisual === 'è’²é€†å·' ? '#7f1d1d' : '#333'} />
                               <path d="M40 25 L60 25" stroke="gold" strokeWidth="2" />
                               <circle cx="42" cy="30" r="2" fill="red" stroke="none" />
                               <circle cx="58" cy="30" r="2" fill="red" stroke="none" />
                               <line x1="20" y1="40" x2="80" y2="30" stroke="#555" strokeWidth="3" />
                            </>
                         )}
                      </>
                    ) : (
                      <g stroke="none">
                        {charVisual === 'ye_zheng' ? (
                          <g>
                             <path d="M30 45 L70 45 L75 120 L25 120 Z" fill="#18181b" stroke="#52525b" strokeWidth="1.5" /> 
                             <path d="M20 25 L80 25 L50 10 Z" fill="#3f3f46" stroke="#000" />
                             <circle cx="50" cy="35" r="12" fill="#fce4d4" stroke="#333" strokeWidth="1.5" />
                             <path d="M30 50 Q15 65 10 90" stroke="#333" strokeWidth="1" fill="#27272a" /> 
                             <path d="M70 50 Q85 65 90 90" stroke="#333" strokeWidth="1" fill="#27272a" />
                             <g transform="translate(85, 80) rotate(-60)"><rect x="-2" y="-10" width="4" height="60" fill="#e4e4e7" stroke="#000" /></g>
                          </g>
                        ) : charVisual === 'zhang_mo' ? (
                          <g>
                             <path d="M25 45 L75 45 L80 120 L20 120 Z" fill="#78716c" stroke="#44403c" strokeWidth="1.5" /> 
                             <circle cx="50" cy="28" r="15" fill="#fce4d4" stroke="#333" strokeWidth="1.5" />
                             <path d="M35 15 Q50 5 65 15" fill="#44403c" />
                             <path d="M25 50 Q15 60 15 85" stroke="#333" strokeWidth="1" fill="#a8a29e" /> 
                             <path d="M75 50 Q85 60 85 85" stroke="#333" strokeWidth="1" fill="#a8a29e" />
                             <g transform="translate(85, 85) rotate(-20)"><rect x="-2" y="-10" width="4" height="40" fill="#573a2e" /><path d="M-2 5 L-10 0 L-10 20 L-2 15 Z" fill="#9ca3af" stroke="#000" /></g>
                          </g>
                        ) : charVisual === 'pu_nichuan' ? (
                          <g>
                             <path d="M30 45 L70 45 L80 120 L20 120 Z" fill="#450a0a" stroke="#b91c1c" strokeWidth="1.5" /> 
                             <circle cx="50" cy="28" r="14" fill="#991b1b" stroke="#000" strokeWidth="1.5" />
                             <circle cx="44" cy="28" r="3" fill="#000" /> <circle cx="56" cy="28" r="3" fill="#000" />
                             <path d="M45 38 Q50 30 55 38" stroke="#fff" strokeWidth="2" fill="none" />
                             <path d="M30 50 Q15 65 10 90" stroke="#333" strokeWidth="1" fill="#7f1d1d" /> 
                             <path d="M70 50 Q85 65 90 90" stroke="#333" strokeWidth="1" fill="#7f1d1d" />
                          </g>
                        ) : charVisual === 'bai_wan' ? (
                          <g>
                             <path d="M35 45 L65 45 L75 125 L25 125 Z" fill="#fff" stroke="#e5e7eb" strokeWidth="1.5" /> 
                             <circle cx="50" cy="28" r="14" fill="#fce4d4" stroke="#333" strokeWidth="1.5" />
                             <path d="M36 20 Q50 5 64 20" fill="none" stroke="#333" strokeWidth="2" />
                             <path d="M35 50 Q20 60 20 85" stroke="#e5e7eb" strokeWidth="1" fill="#fff" />
                             <path d="M65 50 Q80 60 80 85" stroke="#e5e7eb" strokeWidth="1" fill="#fff" />
                          </g>
                        ) : charVisual === 'li_lianhua' ? (
                          <g>
                             <path d="M30 45 L70 45 L80 120 L20 120 Z" fill={clothes==='robe_green'?'#f0fdf4':'#ecfdf5'} stroke="#065f46" strokeWidth="1.5" /> 
                             <circle cx="50" cy="30" r="18" fill="#fce4d4" stroke="#333" strokeWidth="1.5" />
                             <path d="M32 25 Q35 12 50 12 Q65 12 68 25 Q68 18 50 18 Q32 18 32 25" fill="#2d2d2d" />
                             <rect x="40" y="8" width="20" height="4" fill="#10b981" rx="2" />
                             <circle cx="44" cy="30" r="2" fill="#333" />
                             <circle cx="56" cy="30" r="2" fill="#333" />
                             <path d="M48 36 Q50 38 52 36" stroke="#333" strokeWidth="1" fill="none" />
                             <path d="M30 50 Q15 65 10 90" stroke="#333" strokeWidth="1" fill="#d1fae5" /> 
                             <path d="M70 50 Q85 65 90 90" stroke="#333" strokeWidth="1" fill="#d1fae5" />
                             {weapon === 'sword_shaoshi' && (<g transform="translate(85, 95) rotate(-45)"><rect x="-3" y="-15" width="6" height="50" fill="#e2e8f0" stroke="#1e293b" strokeWidth="0.5" /><path d="M0 36 Q5 45 0 55" stroke="blue" strokeWidth="1.5" fill="none" /></g>)}
                             {weapon === 'sword_wenjing' && (<g transform="translate(85, 95) rotate(-30)"><path d="M0 30 Q-10 10 0 -10 Q10 10 0 30" fill="#cbd5e1" stroke="#334155" strokeWidth="0.5" /><rect x="-5" y="25" width="10" height="3" fill="#b91c1c" stroke="#333" strokeWidth="0.5" /></g>)}
                             {guard === 'candy' && (<circle cx="35" cy="80" r="4" fill="#f472b6" stroke="#db2777" />)}
                          </g>
                        ) : (
                          <g>
                            {clothes === 'robe_white' ? (<path d="M35 45 L65 45 L80 125 L20 125 Z" fill="#f8fafc" stroke="#94a3b8" strokeWidth="1.5" />) : clothes === 'robe_gray' ? (<path d="M35 45 L65 45 L75 125 L25 125 Z" fill="#a8a29e" stroke="#57534e" strokeWidth="1.5" />) : (<path d="M35 45 L65 45 L75 125 L25 125 Z" fill="#e0f2fe" stroke="#334155" strokeWidth="1.5" />)}
                            <path d="M35 45 L50 75 L65 45" fill="none" stroke="#333" strokeWidth="1" />
                            <circle cx="50" cy="28" r="14" fill="#fce4d4" stroke="#333" strokeWidth="1.5" />
                            <path d="M36 20 Q50 10 64 20 Q64 35 60 45" stroke="#d1d5db" strokeWidth="3" fill="none" />
                            <path d="M36 20 Q30 35 32 45" stroke="#d1d5db" strokeWidth="3" fill="none" />
                            <path d="M36 20 Q50 5 64 20 Q64 15 50 12 Q36 15 36 20" fill="#d1d5db" />
                            <circle cx="50" cy="15" r="5" fill="#d1d5db" />
                            <line x1="42" y1="15" x2="58" y2="15" stroke="#9ca3af" strokeWidth="1" />
                            <path d="M44 29 L48 28" stroke="#333" strokeWidth="1" /> 
                            <path d="M56 28 L52 29" stroke="#333" strokeWidth="1" />
                            <circle cx="45" cy="31" r="1.5" fill="#333" />
                            <circle cx="55" cy="31" r="1.5" fill="#333" />
                            <path d="M48 37 L52 37" stroke="#333" strokeWidth="1" /> 
                            <path d="M35 50 Q20 60 20 85" stroke="#333" strokeWidth="1" fill={clothes==='robe_gray'?'#a8a29e':clothes==='robe_white'?'#f8fafc':'#bfdbfe'} />
                            <path d="M35 60 Q30 70 30 85" stroke="#333" strokeWidth="1" fill={clothes==='robe_gray'?'#a8a29e':clothes==='robe_white'?'#f8fafc':'#bfdbfe'} />
                            <circle cx="25" cy="90" r="3" fill="#fce4d4" stroke="#333" strokeWidth="1" /> 
                            <path d="M65 50 Q80 60 80 85" stroke="#333" strokeWidth="1" fill={clothes==='robe_gray'?'#a8a29e':clothes==='robe_white'?'#f8fafc':'#bfdbfe'} />
                            <path d="M65 60 Q70 70 70 85" stroke="#333" strokeWidth="1" fill={clothes==='robe_gray'?'#a8a29e':clothes==='robe_white'?'#f8fafc':'#bfdbfe'} />
                            <circle cx="75" cy="90" r="3" fill="#fce4d4" stroke="#333" strokeWidth="1" />
                            <circle cx="35" cy="50" r="1.5" fill="#fbbf24" stroke="#b45309" strokeWidth="0.5" />
                            <circle cx="65" cy="50" r="1.5" fill="#fbbf24" stroke="#b45309" strokeWidth="0.5" />
                            {weapon === 'knife' && (<g transform="translate(80, 85) rotate(150)"><rect x="-2" y="0" width="4" height="15" fill="#9ca3af" stroke="#333" strokeWidth="0.5" /><path d="M-2 15 L2 15 L0 25 Z" fill="#9ca3af" stroke="#333" strokeWidth="0.5" /><rect x="-3" y="-5" width="6" height="5" fill="#78350f" /></g>)}
                            {weapon === 'shovel' && (<g transform="translate(85, 95) rotate(-10)"><rect x="-1.5" y="-45" width="3" height="60" fill="#3e2723" stroke="#000" strokeWidth="0.5" /><path d="M-8 15 L8 15 L8 35 Q0 38 -8 35 Z" fill="#64748b" stroke="#000" strokeWidth="0.5" /><circle cx="0" cy="20" r="2" fill="red" /></g>)}
                            {weapon === 'brush' && (<g transform="translate(80, 85) rotate(-30)"><rect x="-1.5" y="-20" width="3" height="30" fill="#3f2c22" stroke="#000" strokeWidth="0.5" /><path d="M-2 10 Q0 20 2 10 Z" fill="#333" /></g>)}
                            {weapon === 'umbrella_rib' && (<g transform="translate(80, 85) rotate(-45)"><rect x="-0.5" y="-10" width="1" height="45" fill="#d1d5db" stroke="#333" strokeWidth="0.5" /><path d="M-1 35 L1 35 L0 45 Z" fill="#d1d5db" /></g>)}
                            {weapon === 'scroll' && (<g transform="translate(25, 85) rotate(10)"><rect x="-5" y="-10" width="10" height="25" fill="#fef3c7" stroke="#b45309" strokeWidth="1" /><line x1="-3" y1="-5" x2="3" y2="-5" stroke="#b45309" strokeWidth="0.5" /></g>)}
                            {weapon === 'stick' && (<rect x="80" y="70" width="4" height="40" fill="#a16207" transform="rotate(-30 82 90)" />)}
                            {guard === 'shoes' && (<><rect x="36" y="125" width="12" height="5" fill="#fcd34d" /><rect x="54" y="125" width="12" height="5" fill="#fcd34d" /></>)}
                            {guard === 'bracer' && (<rect x="20" y="75" width="10" height="8" fill="#573a2e" opacity="0.8" transform="rotate(-10 25 79)" />)}
                            {guard === 'jade' && (<circle cx="35" cy="75" r="3" fill="#86efac" stroke="#166534" strokeWidth="1" />)}
                          </g>
                        )}
                        {isSleeping && (
                           <g className="animate-pulse opacity-70">
                              <text x="65" y="15" fontSize="14" fill="blue" stroke="none">...</text>
                           </g>
                        )}
                      </g>
                    )}
                  </g>
                </svg>
            </div>
          );
        };

        // --- ä¸»ç»„ä»¶ ---
        const PaperDuel = () => {
             // 1. å…ˆè¿›è¡Œæ‰€æœ‰çš„ useState
             const [gameState, setGameState] = useState('LOGIN'); 
             const [inputCode, setInputCode] = useState('');
             const [loginError, setLoginError] = useState('');
             const [currentUser, setCurrentUser] = useState(null); 
             
             // è‡ªå®šä¹‰é…ç½®çŠ¶æ€
             const [customConfig, setCustomConfig] = useState({
                 dialogues: DEFAULT_STORY_DIALOGUES,
                 emotes: DEFAULT_EMOTE_DB
             });
             const [showAdmin, setShowAdmin] = useState(false);
             const [adminTab, setAdminTab] = useState('DIALOGUES');
             const [editingKey, setEditingKey] = useState(null); 
             const [newItemInput, setNewItemInput] = useState('');
             const [firebaseConfigInput, setFirebaseConfigInput] = useState(''); 
             
             // Admin Emote States
             const [emoteCategory, setEmoteCategory] = useState('defaults');
             const [emoteKey, setEmoteKey] = useState(null);
             const [emoteType, setEmoteType] = useState('attack');
             const [newEmoteInput, setNewEmoteInput] = useState('');

             // --- çŠ¶æ€ç®¡ç† Ref ---
             const stateRef = useRef({
                player: null,
                enemy: null,
                gameState: 'LOGIN',
                showShop: false,
                showPartnerSelect: false,
                showStats: false,
                showMap: false,
                activeMobileTab: 'BATTLE',
                isAutoBattle: true,
                partnerActive: false,
                currentPartner: null,
                stage: 1,
                maxUnlockedStage: 1, 
                unlockedPartners: [],
                processingVictory: false,
                shop: { items: [], nextRefresh: 0 },
                config: { dialogues: DEFAULT_STORY_DIALOGUES, emotes: DEFAULT_EMOTE_DB } 
             });
             
             const [playerEmote, setPlayerEmote] = useState(null);
             const [enemyEmote, setEnemyEmote] = useState(null);

             const [player, setPlayer] = useState({
                id: 'xie_huaian', name: "æœªå‘½å", baseHp: 100, currentHp: 100, baseAtk: 10, baseCrit: 20,
                level: 1, exp: 0, maxExp: 100, money: 100, bag: [],
                slots: { weapon: null, clothes: null, guard: null },
                skills: [], visual: 'xie_huaian', partnerUnlocked: false, lastPartnerUseTime: 0
             });

             const [enemy, setEnemy] = useState({ name: "æ•Œäºº", maxHp: 100, currentHp: 100, atk: 8, level: 1, isBoss: false, visual: 'enemy', baseName: '' });
             const [stage, setStage] = useState(1);
             const [maxUnlockedStage, setMaxUnlockedStage] = useState(1);
             const [logs, setLogs] = useState([]);
             const [chats, setChats] = useState([]);
             const [floatingTexts, setFloatingTexts] = useState([]);
             const [restTime, setRestTime] = useState(0); 
             const [resurrected, setResurrected] = useState(false);
             const [partnerActive, setPartnerActive] = useState(false);
             const [currentPartner, setCurrentPartner] = useState(null);
             const [partnerCooldownTimer, setPartnerCooldownTimer] = useState(0);
             const [unlockedPartners, setUnlockedPartners] = useState([]); 
             const [showShop, setShowShop] = useState(false); 
             const [showPartnerSelect, setShowPartnerSelect] = useState(false); 
             const [showStats, setShowStats] = useState(false); 
             const [showMap, setShowMap] = useState(false); 
             const [activeMobileTab, setActiveMobileTab] = useState('BATTLE');
             const [isAutoBattle, setIsAutoBattle] = useState(true);
             const [shopState, setShopState] = useState({ items: [], nextRefresh: 0 });

             const logsEndRef = useRef(null);
             const chatsEndRef = useRef(null);
             const playerRef = useRef(null);
             const enemyRef = useRef(null);
             const partnerRef = useRef(null);
             const battleLoopRef = useRef(null); 
             
             // --- æ ¸å¿ƒå‡½æ•°å®šä¹‰ (æ”¾åœ¨æ¸²æŸ“å˜é‡ä¹‹å‰) ---
             
             const updatePlayer = (updater) => setPlayer(prev => (typeof updater === 'function' ? updater(prev) : updater));
             const updateEnemy = (updater) => setEnemy(prev => (typeof updater === 'function' ? updater(prev) : updater));
             
             const addLog = (text, type = 'info') => setLogs(prev => [...prev.slice(-19), { id: Date.now() + Math.random(), text, type }]);
             const addChat = (speaker, text) => setChats(prev => [...prev.slice(-9), { id: Date.now() + Math.random(), speaker, text }]);
             const addFloatingText = (value, type, target) => { 
                const id = Date.now() + Math.random();
                setFloatingTexts(prev => [...prev, { id, value, type, target }]);
                setTimeout(() => setFloatingTexts(prev => prev.filter(ft => ft.id !== id)), 1000);
             };

             const loadSavedData = () => {
                 try {
                     const saved = localStorage.getItem(SAVE_KEY);
                     const configSaved = localStorage.getItem(CONFIG_SAVE_KEY);
                     
                     if (configSaved) {
                         const parsedConfig = JSON.parse(configSaved);
                         setCustomConfig(parsedConfig);
                         stateRef.current.config = parsedConfig;
                     }

                     return saved ? JSON.parse(saved) : null;
                 } catch (e) { return null; }
             };

             const handleLogin = () => {
                if (inputCode === "admin") {
                    setGameState('ADMIN');
                    return;
                }
                if (INVITE_CODES.includes(inputCode)) {
                  setGameState('GACHA'); 
                } else {
                  setLoginError("é‚€è¯·ç é”™è¯¯ï¼Œè¯·è”ç³»æ·‡æ·‡è·å–");
                }
             };

             const handleConnectCloud = () => {
                 try {
                     const config = JSON.parse(firebaseConfigInput);
                     if (initFirebase(config)) {
                         localStorage.setItem(FIREBASE_CONFIG_KEY, JSON.stringify(config));
                         addLog("äº‘ç«¯è¿æ¥æˆåŠŸï¼æ­£åœ¨åŒæ­¥...", "success");
                         onAuthStateChanged(auth, (user) => {
                             setCurrentUser(user);
                             if(user) addLog("ç”¨æˆ·å·²ç™»å½•", "success");
                         });
                         signInAnonymously(auth);
                     } else {
                         addLog("è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®æ ¼å¼", "error");
                     }
                 } catch (e) {
                     addLog("JSON æ ¼å¼é”™è¯¯", "error");
                 }
             };

             // æå‰è®¡ç®—å±æ€§
             const stats = getPlayerStats(player); 
             const charData = CHARACTERS_DATA.find(c => c.id === player.id) || CHARACTERS_DATA[0];
             const currentShopPool = EQUIPMENT_POOLS[player.id] || EQUIPMENT_POOLS['xie_huaian'];
             const currentPartnerList = PARTNERS_DB[player.id] || [];

             const triggerEmote = (target, type) => {
                 let content = "";
                 const currentConfig = stateRef.current.config; 
                 const emoteDB = currentConfig.emotes;
                 
                 if (target === 'player') {
                     const playerSpecific = emoteDB.players[player.id]?.[type];
                     if (playerSpecific && playerSpecific.length > 0) {
                         content = randomItem(playerSpecific);
                     } else {
                         content = randomItem(emoteDB.defaults[type] || emoteDB.defaults.attack);
                     }
                     setPlayerEmote({ id: Date.now(), content: content }); 
                     setTimeout(() => setPlayerEmote(prev => prev?.id === content.id ? null : prev), 3000);

                 } else {
                     const enemyBaseName = enemy.baseName;
                     const enemySpecific = emoteDB.enemies[enemyBaseName]?.[type];
                     
                     if (enemySpecific && enemySpecific.length > 0) {
                         content = randomItem(enemySpecific);
                     } else {
                         content = randomItem(emoteDB.defaults[type] || emoteDB.defaults.attack);
                     }
                     
                     setEnemyEmote({ id: Date.now(), content: content });
                     setTimeout(() => setEnemyEmote(prev => prev?.id === content.id ? null : prev), 1500);
                 }
             };
             
             const generateShopItems = (pid) => {
                 const pool = EQUIPMENT_POOLS[pid] || EQUIPMENT_POOLS['xie_huaian'];
                 const commons = pool.filter(i => i.rarity === 1);
                 const rares = pool.filter(i => i.rarity === 2);
                 const items = [];
                 for (let i = 0; i < 6; i++) {
                     if (Math.random() < 0.05 && rares.length > 0) { items.push({ ...randomItem(rares), id: Date.now() + i }); } 
                     else { items.push({ ...randomItem(commons), id: Date.now() + i }); }
                 }
                 return items;
             };
             
             const refreshShop = (pid, manual = false) => {
                 if (manual) {
                     if (player.money < 50) { addLog("é“¶ä¸¤ä¸è¶³ï¼Œæ— æ³•æ‰“ç‚¹", "error"); return; }
                     updatePlayer(prev => ({...prev, money: prev.money - 50}));
                     addLog("èŠ±è´¹50ä¸¤ï¼Œé¬¼å¸‚ç„•ç„¶ä¸€æ–°", "success");
                 }
                 const newItems = generateShopItems(pid);
                 const nextTime = Date.now() + (2 * 60 * 60 * 1000); 
                 setShopState({ items: newItems, nextRefresh: nextTime });
             };
             
             const openShop = () => {
                 if (Date.now() > shopState.nextRefresh || shopState.items.length === 0) { refreshShop(player.id); }
                 setShowShop(true);
             };
             
             const forcedSummon = (partnerId, duration) => {
                  const partnerList = PARTNERS_DB[player.id];
                  const partner = partnerList.find(p => p.id === partnerId);
                  if (!partner) return;
                  setCurrentPartner(partner); setPartnerActive(true);
                  setTimeout(() => { setPartnerActive(false); setCurrentPartner(null); }, duration);
             };

             const handleGainExp = (amount) => {
                updatePlayer(prev => {
                    let { exp, maxExp, level, name, skills, partnerUnlocked, id } = prev; exp += amount; let leveledUp = false; let newSkill = null;
                    while (exp >= maxExp) { exp -= maxExp; level += 1; maxExp = Math.floor(maxExp * 1.3); leveledUp = true; const skillTree = SKILLS_DB[id]; if (skillTree && skillTree[level]) { const skill = skillTree[level]; skills = [...skills, skill]; newSkill = skill; } if (level >= PARTNER_UNLOCK_LEVEL && !partnerUnlocked) { partnerUnlocked = true; } }
                    let nextState = { ...prev, exp, maxExp, level, skills, partnerUnlocked }; if (level >= 3) nextState.partnerUnlocked = true;
                    if (leveledUp) { 
                        const s = getPlayerStats(nextState);
                        nextState.currentHp = s.maxHp; 
                        addLog(`å¿ƒæ™ºç²¾è¿›ï¼${name} å‡è‡³ Lv.${level}`, 'loot'); addFloatingText('LEVEL UP!', 'crit', 'player'); if (newSkill) { addLog(`é¢†æ‚Ÿæ–°è®¡: [${newSkill.name}]`, 'success'); } 
                    }
                    return nextState;
                });
             };

             const unlockPartner = (partnerId) => {
                  if (!unlockedPartners.includes(partnerId)) {
                      const partnerList = PARTNERS_DB[player.id];
                      if (!partnerList) return;
                      const partner = partnerList.find(p => p.id === partnerId);
                      if (partner) { setUnlockedPartners(prev => [...prev, partnerId]); addLog(`ç»“è¯†è±ªæ°: [${partner.name}]`, 'success'); updatePlayer(p => ({...p, partnerUnlocked: true})); }
                  }
             };
             
             const removePartner = (partnerId) => {
                  setUnlockedPartners(prev => prev.filter(id => id !== partnerId));
                  if (currentPartner?.id === partnerId) { setPartnerActive(false); setCurrentPartner(null); }
                  const partnerList = PARTNERS_DB[player.id];
                  const partner = partnerList?.find(p => p.id === partnerId);
                  if (partner) addLog(`[${partner.name}] ç¦»å¼€äº†é˜Ÿä¼`, 'info');
             };

             const handleVictory = (defeatedEnemy) => {
                const { gameState, processingVictory, stage } = stateRef.current;
                if (gameState === 'VICTORY' || processingVictory) return;
                stateRef.current.processingVictory = true; stateRef.current.gameState = 'VICTORY'; setGameState('VICTORY');
                addChat('Player', randomItem(DIALOGUES.player.win)); addLog(`${defeatedEnemy.name} å·²è¢«æ¸…é™¤`, 'success');
                triggerEmote('player', 'win'); 
                
                const partnerList = PARTNERS_DB[player.id];
                if (partnerList) { partnerList.forEach(p => { if (Math.ceil(stage / 4) === p.unlockLevel && stage % 4 === 0) unlockPartner(p.id); }); }
                
                if (defeatedEnemy.isBoss) {
                     if (stage >= stateRef.current.maxUnlockedStage) {
                         setMaxUnlockedStage(s => s + 1); 
                         addLog('æ–°åŒºåŸŸå·²åœ¨èˆ†å›¾ä¸Šè§£é”', 'system');
                     }
                } else if (stage >= stateRef.current.maxUnlockedStage) {
                     setMaxUnlockedStage(s => s + 1);
                }

                const xpGain = 40 + (stage * 5) + (defeatedEnemy.isBoss ? 150 : 0); 
                const moneyGain = randomInt(20, 40) + (defeatedEnemy.isBoss ? 100 : 0);
                handleGainExp(xpGain); 
                updatePlayer(prev => ({...prev, money: prev.money + moneyGain})); 
                addLog(`è·å¾— ${xpGain} é˜…å†, ${moneyGain} é“¶ä¸¤`, 'info');
                
                if (Math.random() < 0.25) {
                  const pool = EQUIPMENT_POOLS[player.id] || EQUIPMENT_POOLS['xie_huaian'];
                  const newItem = randomItem(pool);
                  let canAdd = true; if (newItem.type !== 'consumable') { if (player.bag.some(i => i.name === newItem.name)) canAdd = false; }
                  if (canAdd) { addLog(`ç¼´è·: [${newItem.name}]`, 'loot'); updatePlayer(prev => ({ ...prev, bag: [...prev.bag, newItem] })); } else { const sellPrice = Math.floor(newItem.price / 2); addLog(`å‘ç° [${newItem.name}] (æŠ˜ç®— ${sellPrice} ä¸¤)`, 'info'); updatePlayer(prev => ({...prev, money: prev.money + sellPrice})); }
                }
             };

             const handleDefeat = () => { if (gameState === 'RESTING') return; setGameState('RESTING'); setRestTime(REST_DURATION); addLog('å¸ƒå±€è¢«ç ´ï¼Œæš‚é¿é”‹èŠ’...', 'error'); triggerEmote('player', 'lose'); };

             const spawnEnemy = (currentStage) => {
                if (currentStage > 40) { setGameState('GAME_COMPLETED'); return; } 
                
                const chapterNum = Math.ceil(currentStage / 4);
                const isBossLevel = currentStage % 4 === 0;
                const storyConfig = STORY_CONFIGS[player.id] || STORY_CONFIGS['xie_huaian'];
                const chapterConfig = storyConfig[chapterNum] || storyConfig[1]; 
                
                let enemyData = {};

                if (isBossLevel) {
                    if (chapterNum === 10 && unlockedPartners.includes('pu_nichuan')) {
                        setTimeout(() => { forcedSummon('pu_nichuan', 10000); addLog("è’²é€†å·ï¼šæ‹¿å‘½æ¥ï¼", 'loot'); setTimeout(() => { removePartner('pu_nichuan'); addLog("è’²é€†å· åŠ›ç«­ç‰ºç‰²...", 'error'); }, 10000); }, 500);
                    }
                    if (chapterNum === 9 && unlockedPartners.includes('bai_wan')) {
                         setTimeout(() => { forcedSummon('bai_wan', 60000); addLog("ç™½çš–ï¼šæˆ‘æ¥åŠ©ä½ ä¸€è‡‚ä¹‹åŠ›ã€‚", 'loot'); }, 500);
                    }

                    const hp = Math.floor(100 * chapterConfig.hpScale);
                    const atk = Math.floor(8 * chapterConfig.atkScale);
                    enemyData = {
                         name: chapterConfig.enemyName,
                         maxHp: hp,
                         currentHp: hp,
                         atk: atk,
                         level: currentStage,
                         isBoss: true, 
                         visual: chapterConfig.enemyName,
                         baseName: chapterConfig.enemyName 
                    };
                    addLog(`--- ${chapterConfig.title} (ç»ˆ) ---`, 'system');
                } else {
                    const minionNames = MINION_DB[player.id] || MINION_DB['xie_huaian'];
                    const name = randomItem(minionNames);
                    const minionHpScale = chapterConfig.hpScale * 0.4;
                    const minionAtkScale = chapterConfig.atkScale * 0.6;

                    const hp = Math.floor(100 * minionHpScale);
                    const atk = Math.floor(8 * minionAtkScale);

                    enemyData = {
                        name: `${name} (å…³å¡ ${currentStage%4 === 0 ? 4 : currentStage%4}/4)`,
                        maxHp: hp,
                        currentHp: hp,
                        atk: atk,
                        level: currentStage,
                        isBoss: false,
                        visual: 'enemy',
                        baseName: name 
                    };
                     addLog(`--- ${chapterConfig.title} (é€”) ---`, 'system');
                }

                updateEnemy(enemyData);
                setResurrected(false);
                stateRef.current.processingVictory = false; 
                
                // Trigger intro chat from Custom Config
                const currentConfig = stateRef.current.config;
                if (isBossLevel) {
                     const introTexts = currentConfig.dialogues[chapterConfig.enemyName] || currentConfig.dialogues['default'];
                     addChat('Enemy', randomItem(introTexts));
                } else {
                     addChat('Enemy', "ç«™ä½ï¼æ­¤è·¯ä¸é€šï¼");
                }
                
                setGameState('BATTLE');
             };

             const nextStage = () => { if (stage >= 40) { setGameState('GAME_COMPLETED'); return; } setStage(s => s + 1); const nextS = stage + 1; spawnEnemy(nextS); };
             const selectStage = (chapterNum) => { 
                 setShowMap(false); 
                 const startStage = (chapterNum - 1) * 4 + 1;
                 setStage(startStage); 
                 spawnEnemy(startStage); 
             };
             
             const manualAttack = () => { if (gameState === 'BATTLE' && !showShop && !showPartnerSelect && !showStats && !showMap && !isAutoBattle) { handleAttackRound(); } };
             const openPartnerSelect = () => { if (!player.partnerUnlocked) return; if (partnerCooldownTimer > 0) { addLog(`ä¼™ä¼´ä¼‘æ•´ä¸­...`, 'error'); return; } setShowPartnerSelect(true); };
             const finishRest = () => { updatePlayer(p => ({...p, currentHp: stats.maxHp})); addLog('ä¼‘æ•´å®Œæ¯•ï¼Œé‡å›æ£‹å±€ï¼', 'system'); spawnEnemy(stage); };
             const instantRevive = () => { updatePlayer(p => ({...p, currentHp: stats.maxHp})); setRestTime(0); };
             
             // ----------------- å¤©æœºé˜ (Admin) é€»è¾‘ -----------------
             const saveConfig = () => {
                 localStorage.setItem(CONFIG_SAVE_KEY, JSON.stringify(customConfig));
                 stateRef.current.config = customConfig; 
                 
                 if (db && auth && auth.currentUser) {
                      const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'config', 'global');
                      setDoc(docRef, customConfig)
                        .then(() => addLog("å·²åŒæ­¥è‡³äº‘ç«¯", "success"))
                        .catch(err => addLog("äº‘ç«¯åŒæ­¥å¤±è´¥: " + err.message, "error"));
                 } else {
                      addLog("å·²ä¿å­˜è‡³æœ¬åœ°", "warning");
                 }
             };

             const handleAddDialogue = () => {
                 if (!newItemInput.trim() || !editingKey) return;
                 const newDialogues = { ...customConfig.dialogues };
                 if (!newDialogues[editingKey]) newDialogues[editingKey] = [];
                 newDialogues[editingKey].push(newItemInput.trim());
                 setCustomConfig({ ...customConfig, dialogues: newDialogues });
                 setNewItemInput('');
             };

             const handleDeleteDialogue = (key, index) => {
                 const newDialogues = { ...customConfig.dialogues };
                 newDialogues[key].splice(index, 1);
                 setCustomConfig({ ...customConfig, dialogues: newDialogues });
             };

             const handleAddEmote = () => {
                 if (!newEmoteInput.trim()) return;
                 const newEmotes = { ...customConfig.emotes };
                 let targetArray;

                 if (emoteCategory === 'defaults') {
                     if (!newEmotes.defaults[emoteType]) newEmotes.defaults[emoteType] = [];
                     targetArray = newEmotes.defaults[emoteType];
                 } else {
                     if (!emoteKey) return;
                     if (!newEmotes[emoteCategory][emoteKey]) newEmotes[emoteCategory][emoteKey] = {};
                     if (!newEmotes[emoteCategory][emoteKey][emoteType]) newEmotes[emoteCategory][emoteKey][emoteType] = [];
                     targetArray = newEmotes[emoteCategory][emoteKey][emoteType];
                 }

                 targetArray.push(newEmoteInput.trim());
                 setCustomConfig({ ...customConfig, emotes: newEmotes });
                 setNewEmoteInput('');
             };

             const handleDeleteEmote = (idx) => {
                 const newEmotes = { ...customConfig.emotes };
                 let targetArray;

                 if (emoteCategory === 'defaults') {
                     targetArray = newEmotes.defaults[emoteType];
                 } else {
                     targetArray = newEmotes[emoteCategory][emoteKey][emoteType];
                 }

                 targetArray.splice(idx, 1);
                 setCustomConfig({ ...customConfig, emotes: newEmotes });
             };
             
             const getCurrentEmoteList = () => {
                 if (emoteCategory === 'defaults') {
                     return customConfig.emotes.defaults[emoteType] || [];
                 }
                 if (emoteKey && customConfig.emotes[emoteCategory][emoteKey]) {
                     return customConfig.emotes[emoteCategory][emoteKey][emoteType] || [];
                 }
                 return [];
             };

             const summonSelectedPartner = (partner) => { setShowPartnerSelect(false); setCurrentPartner(partner); if (gameState !== 'BATTLE') return; let damage = stats.atk * 4; setPartnerActive(true); updatePlayer(prev => ({ ...prev, lastPartnerUseTime: Date.now() })); setPartnerCooldownTimer(partner.cooldown); addLog(`${partner.name} åŠ©æˆ˜ï¼å‘åŠ¨ [${partner.skillName}]`, 'loot'); addFloatingText(`${partner.skillName}!`, 'crit', 'player'); updateEnemy(prev => { const newHp = Math.max(0, prev.currentHp - damage); setTimeout(() => addFloatingText(`-${damage}`, 'crit', 'enemy'), 300); return { ...prev, currentHp: newHp }; }); setTimeout(() => { setPartnerActive(false); setCurrentPartner(null); addLog(`${partner.name}ï¼šæš‚ä¸”é€€ä¸‹ã€‚`, 'info'); }, partner.duration); };
             
             const handleUseItem = (item, index) => {
                  if (player.currentHp >= stats.maxHp && !item.cure) { addLog("æ°”è¡€å·²æ»¡ï¼Œæ— éœ€ä½¿ç”¨", "info"); return; }
                  updatePlayer(prev => { const newBag = [...prev.bag]; newBag.splice(index, 1); let recovered = 0; let newHp = prev.currentHp; if (item.heal) { newHp = Math.min(stats.maxHp, prev.currentHp + item.heal); recovered = newHp - prev.currentHp; } addLog(`ä½¿ç”¨äº† [${item.name}]ï¼Œæ¢å¤ ${recovered} ç‚¹æ°”è¡€`, 'success'); if (item.cure) { addLog(`[${item.name}] å‘æŒ¥è¯æ•ˆï¼Œæ¯’ç´ å·²è§£`, 'success'); } return { ...prev, currentHp: newHp, bag: newBag }; });
             };
             
             const handleEquip = (item, index) => {
                  if (item.type === 'consumable') { handleUseItem(item, index); return; }
                  updatePlayer(prev => { const newSlots = { ...prev.slots }; if (item.type === 'weapon') newSlots.weapon = item; if (item.type === 'clothes') newSlots.clothes = item; if (item.type === 'guard') newSlots.guard = item; addLog(`è£…å¤‡äº† [${item.name}]`, 'info'); return { ...prev, slots: newSlots }; });
             };
             
             const handleUnequip = (type) => { updatePlayer(prev => { const newSlots = { ...prev.slots }; const item = newSlots[type]; if (item) { addLog(`å¸ä¸‹äº† [${item.name}]`, 'info'); newSlots[type] = null; } return { ...prev, slots: newSlots }; }); };
             
             const handleSell = (e, item, index) => { e.stopPropagation(); const sellPrice = Math.floor(item.price / 2); updatePlayer(prev => { const newSlots = { ...prev.slots }; if (newSlots.weapon === item) newSlots.weapon = null; if (newSlots.clothes === item) newSlots.clothes = null; if (newSlots.guard === item) newSlots.guard = null; const newBag = [...prev.bag]; newBag.splice(index, 1); return { ...prev, money: prev.money + sellPrice, bag: newBag, slots: newSlots }; }); addLog(`å”®å‡º [${item.name}]ï¼Œè·å¾— ${sellPrice} é“¶ä¸¤`, 'info'); };
             
             const handleBuy = (item) => { if (player.money >= item.price) { if (item.type !== 'consumable' && player.bag.some(i => i.name === item.name)) { addLog("å·²æ‹¥æœ‰æ­¤ç‰©å“", "error"); return; } updatePlayer(prev => ({ ...prev, money: prev.money - item.price, bag: [...prev.bag, item] })); setShopState(prev => ({ ...prev, items: prev.items.filter(i => i.id !== item.id) })); addLog(`è´­å¾— [${item.name}]`, 'success'); } else { addLog("é“¶ä¸¤ä¸è¶³", "error"); } };

             const handleAttackRound = () => {
                const { player, enemy, gameState, partnerActive, currentPartner, processingVictory } = stateRef.current;
                const currentConfig = stateRef.current.config;

                if (processingVictory || gameState !== 'BATTLE') return;
                if (enemy.currentHp <= 0) { handleVictory(enemy); return; }
                if (player.currentHp <= 0) { handleDefeat(); return; }

                if (Math.random() < 0.25) {
                    const enemyLines = currentConfig.dialogues[enemy.baseName] || currentConfig.dialogues['default'];
                    const speaker = Math.random() > 0.5 ? 'Player' : 'Enemy';
                    const text = speaker === 'Player' ? randomItem(DIALOGUES.player.attack) : randomItem(enemyLines);
                    addChat(speaker, text);
                    if(speaker === 'Player') triggerEmote('player', 'attack'); 
                }

                triggerAnimation(playerRef, 'animate-lunge-right');
                
                // const currentStats = getPlayerStats(player); // Use stats from outer scope

                if (partnerActive && currentPartner) {
                    triggerAnimation(partnerRef, 'animate-lunge-right');
                    setTimeout(() => {
                        const partnerDmg = Math.ceil(stats.atk * 0.8);
                        updateEnemy(prev => {
                            const newHp = Math.max(0, prev.currentHp - partnerDmg);
                            addFloatingText(`-${partnerDmg}`, 'loot', 'enemy');
                            return { ...prev, currentHp: newHp };
                        });
                    }, 100); 
                }
                setTimeout(() => triggerAnimation(enemyRef, 'animate-lunge-left'), 200);

                setTimeout(() => {
                  const { enemy: currEnemy, player: currPlayer } = stateRef.current;
                  if (currEnemy.currentHp <= 0) { handleVictory(currEnemy); return; }
                  let damage = stats.atk; 
                  let hitCount = 1;
                  const hasSkill = (skills, type) => skills.some(s => s.type === type);
                  if (hasSkill(currPlayer.skills, 'passive_double') && Math.random() < 0.4) { hitCount = 2; addFloatingText('è¿ç¯è®¡!', 'loot', 'player'); }
                  if (hasSkill(currPlayer.skills, 'passive_debuff')) { updateEnemy(prev => ({...prev, atk: Math.max(1, prev.atk - 2)})); if(Math.random()<0.2) addFloatingText('æ”»å¿ƒ', 'info', 'player'); }
                  
                  let totalDamage = 0;
                  for (let i = 0; i < hitCount; i++) {
                      let currentHitDmg = damage;
                      let isCrit = Math.random() * 100 < stats.crit;
                      if (isCrit) {
                          currentHitDmg = Math.floor(currentHitDmg * 1.8); 
                          triggerEmote('player', 'crit');
                      }
                      currentHitDmg = Math.floor(currentHitDmg * (randomInt(90, 110) / 100));
                      if (hasSkill(currPlayer.skills, 'passive_execute') && (currEnemy.currentHp / currEnemy.maxHp < 0.4)) { currentHitDmg = 9999; addFloatingText('æ–©æ€!', 'crit', 'player'); triggerEmote('player', 'skill'); }
                      totalDamage += currentHitDmg;
                      
                      updateEnemy(prev => {
                          const newHp = prev.currentHp - currentHitDmg;
                          setTimeout(() => { addFloatingText(`-${currentHitDmg}${isCrit ? '!' : ''}`, isCrit ? 'crit' : 'damage', 'enemy'); }, i * 200);
                          return { ...prev, currentHp: newHp }; 
                      });
                  }
                  addLog(`é€ æˆ ${totalDamage} ä¼¤å®³${hitCount > 1 ? '(è¿ç¯)' : ''}`);
                  triggerAnimation(enemyRef, 'animate-shake');
                  triggerEmote('enemy', 'hit'); 
                }, 300);

                setTimeout(() => {
                  const { enemy: currEnemy, player: currPlayer } = stateRef.current;
                  if (currEnemy.currentHp <= 0) { handleVictory(currEnemy); return; }
                  if (currPlayer.currentHp <= 0) { handleDefeat(); return; }

                  updateEnemy(latestEnemy => {
                      let damage = latestEnemy.atk;
                      damage = Math.floor(damage * (randomInt(90, 110) / 100));
                      const hasSkill = (skills, type) => skills.some(s => s.type === type);

                      if (hasSkill(player.skills, 'passive_dodge') && Math.random() < 0.15) { addFloatingText('é—ªé¿!', 'info', 'player'); damage = 0; triggerEmote('player', 'dodge'); }
                      if (damage > 0) {
                          if (hasSkill(player.skills, 'passive_reflect')) {
                              const reflectDmg = Math.floor(damage * 0.3);
                              setTimeout(() => { updateEnemy(prev => { const newHp = Math.max(0, prev.currentHp - reflectDmg); if (reflectDmg > 0) addFloatingText(`åä¼¤-${reflectDmg}`, 'loot', 'enemy'); return {...prev, currentHp: newHp}; }); }, 50);
                          }
                          updatePlayer(prev => {
                            let newHp = prev.currentHp - damage;
                            addFloatingText(`-${damage}`, 'damage', 'player');
                            triggerEmote('player', 'hit'); 
                            if (newHp <= 0 && hasSkill(prev.skills, 'passive_resurrect') && !resurrected) {
                                const maxHp = getPlayerStats(prev).maxHp; newHp = Math.floor(maxHp * 0.3); setResurrected(true); addFloatingText('é‡‘è‰è„±å£³!', 'crit', 'player'); addLog('æ­»å±€æ±‚ç”Ÿï¼Œè§¦å‘é‡‘è‰è„±å£³ï¼', 'success'); triggerEmote('player', 'skill');
                            }
                            return { ...prev, currentHp: newHp };
                          });
                          triggerAnimation(playerRef, 'animate-shake');
                      }
                      return latestEnemy;
                  });
                }, 800);
             };

             const triggerAnimation = (ref, className) => { if (ref.current) { ref.current.classList.remove(className); void ref.current.offsetWidth; ref.current.classList.add(className); setTimeout(() => { if(ref.current) ref.current.classList.remove(className); }, 500); } };
             
             // 5. Restore Missing Functions (rollCharacter & resetGame)
             const rollCharacter = () => {
                const charData = randomItem(CHARACTERS_DATA); 
                const skillDB = SKILLS_DB[charData.id]; 
                const initialSkills = [skillDB[1]]; 
                updatePlayer({ id: charData.id, name: charData.name, baseHp: charData.baseHp, currentHp: charData.baseHp, baseAtk: charData.baseAtk, baseCrit: charData.baseCrit, level: 1, exp: 0, maxExp: 100, money: 100, bag: [], slots: { weapon: null, clothes: null, guard: null }, skills: initialSkills, visual: charData.visual, partnerUnlocked: false, lastPartnerUseTime: 0 });
                setStage(1); setMaxUnlockedStage(1); setLogs([]); setChats([]); setResurrected(false); setPartnerCooldownTimer(0); setIsAutoBattle(true); setUnlockedPartners([]); 
                refreshShop(charData.id);
                setGameState('MENU'); addLog(`å¤©å‘½æ‰€å½’ã€‚ä½ æ˜¯ [${charData.name}]`, 'system'); addLog(`åˆå§‹ç»å­¦: [${skillDB[1].name}]`, 'loot');
             };

             const resetGame = () => {
                 localStorage.removeItem(SAVE_KEY);
                 localStorage.removeItem(CONFIG_SAVE_KEY);
                 setGameState('LOGIN');
             };


             // --- Effects ---
             useEffect(() => {
                const savedData = loadSavedData();
                if (savedData) {
                    setPlayer(savedData.player);
                    setEnemy(savedData.enemy);
                    setStage(savedData.stage);
                    // å…¼å®¹æ—§å­˜æ¡£é€»è¾‘
                    setMaxUnlockedStage(savedData.maxUnlockedStage || 1);
                    setUnlockedPartners(savedData.unlockedPartners);
                    setShopState(savedData.shop || { items: [], nextRefresh: 0 });
                    if (savedData.gameState === 'BATTLE' || savedData.gameState === 'MENU' || savedData.gameState === 'RESTING') {
                        setGameState(savedData.gameState);
                        addLog('æ¬¢è¿å›æ¥ï¼Œä¾ å£«ã€‚', 'system');
                    } else if (savedData.gameState === 'GAME_COMPLETED') {
                         setGameState('GAME_COMPLETED');
                    }
                }
             }, []);

             useEffect(() => {
                if (gameState !== 'LOGIN' && gameState !== 'GACHA') {
                    const dataToSave = { player, enemy, stage, maxUnlockedStage, unlockedPartners, gameState, shop: shopState };
                    localStorage.setItem(SAVE_KEY, JSON.stringify(dataToSave));
                }
             }, [player, enemy, stage, maxUnlockedStage, unlockedPartners, gameState, shopState]);

             useEffect(() => {
                stateRef.current = { 
                    player, enemy, gameState, showShop, showPartnerSelect, showStats, showMap, activeMobileTab,
                    isAutoBattle, partnerActive, currentPartner, stage, unlockedPartners, 
                    maxUnlockedStage, processingVictory: stateRef.current.processingVictory,
                    shop: shopState,
                    config: customConfig 
                };
             }, [player, enemy, gameState, showShop, showPartnerSelect, showStats, showMap, activeMobileTab, isAutoBattle, partnerActive, currentPartner, stage, unlockedPartners, maxUnlockedStage, shopState, customConfig]);
             
             useEffect(() => { logsEndRef.current?.scrollIntoView({ behavior: "smooth" }); }, [logs]);
             useEffect(() => { chatsEndRef.current?.scrollIntoView({ behavior: "smooth" }); }, [chats]);
             
             useEffect(() => {
                if (auth) {
                    const unsubscribeAuth = onAuthStateChanged(auth, (user) => {
                        setCurrentUser(user);
                        if (user) {
                            const configDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'config', 'global');
                            const unsubscribeSnapshot = onSnapshot(configDocRef, (docSnap) => {
                                if (docSnap.exists()) {
                                    const data = docSnap.data();
                                    setCustomConfig(data);
                                    stateRef.current.config = data;
                                    addLog("å·²åŒæ­¥äº‘ç«¯å¤©æœºé˜é…ç½®", "success");
                                }
                            }, (error) => {
                                console.error("Snapshot error:", error);
                            });
                            return () => unsubscribeSnapshot();
                        }
                    });
                    return () => unsubscribeAuth();
                }
             }, []);

             useEffect(() => {
                if (player.lastPartnerUseTime > 0) {
                  const interval = setInterval(() => {
                      const now = Date.now();
                      const diff = (now - player.lastPartnerUseTime) / 1000;
                      const remaining = Math.max(0, (currentPartner?.cooldown || PARTNER_COOLDOWN_BASE) - diff); 
                      setPartnerCooldownTimer(remaining);
                  }, 1000);
                  return () => clearInterval(interval);
                }
             }, [player.lastPartnerUseTime, currentPartner]);

             useEffect(() => {
                if (gameState === 'VICTORY' && !showShop && !showPartnerSelect && !showStats && !showMap && isAutoBattle) {
                  const timer = setTimeout(() => {
                      if (stateRef.current.gameState === 'VICTORY') {
                          nextStage();
                          stateRef.current.processingVictory = false; 
                      }
                  }, 2000); 
                  return () => clearTimeout(timer);
                }
             }, [gameState, showShop, showPartnerSelect, showStats, showMap, isAutoBattle]);

             useEffect(() => {
                 const interval = setInterval(() => {
                     if (showShop && shopState.nextRefresh > 0) {
                         if (Date.now() > shopState.nextRefresh) refreshShop(player.id);
                         setShopState(prev => ({...prev}));
                     }
                 }, 1000);
                 return () => clearInterval(interval);
             }, [showShop, shopState.nextRefresh, player.id]);

             // æ›´æ–° battleLoopRef
             useEffect(() => { battleLoopRef.current = handleAttackRound; });

             // æ ¸å¿ƒæˆ˜æ–—å®šæ—¶å™¨
             useEffect(() => { 
                const battleInterval = setInterval(() => { 
                    const { gameState, showShop, showPartnerSelect, showStats, showMap, isAutoBattle } = stateRef.current; 
                    if (gameState === 'BATTLE' && !showShop && !showPartnerSelect && !showStats && !showMap && isAutoBattle) { 
                        if (battleLoopRef.current) battleLoopRef.current(); 
                    } 
                }, 1500); 
                return () => clearInterval(battleInterval); 
             }, []); 

             useEffect(() => { const restInterval = setInterval(() => { const { gameState, player } = stateRef.current; if (gameState !== 'RESTING') return; setRestTime(prev => { if (prev <= 0) return 0; const stats = getPlayerStats(player); updatePlayer(p => ({ ...p, currentHp: Math.min(stats.maxHp, p.currentHp + (stats.maxHp / REST_DURATION)) })); return prev - 1; }); }, 1000); return () => clearInterval(restInterval); }, []);
             useEffect(() => { if (gameState === 'RESTING' && restTime === 0) { finishRest(); } }, [restTime, gameState]);


             // --- JSX ---
             if (gameState === 'LOGIN') {
                 return (
                    <div className="w-full h-screen bg-[#3e2323] flex items-center justify-center">
                        <div className="bg-[#f4f0e6] p-10 rounded-sm border-8 border-[#2a231d] shadow-2xl text-center max-w-md w-full relative z-10">
                            <h1 className="text-4xl font-black mb-4 text-[#8b2e2e] tracking-widest font-serif">çº¸ä¸Šæ±Ÿæ¹–</h1>
                            <p className="text-[#57534e] mb-8 text-sm italic">æ­¤æ¸¸æˆä¸º <span className="font-bold text-[#b91c1c]">æ·‡æ·‡</span> æ‰€æœ‰ï¼Œä¸“ä¸º <span className="font-bold text-[#b91c1c]">æœæœ</span> è‡ªå—¨</p>
                            <input type="text" value={inputCode} onChange={(e) => setInputCode(e.target.value)} placeholder="è¯·è¾“å…¥é‚€è¯·ç " className="w-full p-3 border-2 border-[#a89f91] rounded bg-white text-center mb-4 focus:outline-none focus:border-[#d4af37] text-black" />
                            {loginError && <div className="text-red-500 text-xs mb-4">{loginError}</div>}
                            <button onClick={handleLogin} className="w-full bg-[#d4af37] text-[#3e2323] py-3 rounded font-bold hover:bg-[#b45309] transition-all flex items-center justify-center gap-2"><KeyRound size={20} /> å¼€å¯ç”»å·</button>
                        </div>
                    </div>
                 );
             }
             
             // --- ADMIN PANEL ---
             if (gameState === 'ADMIN') {
                 return (
                     <div className="w-full h-screen bg-[#f4f0e6] text-[#4a3b32] font-serif p-6 overflow-y-auto">
                        <div className="max-w-4xl mx-auto bg-white p-6 rounded shadow-lg border border-[#a89f91]">
                            <div className="flex justify-between items-center mb-6 border-b pb-4">
                                <h2 className="text-2xl font-bold flex items-center gap-2"><Settings className="text-[#b91c1c]"/> å¤©æœºé˜ - æ•°æ®é…ç½®</h2>
                                <div className="flex gap-2">
                                     <div className="flex items-center gap-2 text-xs text-gray-500 mr-4">
                                         <Cloud size={14} className={currentUser ? "text-green-600" : "text-gray-400"} />
                                         <span className={currentUser ? "text-green-600 font-bold" : "text-gray-400"}>{currentUser ? 'äº‘ç«¯å·²è¿æ¥' : 'ç¦»çº¿æ¨¡å¼'}</span>
                                     </div>
                                     <button onClick={() => {saveConfig(); setGameState('LOGIN');}} className="bg-[#15803d] text-white px-4 py-2 rounded flex items-center gap-2 hover:bg-[#166534]"><Save size={18}/> ä¿å­˜å¹¶è¿”å›</button>
                                </div>
                            </div>
                            
                            {/* Manual Cloud Connection for Offline Mode */}
                            {!currentUser && (
                                <div className="mb-6 p-4 bg-yellow-50 border border-yellow-200 rounded text-sm">
                                    <h3 className="font-bold text-yellow-800 mb-2 flex items-center gap-2"><Link size={16}/> æ‰‹åŠ¨è¿æ¥ç§æœ‰äº‘</h3>
                                    <p className="mb-2 text-yellow-700">æ£€æµ‹åˆ°å½“å‰ç¯å¢ƒæœªæ³¨å…¥ Firebase é…ç½®ã€‚å¦‚éœ€å¤šç«¯åŒæ­¥ï¼Œè¯·ç²˜è´´æ‚¨çš„ Firebase é…ç½® JSONï¼š</p>
                                    <textarea 
                                        className="w-full h-24 p-2 border rounded text-xs font-mono mb-2" 
                                        placeholder='{"apiKey": "...", "authDomain": "...", "projectId": "..."}'
                                        value={firebaseConfigInput}
                                        onChange={(e) => setFirebaseConfigInput(e.target.value)}
                                    />
                                    <button onClick={handleConnectCloud} className="bg-yellow-600 text-white px-3 py-1 rounded text-xs hover:bg-yellow-700">è¿æ¥äº‘ç«¯</button>
                                </div>
                            )}

                            <div className="flex gap-4 mb-6">
                                <button onClick={() => setAdminTab('DIALOGUES')} className={`px-4 py-2 rounded font-bold ${adminTab==='DIALOGUES' ? 'bg-[#b91c1c] text-white' : 'bg-gray-200'}`}>å¯¹è¯é…ç½®</button>
                                <button onClick={() => setAdminTab('EMOTES')} className={`px-4 py-2 rounded font-bold ${adminTab==='EMOTES' ? 'bg-[#b91c1c] text-white' : 'bg-gray-200'}`}>è¡¨æƒ…é…ç½®</button>
                            </div>

                            {adminTab === 'DIALOGUES' && (
                                <div className="space-y-6">
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <div className="md:col-span-1 border-r pr-4 max-h-[60vh] overflow-y-auto">
                                            <h3 className="font-bold mb-2">é€‰æ‹©è§’è‰²/æ•Œäºº</h3>
                                            {Object.keys(customConfig.dialogues).map(key => (
                                                <div key={key} onClick={() => setEditingKey(key)} className={`p-2 cursor-pointer hover:bg-gray-100 rounded ${editingKey === key ? 'bg-[#fef3c7] font-bold text-[#b45309]' : ''}`}>
                                                    {key}
                                                </div>
                                            ))}
                                            <div className="mt-4 pt-4 border-t">
                                                <input placeholder="æ–°è§’è‰²å..." className="border p-1 w-full mb-1" id="newDialogueKey" />
                                                <button onClick={() => {
                                                    const key = document.getElementById('newDialogueKey').value;
                                                    if(key && !customConfig.dialogues[key]) {
                                                        setCustomConfig({...customConfig, dialogues: {...customConfig.dialogues, [key]: []}});
                                                        setEditingKey(key);
                                                        document.getElementById('newDialogueKey').value = '';
                                                    }
                                                }} className="w-full bg-[#57534e] text-white p-1 rounded text-xs flex items-center justify-center gap-1"><Plus size={12}/> æ–°å¢è§’è‰²</button>
                                            </div>
                                        </div>
                                        <div className="md:col-span-2">
                                            {editingKey ? (
                                                <>
                                                    <h3 className="font-bold mb-4 text-lg">æ­£åœ¨ç¼–è¾‘: <span className="text-[#b91c1c]">{editingKey}</span></h3>
                                                    <ul className="space-y-2 mb-4">
                                                        {customConfig.dialogues[editingKey].map((text, idx) => (
                                                            <li key={idx} className="flex justify-between items-center bg-gray-50 p-2 rounded border">
                                                                <span className="text-sm">{text}</span>
                                                                <button onClick={() => handleDeleteDialogue(editingKey, idx)} className="text-red-500 hover:bg-red-50 p-1 rounded"><Trash2 size={16}/></button>
                                                            </li>
                                                        ))}
                                                    </ul>
                                                    <div className="flex gap-2">
                                                        <input 
                                                            value={newItemInput}
                                                            onChange={(e) => setNewItemInput(e.target.value)}
                                                            className="flex-1 border p-2 rounded" 
                                                            placeholder="è¾“å…¥æ–°å°è¯..." 
                                                            onKeyPress={(e) => e.key === 'Enter' && handleAddDialogue()}
                                                        />
                                                        <button onClick={handleAddDialogue} className="bg-[#d4af37] text-white px-4 py-2 rounded font-bold">æ·»åŠ </button>
                                                    </div>
                                                </>
                                            ) : <div className="text-gray-400 text-center mt-20">è¯·åœ¨å·¦ä¾§é€‰æ‹©è¦ç¼–è¾‘çš„å¯¹è±¡</div>}
                                        </div>
                                    </div>
                                </div>
                            )}

                            {adminTab === 'EMOTES' && (
                                <div className="space-y-6">
                                     <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                         {/* Col 1: Category */}
                                         <div className="md:col-span-1 border-r pr-4">
                                             <h3 className="font-bold mb-2">1. é€‰æ‹©åˆ†ç±»</h3>
                                             {['defaults', 'players', 'enemies'].map(cat => (
                                                 <div key={cat} onClick={() => { setEmoteCategory(cat); setEmoteKey(null); }} className={`p-2 cursor-pointer hover:bg-gray-100 rounded ${emoteCategory === cat ? 'bg-[#fef3c7] font-bold text-[#b45309]' : ''}`}>
                                                     {cat === 'defaults' ? 'é»˜è®¤é€šç”¨' : cat === 'players' ? 'ä¸»è§’ä¸“å±' : 'æ•Œäººä¸“å±'}
                                                 </div>
                                             ))}
                                         </div>

                                         {/* Col 2: Key or Type */}
                                         <div className="md:col-span-1 border-r pr-4 max-h-[60vh] overflow-y-auto">
                                             {emoteCategory === 'defaults' ? (
                                                 <div>
                                                     <h3 className="font-bold mb-2">2. é€‰æ‹©åŠ¨ä½œç±»å‹</h3>
                                                     {['attack', 'hit', 'dodge', 'crit', 'skill', 'win', 'lose'].map(type => (
                                                         <div key={type} onClick={() => setEmoteType(type)} className={`p-2 cursor-pointer hover:bg-gray-100 rounded ${emoteType === type ? 'bg-[#dcfce7] font-bold text-[#15803d]' : ''}`}>
                                                             {type}
                                                         </div>
                                                     ))}
                                                 </div>
                                             ) : (
                                                 <div>
                                                     <h3 className="font-bold mb-2">2. é€‰æ‹©è§’è‰²/æ•Œäºº</h3>
                                                     {Object.keys(customConfig.emotes[emoteCategory]).map(key => (
                                                         <div key={key} onClick={() => setEmoteKey(key)} className={`p-2 cursor-pointer hover:bg-gray-100 rounded ${emoteKey === key ? 'bg-[#dcfce7] font-bold text-[#15803d]' : ''}`}>
                                                             {key}
                                                         </div>
                                                     ))}
                                                     
                                                     {/* Add new entity button */}
                                                     <div className="mt-4 pt-4 border-t">
                                                         <input id="newEmoteEntityInput" placeholder="æ–°åç§°..." className="border p-1 w-full mb-1 text-sm"/>
                                                         <button onClick={() => {
                                                             const name = document.getElementById('newEmoteEntityInput').value;
                                                             if(name && !customConfig.emotes[emoteCategory][name]) {
                                                                 const newEmotes = {...customConfig.emotes};
                                                                 newEmotes[emoteCategory][name] = { attack: [] };
                                                                 setCustomConfig({...customConfig, emotes: newEmotes});
                                                                 setEmoteKey(name);
                                                                 document.getElementById('newEmoteEntityInput').value = '';
                                                             }
                                                         }} className="w-full bg-[#57534e] text-white p-1 rounded text-xs flex items-center justify-center gap-1"><Plus size={12}/> æ–°å¢</button>
                                                     </div>
                                                 </div>
                                             )}
                                         </div>

                                         {/* Col 3: Emote List & Type Selection for non-defaults */}
                                         <div className="md:col-span-1">
                                             {emoteCategory !== 'defaults' && !emoteKey ? (
                                                 <div className="text-gray-400 text-center mt-20">è¯·åœ¨ä¸­é—´æ é€‰æ‹©å¯¹è±¡</div>
                                             ) : (
                                                 <>
                                                     {emoteCategory !== 'defaults' && (
                                                         <div className="mb-4">
                                                             <h3 className="font-bold mb-2">3. é€‰æ‹©åŠ¨ä½œç±»å‹</h3>
                                                             <select value={emoteType} onChange={(e) => setEmoteType(e.target.value)} className="w-full border p-2 rounded">
                                                                 {['attack', 'hit', 'dodge', 'crit', 'skill', 'win', 'lose'].map(type => (
                                                                     <option key={type} value={type}>{type}</option>
                                                                 ))}
                                                             </select>
                                                         </div>
                                                     )}
                                                     
                                                     <h3 className="font-bold mb-2 flex justify-between">
                                                         è¡¨æƒ…åˆ—è¡¨ 
                                                         <span className="text-xs font-normal text-gray-500 self-center">({emoteType})</span>
                                                     </h3>
                                                     <div className="space-y-2 mb-4 max-h-[40vh] overflow-y-auto">
                                                         {getCurrentEmoteList().map((item, idx) => (
                                                             <div key={idx} className="flex justify-between items-center bg-gray-50 p-2 rounded border">
                                                                 {isImageUrl(item) ? (
                                                                     <div className="flex items-center gap-2">
                                                                        <ImageIcon size={14} className="text-blue-500"/>
                                                                        <img src={item} alt="preview" className="w-8 h-8 object-contain bg-gray-200 rounded"/>
                                                                        <span className="text-xs text-gray-400 truncate w-24">{item}</span>
                                                                     </div>
                                                                 ) : (
                                                                     <span className="text-lg">{item}</span>
                                                                 )}
                                                                 <button onClick={() => handleDeleteEmote(idx)} className="text-red-500 hover:bg-red-50 p-1 rounded"><Trash2 size={16}/></button>
                                                             </div>
                                                         ))}
                                                         {getCurrentEmoteList().length === 0 && <div className="text-xs text-gray-400 italic">æš‚æ— é…ç½®</div>}
                                                     </div>
                                                     
                                                     <div className="flex gap-2">
                                                         <input 
                                                             value={newEmoteInput}
                                                             onChange={(e) => setNewEmoteInput(e.target.value)}
                                                             className="flex-1 border p-2 rounded text-sm" 
                                                             placeholder="è¾“å…¥Emojiæˆ–å›¾ç‰‡URL..." 
                                                             onKeyPress={(e) => e.key === 'Enter' && handleAddEmote()}
                                                         />
                                                         <button onClick={handleAddEmote} className="bg-[#d4af37] text-white px-3 py-2 rounded font-bold text-sm">æ·»åŠ </button>
                                                     </div>
                                                 </>
                                             )}
                                         </div>
                                     </div>
                                </div>
                            )}
                        </div>
                     </div>
                 );
             }
             
             if (gameState === 'GACHA') {
                return (
                    <div className="w-full h-screen bg-[#2a231d] flex flex-col items-center justify-center font-serif text-[#e6dcca] z-50">
                        <h2 className="text-2xl mb-8 animate-pulse tracking-widest">å‘½è¿è½®è½¬ï¼Œä½•äººå…¥å±€ï¼Ÿ</h2>
                        <button onClick={rollCharacter} className="w-32 h-32 rounded-full border-4 border-[#d4af37] flex items-center justify-center text-4xl hover:scale-110 transition-transform bg-[#3e342b] shadow-[0_0_30px_rgba(212,175,55,0.5)] cursor-pointer">æŠ½</button>
                    </div>
                );
             }

             if (gameState === 'MENU') {
                 return (
                    <div className="w-full h-screen bg-[#1c1917]/90 flex items-center justify-center backdrop-blur-sm">
                        <div className="bg-[#f4f0e6] p-10 rounded-sm border-8 border-[#2a231d] shadow-2xl text-center max-w-md w-full transform rotate-1 relative">
                            <button onClick={() => setGameState('ADMIN')} className="absolute top-4 right-4 text-gray-400 hover:text-[#b91c1c]" title="å¤©æœºé˜é…ç½®"><Settings size={20}/></button>
                            <h1 className="text-5xl font-black mb-4 text-[#2a231d] tracking-widest font-serif" style={{textShadow: '2px 2px 0px rgba(0,0,0,0.1)'}}>{player.id === 'xie_huaian' ? 'é•¿å®‰äºŒåå››è®¡' : 'è²èŠ±æ¥¼å¥‡é—»'}</h1>
                            <p className="text-[#78716c] mb-8 font-serif italic text-lg">â€” çº¸ä¸Šæƒè°‹ â€”</p>
                            <div className="bg-[#e6ded5] p-4 rounded-sm border border-[#d6d3cd] text-left text-sm mb-8 font-serif leading-loose text-[#444]">
                                <p><span className="font-bold text-[#8b2e2e]">ä¸»è§’ï¼š</span> {player.name}</p>
                                <p><span className="font-bold text-[#8b2e2e]">èƒ½åŠ›ï¼š</span> {player.id === 'xie_huaian' ? 'è¿ç­¹å¸·å¹„ï¼Œå€Ÿåˆ€æ€äºº' : 'ç›¸å¤·å¤ªå‰‘ï¼Œæ‰¬å·æ…¢'}</p>
                            </div>
                            <button onClick={() => { setGameState('INTRO'); }} className="w-full bg-[#8b2e2e] text-[#f4f0e6] py-3 rounded-sm font-bold hover:bg-[#7f1d1d] hover:scale-[1.02] transition-all flex items-center justify-center gap-2 border-2 border-[#fecaca] shadow-lg text-lg font-serif"><Feather size={20} /> ç¡®è®¤èº«ä»½</button>
                        </div>
                    </div>
                 );
             }
             
             if (gameState === 'INTRO') {
                 const isXie = player.id === 'xie_huaian';
                 return (
                    <div className="w-full h-screen bg-[#2a231d] flex items-center justify-center text-[#e6dcca] font-serif p-6">
                        <div className="max-w-2xl w-full flex flex-col items-center animate-pop-in">
                             <div className="w-full h-64 border-4 border-[#8b2e2e] bg-[#f4f0e6] mb-8 relative flex items-center justify-center overflow-hidden shadow-2xl">
                                  <div className="absolute inset-0 opacity-10 bg-[url('https://www.transparenttextures.com/patterns/rice-paper.png')]"></div>
                                  <div className="z-10 text-[#2a231d] text-center p-8">
                                      <h2 className="text-4xl font-bold mb-4 tracking-[0.5em] border-b-2 border-[#8b2e2e] pb-4 inline-block">
                                          {isXie ? 'é•¿å®‰ Â· è¯¡å±€' : 'æ±Ÿæ¹– Â· å½’é€”'}
                                      </h2>
                                      <p className="text-lg leading-loose italic">
                                          {isXie 
                                            ? "â€œè¿™é•¿å®‰åŸçš„é›¨ï¼Œæ´—ä¸å‡€äººå¿ƒçš„è´ªæ¬²ã€‚â€" 
                                            : "â€œå»å»é‡å»å»ï¼Œæ¥æ¥æ¥æ¥æ¥ã€‚â€"}
                                      </p>
                                  </div>
                                  <div className="absolute -right-10 -bottom-10 opacity-20 transform scale-[2] rotate-12 pointer-events-none">
                                      <PaperStickman color="#2a231d" charVisual={player.visual} />
                                  </div>
                             </div>

                             <div className="mb-10 text-center space-y-4 text-[#a89f91]">
                                 <p className="text-xl">
                                     {isXie 
                                       ? "è´è§‚å¹´é—´ï¼Œæš—æµæ¶ŒåŠ¨ã€‚èº«ä¸ºæ·®å—ä¸»ç°¿ï¼Œä½ æ‰‹æ— å¯¸é“ï¼Œå´è¦ä»¥è¿™äºŒåå››è®¡ï¼Œåœ¨æ­¤æ­»å±€ä¸­æ€å‡ºä¸€æ¡ç”Ÿè·¯ã€‚" 
                                       : "æ˜”æ—¥å‰‘ç¥ï¼Œä»Šæœæ¸¸åŒ»ã€‚æ‹–ç€ä¸€åº§è²èŠ±æ¥¼ï¼Œå¸¦ç€ä¸€åªé»„ç‹—ï¼Œæœ¬æ¬²äº†å´æ®‹ç”Ÿï¼Œå¥ˆä½•æ±Ÿæ¹–é£é›¨æ€»æ˜¯ä¸è‚¯æ”¾è¿‡ä½ ã€‚"}
                                 </p>
                             </div>

                             <button 
                                onClick={() => spawnEnemy(1)} 
                                className="group relative px-12 py-4 bg-[#8b2e2e] text-[#f4f0e6] text-2xl font-bold tracking-widest shadow-[0_0_20px_rgba(139,46,46,0.5)] hover:bg-[#a93838] transition-all transform hover:scale-105"
                             >
                                 <span className="relative z-10 flex items-center gap-3">
                                     {isXie ? <Scroll size={28}/> : <Sword size={28}/>}
                                     {isXie ? 'å…¥ é•¿ å®‰' : 'å…¥ æ±Ÿ æ¹–'}
                                 </span>
                                 <div className="absolute inset-0 border-2 border-[#f4f0e6] transform scale-95 group-hover:scale-100 transition-transform"></div>
                             </button>
                        </div>
                    </div>
                 );
             }

             return (
                <div className="w-full h-screen bg-[#f4f0e6] text-[#4a3b32] font-serif overflow-hidden flex flex-col lg:flex-row select-none">
                    {/* å·¦ä¾§ (Desktop) / åº•éƒ¨ (Mobile) é¢æ¿åˆ‡æ¢é€»è¾‘ */}
                    <div className="lg:hidden fixed bottom-0 left-0 right-0 bg-[#2a231d] border-t-2 border-[#3e342b] flex justify-around p-2 z-50 text-[#e6dcca]">
                        <button onClick={() => setActiveMobileTab('STATS')} className={`flex flex-col items-center ${activeMobileTab === 'STATS' ? 'text-[#d4af37]' : ''}`}><User size={20} /><span className="text-[10px]">æ¡ˆå·</span></button>
                        <button onClick={() => setActiveMobileTab('BATTLE')} className={`flex flex-col items-center ${activeMobileTab === 'BATTLE' ? 'text-[#d4af37]' : ''}`}><Sword size={24} /><span className="text-[10px]">å¯¹å†³</span></button>
                        <button onClick={() => setActiveMobileTab('LOGS')} className={`flex flex-col items-center ${activeMobileTab === 'LOGS' ? 'text-[#d4af37]' : ''}`}><MessageCircle size={20} /><span className="text-[10px]">ä¼ éŸ³</span></button>
                    </div>

                    {/* å·¦ä¾§é¢æ¿ */}
                    <div className={`w-full lg:w-72 bg-[#2a231d] text-[#e6dcca] p-5 flex flex-col border-r-4 border-[#3e342b] shadow-2xl z-20 relative ${activeMobileTab === 'STATS' ? 'flex h-[calc(100vh-60px)]' : 'hidden lg:flex'}`}>
                        <div className="absolute top-0 right-0 p-2 opacity-10"><Scroll size={64} /></div>
                        <div className="mb-4 border-b border-[#5d4d3d] pb-2 cursor-pointer group hover:bg-[#3e3228] p-2 -mx-2 rounded transition-colors relative" onClick={() => setShowStats(true)} title="ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…">
                           <div className="absolute inset-0 border-2 border-transparent group-hover:border-[#d4af37]/30 rounded pointer-events-none animate-pulse"></div>
                           <div className="flex justify-between items-center mb-2"><h2 className="text-xl font-bold flex items-center gap-2 text-[#d4af37]"><User size={20} className="stroke-[#d4af37]" /> {player.id === 'xie_huaian' ? 'æ¡ˆå·' : 'åŒ»æ¡ˆ'}</h2><MousePointer size={14} className="text-[#a89f91] opacity-50 group-hover:opacity-100" /></div>
                           <div className="space-y-1 text-sm group-hover:text-[#fbbf24] transition-colors">
                             <div className="flex justify-between items-center"><span className="text-[#a89f91]">å§“å:</span> <span className="text-[#f5f5f5] font-bold text-lg">{player.name}</span></div>
                             <div className="flex justify-between items-center"><span className="text-[#a89f91]">å“é˜¶:</span> <span className="text-[#fbbf24]">Lv.{player.level}</span></div>
                             <div className="grid grid-cols-2 gap-2 mt-2"><div className="bg-[#1e1915] p-1 px-2 rounded border border-[#3e342b] flex justify-between"><span>æ­¦/æ™º</span><span className="text-red-400">{stats.atk}</span></div><div className="bg-[#1e1915] p-1 px-2 rounded border border-[#3e342b] flex justify-between"><span>æ´å¯Ÿ</span><span className="text-orange-400">{stats.crit}%</span></div></div>
                             <div className="flex items-center gap-2 mt-2 bg-[#1e1915] p-1 px-2 rounded border border-[#3e342b] text-[#fbbf24]"><Coins size={14} /> <span>{player.money} ä¸¤</span></div>
                             <div className="mt-2"><div className="flex justify-between text-xs mb-1 text-[#a89f91]"><span>ç²¾åŠ›</span><span>{Math.floor(player.currentHp)}/{stats.maxHp}</span></div><div className="w-full h-3 bg-[#1a1612] rounded border border-[#5d4d3d] p-[1px] relative"><div className="bg-gradient-to-r from-red-800 to-red-600 h-full rounded-sm transition-all duration-500" style={{width: `${Math.min(100, (player.currentHp / stats.maxHp) * 100)}%`}}></div></div></div>
                           </div>
                        </div>
                        <div className="mb-4"><h2 className="text-sm font-bold flex items-center gap-2 mb-2 text-[#a89f91]"><Shield size={14} /> å½“å‰è£…å¤‡ (ç‚¹å‡»å¸ä¸‹)</h2><div className="grid grid-cols-3 gap-2">{['weapon', 'clothes', 'guard'].map(type => (<div key={type} className="aspect-square bg-[#1e1915] border border-[#5d4d3d] rounded flex flex-col items-center justify-center relative cursor-pointer hover:border-[#d4af37] transition-all group" title={player.slots[type]?.desc} onClick={() => handleUnequip(type)}><span className="text-[10px] text-[#555] absolute top-0.5">{type === 'weapon' ? 'æ­¦å™¨' : type === 'clothes' ? 'è¡£è£…' : 'æŠ¤å…·'}</span>{player.slots[type] ? (<><div className="text-xs text-[#d4af37] text-center font-bold px-1 mt-2">{player.slots[type].name}</div><div className="text-[9px] text-[#888] scale-90">{player.slots[type].atk > 0 ? `æ”»+${player.slots[type].atk}` : `è¡€+${player.slots[type].hp}`}</div><div className="absolute inset-0 bg-black/50 hidden group-hover:flex items-center justify-center text-xs text-white">å¸ä¸‹</div></>) : <div className="text-[#333]">-</div>}</div>))}</div></div>
                        <div className="flex-1 overflow-hidden flex flex-col mb-4"><h2 className="text-sm font-bold flex items-center gap-2 mb-2 text-[#a89f91] border-b border-[#5d4d3d] pb-1"><BookOpen size={14} /> å·²é¢†æ‚Ÿ</h2><div className="overflow-y-auto space-y-2 pr-1 custom-scrollbar">{player.skills.length === 0 && <div className="text-xs text-[#555] italic">æš‚æ— </div>}{player.skills.map((skill) => (<div key={skill.id} className="bg-[#352b22] p-2 rounded-sm border-l-2 border-[#8b2e2e]"><div className="font-bold text-[#e6dcca] text-xs flex justify-between">{skill.name}<span className="text-[9px] text-[#888]">{skill.type.includes('passive') ? 'è¢«åŠ¨' : 'ä¸»åŠ¨'}</span></div><div className="text-[9px] text-[#a89f91] leading-tight mt-1">{skill.desc}</div></div>))}</div></div>
                        <div className="h-1/4 overflow-hidden flex flex-col border-t border-[#5d4d3d] pt-3"><h2 className="text-sm font-bold flex items-center gap-2 mb-2 text-[#a89f91]"><Briefcase size={14} /> è¡Œå›Š</h2><div className="overflow-y-auto space-y-1.5 pr-2 custom-scrollbar">{player.bag.length === 0 && <div className="text-xs text-[#555] text-center mt-4">ç©ºç©ºå¦‚ä¹Ÿ</div>}{player.bag.map((item, idx) => { const isEquipped = player.slots.weapon === item || player.slots.clothes === item || player.slots.guard === item; const isConsumable = item.type === 'consumable'; return (<div key={idx} onClick={() => handleEquip(item, idx)} className={`px-2 py-1.5 rounded-sm border text-xs flex justify-between items-center cursor-pointer transition-all hover:bg-[#3e3228] ${isEquipped ? 'bg-[#3e2323] border-[#8b2e2e]' : 'bg-[#352b22] border-[#4a3b32]'}`}><span className={`${item.rarity===2 ? 'text-[#eebbcb]' : 'text-[#d6d3cd]'} ${isEquipped ? 'font-bold' : ''}`}>{item.name} {isEquipped && <span className="text-[8px] text-[#8b2e2e] bg-[#000]/20 px-1 rounded ml-1">[å·²è£…å¤‡]</span>}{isConsumable && <span className="text-[8px] text-[#10b981] bg-[#000]/20 px-1 rounded ml-1">[è¯å“]</span>}</span><div className="flex items-center gap-2"><span className="text-[#888] scale-90">{item.type === 'consumable' ? `å›+${item.heal}` : item.atk > 0 ? `+${item.atk}æ”»` : `+${item.hp}è¡€`}</span>{!isEquipped && <button onClick={(e) => handleSell(e, item, idx)} className="bg-[#5d4d3d] text-[#d6d3cd] px-1 rounded text-[9px] hover:bg-[#b91c1c]">[å”®]</button>}</div></div>);})}</div></div>
                    </div>

                    {/* Right Side (å¯†è¯­æ ) */}
                    <div className={`w-full lg:w-72 bg-[#fdfbf7] border-l-4 border-[#d6d3cd] flex flex-col shadow-xl z-20 relative ${activeMobileTab === 'LOGS' ? 'flex h-[calc(100vh-60px)]' : 'hidden lg:flex'}`}>
                        <div className="p-4 bg-[#f4f0e6] border-b border-[#e5e7eb] font-bold text-[#8b2e2e] flex items-center justify-center gap-2 font-serif text-lg tracking-widest relative">
                            <div className="absolute left-4 opacity-50"><MessageCircle size={18} /></div>
                            {player.id === 'xie_huaian' ? 'é•¿å®‰å¯†è¯­' : 'æ±Ÿæ¹–ä¼ é—»'}
                        </div>
                        <div className="flex-1 overflow-y-auto p-4 space-y-6 custom-scrollbar bg-[#fdfbf7]" style={{backgroundImage: 'radial-gradient(#e5e7eb 1px, transparent 1px)', backgroundSize: '20px 20px'}}>
                            {chats.length === 0 && <div className="text-center text-gray-400 text-xs mt-10">æš‚æ— æ¶ˆæ¯...</div>}
                            {chats.map(chat => { 
                                const isPlayer = chat.speaker === 'Player'; 
                                return (
                                    <div key={chat.id} className={`flex flex-col ${isPlayer ? 'items-end' : 'items-start'} animate-pop-in group`}>
                                        <span className="text-[10px] text-[#a89f91] mb-1 px-1">{isPlayer ? player.name : enemy.name}</span>
                                        <div className={`relative max-w-[90%] px-4 py-3 text-sm shadow-sm border ${isPlayer ? 'bg-white border-[#d6d3cd] text-[#4a3b32] rounded-l-xl rounded-br-sm rounded-tr-xl' : 'bg-[#2a231d] border-[#4a3b32] text-[#e6dcca] rounded-r-xl rounded-bl-sm rounded-tl-xl'}`}>
                                            {chat.text}
                                        </div>
                                    </div>
                                ); 
                            })}
                            <div ref={chatsEndRef} />
                        </div>
                    </div>

                    {/* Modals */}
                    {showStats && (<div className="absolute inset-0 bg-black/80 z-50 flex items-center justify-center backdrop-blur-sm"><div className="bg-[#2a231d] p-0 rounded-sm border-4 border-[#8b2e2e] w-[90%] max-w-xl shadow-2xl relative text-[#e6dcca] flex overflow-hidden"><button onClick={() => setShowStats(false)} className="absolute top-4 right-4 text-[#888] hover:text-white z-10"><X size={24}/></button><div className="w-1/2 bg-[#3e342b] p-6 flex flex-col items-center justify-center border-r border-[#5d4d3d]"><div className="w-48 h-64 relative"><PaperStickman color="#2d2d2d" slots={player.slots} charVisual={player.visual} /></div><h2 className="text-2xl font-bold font-serif text-[#fbbf24] mt-4">{charData.name}</h2><p className="text-xs text-[#a89f91]">çœŸåï¼š{charData.realName}</p><p className="text-xs text-[#888] mt-2 italic text-center px-4">"{charData.desc}"</p></div><div className="w-1/2 p-6 flex flex-col bg-[url('https://www.transparenttextures.com/patterns/wood-pattern.png')]"><h3 className="text-lg font-bold text-[#d4af37] mb-4 flex items-center gap-2 border-b border-[#5d4d3d] pb-2"><Shield size={18} /> å±æ€§è¯¦æƒ…</h3><div className="space-y-3 text-sm mb-6"><div className="flex justify-between border-b border-[#5d4d3d]/30 pb-1"><span className="text-[#a89f91]">ç­‰çº§</span><span className="text-[#e6dcca] font-bold">Lv.{player.level}</span></div><div className="flex justify-between border-b border-[#5d4d3d]/30 pb-1"><span className="text-[#a89f91]">ç”Ÿå‘½å€¼</span><span className="text-[#10b981] font-bold">{Math.floor(player.currentHp)} / {stats.maxHp}</span></div><div className="flex justify-between border-b border-[#5d4d3d]/30 pb-1"><span className="text-[#a89f91]">æ­¦/æ™º</span><span className="text-[#ef4444] font-bold">{stats.atk} <span className="text-[10px] text-[#888] font-normal">({player.baseAtk} + {stats.bonusAtk})</span></span></div><div className="flex justify-between border-b border-[#5d4d3d]/30 pb-1"><span className="text-[#a89f91]">æ´å¯Ÿ</span><span className="text-[#f97316] font-bold">{stats.crit}% <span className="text-[10px] text-[#888] font-normal">({player.baseCrit} + {stats.bonusCrit})</span></span></div><div className="flex justify-between border-b border-[#5d4d3d]/30 pb-1"><span className="text-[#a89f91]">é˜…å†</span><span className="text-[#d4af37] font-bold">{player.exp} / {player.maxExp}</span></div></div><div className="mt-auto"><div className="border-2 border-dashed border-[#5d4d3d] bg-[#1a1612] p-4 rounded flex items-center justify-between opacity-60 cursor-not-allowed group relative"><div className="flex items-center gap-3"><Award size={24} className="text-[#888]" /><div><div className="font-bold text-[#888]">æˆå°±ç³»ç»Ÿ</div><div className="text-[10px] text-[#555]">è®°å½•ä½ çš„æ±Ÿæ¹–ä¼ è¯´</div></div></div><Lock size={18} className="text-[#888]" /><div className="absolute -top-8 left-1/2 -translate-x-1/2 bg-black text-white text-xs px-2 py-1 rounded hidden group-hover:block whitespace-nowrap">å¼€å‘ä¸­ï¼Œæ•¬è¯·æœŸå¾…</div></div></div></div></div></div>)}

                    {showShop && (<div className="absolute inset-0 bg-black/80 z-50 flex items-center justify-center backdrop-blur-sm"><div className="bg-[#2a231d] p-6 rounded-sm border-4 border-[#8b2e2e] w-[90%] max-w-2xl max-h-[80vh] flex flex-col shadow-2xl relative text-[#e6dcca]"><button onClick={() => setShowShop(false)} className="absolute top-4 right-4 text-[#888] hover:text-white"><X size={24}/></button><div className="text-center mb-6 border-b border-[#5d4d3d] pb-4"><h2 className="text-3xl font-bold font-serif text-[#d4af37] tracking-[0.5em]">é¬¼å¸‚</h2><p className="text-[#a89f91] text-xs mt-1">åªè®¤é“¶ä¸¤ï¼Œä¸é—®å‡ºå¤„</p><div className="mt-2 text-[#fbbf24] font-bold flex items-center justify-center gap-2"><Coins size={16}/> ä½™é¢: {player.money} ä¸¤</div><div className="mt-2"><button onClick={() => refreshShop(player.id, true)} className="text-[10px] text-[#a89f91] hover:text-white underline">èŠ±50ä¸¤æ‰“ç‚¹å…³ç³» (åˆ·æ–°)</button></div></div><div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 overflow-y-auto custom-scrollbar p-2">{shopState.items.map((item) => (<div key={item.id} className="bg-[#1e1915] p-3 rounded border border-[#3e342b] flex flex-col justify-between hover:border-[#d4af37] transition-all"><div><div className={`font-bold ${item.rarity===2?'text-[#eebbcb]':'text-[#d6d3cd]'}`}>{item.name}</div><div className="text-[10px] text-[#888] my-1">{item.desc}</div><div className="text-xs text-[#a89f91]">{item.type === 'consumable' ? `å›+${item.heal}` : <>{item.atk>0?`æ”»+${item.atk} `:''}{item.hp>0?`è¡€+${item.hp} `:''}{item.crit?`æš´+${item.crit}%`:''}</>}</div></div><button onClick={() => handleBuy(item)} className="mt-3 w-full bg-[#3e342b] hover:bg-[#8b2e2e] text-[#d6d3cd] py-1 rounded text-xs border border-[#5d4d3d] flex justify-between px-3 items-center"><span>è´­ä¹°</span><span className="text-[#fbbf24]">{item.price} ä¸¤</span></button></div>))}</div></div></div>)}

                    {showPartnerSelect && (<div className="absolute inset-0 bg-black/80 z-50 flex items-center justify-center backdrop-blur-sm"><div className="bg-[#2a231d] p-6 rounded-sm border-4 border-[#b45309] w-[90%] max-w-lg shadow-2xl relative text-[#e6dcca]"><button onClick={() => setShowPartnerSelect(false)} className="absolute top-4 right-4 text-[#888] hover:text-white"><X size={24}/></button><div className="text-center mb-6 border-b border-[#5d4d3d] pb-4"><h2 className="text-2xl font-bold font-serif text-[#d4af37] tracking-[0.3em]">æ±Ÿæ¹–è±ªæ°</h2><p className="text-[#a89f91] text-xs mt-1">æ‹©ä¸€çŸ¥å·±ï¼Œå…±èµ´ç”Ÿæ­»</p></div><div className="space-y-3 max-h-[60vh] overflow-y-auto custom-scrollbar p-1">{currentPartnerList.map((p) => { const isUnlocked = unlockedPartners.includes(p.id); return (<div key={p.id} className={`p-4 rounded border flex justify-between items-center transition-all ${isUnlocked ? 'bg-[#1e1915] border-[#3e342b] hover:border-[#d4af37]' : 'bg-[#1a1612] border-[#292524] opacity-60'}`}><div className="flex gap-4 items-center"><div className="w-12 h-12 rounded-full border-2 border-[#5d4d3d] bg-[#2a231d] flex items-center justify-center overflow-hidden"><div className="scale-[0.4] origin-center translate-y-2"><PaperStickman charVisual={p.visual} color={p.color} /></div></div><div><div className="font-bold text-[#e6dcca]">{p.name} <span className="text-xs text-[#a89f91] font-normal">[{p.title}]</span></div><div className="text-[10px] text-[#888] mt-1">{p.desc}</div></div></div>{isUnlocked ? <button onClick={() => summonSelectedPartner(p)} className="bg-[#b45309] hover:bg-[#92400e] text-white px-4 py-2 rounded text-sm font-bold border border-[#fcd34d] shadow-sm active:scale-95">å‡ºæˆ˜</button> : <div className="text-xs text-[#555] bg-[#0c0a09] px-3 py-1 rounded">Lv.{p.unlockLevel} è§£é”</div>}</div>); })}</div></div></div>)}

                    {showMap && (<div className="absolute inset-0 bg-black/80 z-50 flex items-center justify-center backdrop-blur-sm"><div className="bg-[#e6dcca] p-6 rounded-sm border-8 border-[#3e2323] w-[90%] max-w-2xl shadow-2xl relative text-[#3e2323] flex flex-col items-center"><button onClick={() => setShowMap(false)} className="absolute top-4 right-4 text-[#888] hover:text-[#b91c1c] z-10"><X size={24}/></button><h2 className="text-3xl font-bold font-serif text-[#8b2e2e] tracking-[0.5em] mb-2">{player.id === 'xie_huaian' ? 'é•¿å®‰èˆ†å›¾' : 'æ±Ÿæ¹–è¡Œè·¯'}</h2><div className="grid grid-cols-5 gap-4 w-full p-4">{Object.entries(STORY_CONFIGS[player.id] || STORY_CONFIGS['xie_huaian']).map(([lvl, config]) => { const levelNum = parseInt(lvl); const isUnlocked = levelNum <= maxUnlockedStage; const isCurrent = levelNum === stage; return (<button key={lvl} onClick={() => isUnlocked ? selectStage(levelNum) : null} disabled={!isUnlocked} className={`aspect-square rounded flex flex-col items-center justify-center border-2 transition-all relative ${isUnlocked ? 'bg-[#f4f0e6] border-[#8b2e2e] hover:bg-[#fed7aa] cursor-pointer shadow-md' : 'bg-[#a8a29e] border-[#57534e] cursor-not-allowed opacity-50 grayscale'} ${isCurrent ? 'ring-4 ring-[#d4af37]' : ''}`}><div className="font-bold text-lg font-serif">{lvl}</div><div className="text-[10px] text-center leading-tight px-1 mt-1">{config.title}</div>{config.boss && <div className="absolute top-1 right-1 text-[#b91c1c]"><Skull size={12}/></div>}</button>); })}</div></div></div>)}
                    
                    {gameState === 'RESTING' && (<div className="absolute inset-0 z-40 flex items-center justify-center pointer-events-none"><div className="bg-[#2a231d] p-8 rounded-lg shadow-2xl pointer-events-auto text-center border-4 border-[#5d4d3d] text-[#e6dcca] w-80 relative overflow-hidden"><Moon size={48} className="mx-auto mb-4 text-[#fbbf24] animate-pulse relative z-10" /><h2 className="text-2xl font-bold mb-2 font-serif relative z-10">é‡ä¼¤é¿é™©ä¸­...</h2><div className="text-4xl font-mono mb-4 text-[#fbbf24] relative z-10">{Math.floor(restTime / 60)}:{String(restTime % 60).padStart(2, '0')}</div><div className="w-full bg-[#1c1917] h-3 rounded-full mb-2 overflow-hidden border border-[#444] relative z-10"><div className="bg-[#15803d] h-full transition-all duration-1000" style={{width: `${(player.currentHp / stats.maxHp) * 100}%`}}></div></div><div className="text-xs text-[#a89f91] mb-6 relative z-10">é™å¾…æ—¶æœº: {Math.floor(player.currentHp)}/{stats.maxHp}</div><div className="flex gap-2"><button onClick={instantRevive} className="flex-1 bg-[#d4af37] hover:bg-[#b45309] text-[#2a231d] font-bold py-2 rounded text-xs border border-[#fcd34d]"><Zap size={14} className="inline mr-1"/> ç«‹å³å¤æ´»</button><button onClick={() => { setShowMap(true); }} className="flex-1 bg-[#57534e] hover:bg-[#44403c] text-white font-bold py-2 rounded text-xs border border-[#a89f91]"><Map size={14} className="inline mr-1"/> æ’¤è‡³èˆ†å›¾</button></div></div></div>)}

                    {gameState === 'VICTORY' && (<div className="absolute inset-0 z-40 flex items-center justify-center pointer-events-none"><div className="bg-[#fef3c7] border-4 border-[#b45309] p-8 rounded-sm shadow-xl pointer-events-auto animate-bounce-in flex flex-col items-center transform rotate-1"><Trophy size={56} className="text-[#d97706] mb-3 drop-shadow-md" /><h2 className="text-3xl font-bold mb-4 font-serif text-[#92400e] tracking-widest">èƒœå¤©åŠå­</h2><div className="w-full h-px bg-[#b45309]/30 mb-4"></div><div className="text-sm text-[#a89f91] mb-4 animate-pulse">2ç§’åè‡ªåŠ¨è¿›å…¥ä¸‹ä¸€å±€...</div><button onClick={nextStage} className="bg-[#b45309] text-[#fffbeb] px-8 py-2 rounded-sm font-bold hover:bg-[#92400e] border-2 border-[#fcd34d] shadow-md active:translate-y-1 transition-all font-serif text-lg pointer-events-auto">ä¸‹ä¸€å±€ (ç«‹å³)</button></div></div>)}
                    
                    {gameState === 'GAME_COMPLETED' && (<div className="absolute inset-0 bg-[#1c1917]/90 z-50 flex items-center justify-center backdrop-blur-sm"><div className="bg-[#f4f0e6] p-12 rounded-sm border-8 border-[#2a231d] shadow-2xl text-center max-w-lg w-full transform rotate-1 relative animate-pop-in"><Trophy size={64} className="mx-auto mb-6 text-[#d97706]" /><h1 className="text-5xl font-black mb-4 text-[#2a231d] tracking-widest font-serif" style={{textShadow: '2px 2px 0px rgba(0,0,0,0.1)'}}>å±€ç»ˆäººæ•£</h1><p className="text-[#78716c] mb-8 font-serif italic text-xl">â€” çº¸ä¸Šæ±Ÿæ¹– Â· å®Œ â€”</p><div className="bg-[#e6ded5] p-6 rounded-sm border border-[#d6d3cd] text-center text-sm mb-8 font-serif leading-loose text-[#444]"><p>æ©æ€¨æƒ…ä»‡ï¼Œçš†éšé£å»ã€‚</p><p>æ±Ÿæ¹–è·¯è¿œï¼Œæœ‰ç¼˜å†ä¼šã€‚</p><p className="text-lg font-bold text-[#8b2e2e] mt-4">åç»­å‰§æƒ… Â· æ­£åœ¨å¼€å‘ä¸­</p></div><button onClick={resetGame} className="w-full bg-[#3e342b] text-[#f4f0e6] py-3 rounded-sm font-bold hover:bg-[#2a231d] hover:scale-[1.02] transition-all flex items-center justify-center gap-2 border-2 border-[#a8a29e] shadow-lg text-lg font-serif">è¿”å›é¦–é¡µ</button></div></div>)}
                </div>
             );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(React.createElement(PaperDuel));
    </script>
</body>
</html>
