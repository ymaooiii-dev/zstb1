<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>çº¸ä¸Šæ±Ÿæ¹– - é•¿å®‰äºŒåå››è®¡ x è²èŠ±æ¥¼</title>
    
    <!-- å¼•å…¥ Tailwind CSS (æ ·å¼) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- å¼•å…¥ Babel (ç”¨äºç¼–è¯‘ JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { margin: 0; overflow: hidden; background-color: #2a231d; touch-action: manipulation; font-family: "Songti SC", "SimSun", serif; }
        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡ */
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #d6d3cd; border-radius: 2px; }
        .bg-[#2a231d] .custom-scrollbar::-webkit-scrollbar-thumb { background: #5d4d3d; }

        /* åŠ¨ç”»å®šä¹‰ */
        @keyframes float-up { 0% { transform: translate(-50%, 0) scale(1); opacity: 1; } 100% { transform: translate(-50%, -60px) scale(1.2); opacity: 0; } }
        .animate-float-up { animation: float-up 0.8s ease-out forwards; }
        
        @keyframes lunge-right { 0% { transform: translateX(0) rotate(-2deg); } 50% { transform: translateX(60px) rotate(5deg); } 100% { transform: translateX(0) rotate(-2deg); } }
        .animate-lunge-right { animation: lunge-right 0.25s ease-in-out; }
        
        @keyframes lunge-left { 0% { transform: translateX(0) rotate(2deg); } 50% { transform: translateX(-60px) rotate(-5deg); } 100% { transform: translateX(0) rotate(2deg); } }
        .animate-lunge-left { animation: lunge-left 0.25s ease-in-out; }
        
        @keyframes shake { 0%, 100% { transform: translateX(0); } 20% { transform: translateX(-5px) rotate(-5deg); } 40% { transform: translateX(5px) rotate(5deg); } 60% { transform: translateX(-5px); } 80% { transform: translateX(5px); } }
        .animate-shake { animation: shake 0.3s ease-in-out; }
        
        @keyframes pop-in { 0% { opacity: 0; transform: scale(0.8) translateY(10px); } 100% { opacity: 1; transform: scale(1) translateY(0); } }
        .animate-pop-in { animation: pop-in 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }

        @keyframes bounce-in { 0% { opacity: 0; transform: scale(0.3); } 50% { opacity: 1; transform: scale(1.05); } 70% { transform: scale(0.9); } 100% { transform: scale(1); } }
        .animate-bounce-in { animation: bounce-in 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }

        @keyframes meme-popup { 0% { transform: translate(0, 20px) scale(0) rotate(-5deg); opacity: 0; } 60% { transform: translate(0, -10px) scale(1.1) rotate(2deg); opacity: 1; } 100% { transform: translate(0, 0) scale(1) rotate(0deg); opacity: 1; } }
        .animate-meme { animation: meme-popup 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
    </style>
    
    <!-- Import Map -->
    <script type="importmap">
        {
            "imports": {
                "react": "https://esm.sh/react@18.2.0",
                "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
                "lucide-react": "https://esm.sh/lucide-react@0.263.1",
                "firebase/app": "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js",
                "firebase/auth": "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js",
                "firebase/firestore": "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"
            }
        }
    </script>
</head>
<body>
    <div id="root"></div>

    <!-- æ ¸å¿ƒé€»è¾‘ï¼šä½¿ç”¨ data-type="module" å¯ç”¨ ES Module å¯¼å…¥ -->
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { Sword, ShoppingBag, Play, Trophy, MessageCircle, Moon, Clock, Zap, Star, Shield, Skull, BookOpen, Wind, Scroll, Feather, Briefcase, User, PenTool, Users, UserPlus, Coins, X, Store, MousePointer, Power, ChevronRight, Lock, Award, Info, Heart, Map, Coffee, KeyRound, Pill, Leaf, RefreshCw, Settings, Image as ImageIcon, Smile, MessageSquare, Upload, Plus, Trash2, Cloud, Download, Share2, Radio, Wifi, WifiOff, Hammer } from 'lucide-react';
        
        import { initializeApp } from 'firebase/app';
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'firebase/auth';
        import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot } from 'firebase/firestore';

        // --- Firebase é…ç½®ä¸åˆå§‹åŒ– ---
        const manualConfig = {
            apiKey: "AIzaSyAsR-raXlcfcl4cypSR0lucwa8WZ8NB3-U",
            authDomain: "zsjh-4cd72.firebaseapp.com",
            projectId: "zsjh-4cd72",
            storageBucket: "zsjh-4cd72.firebasestorage.app",
            messagingSenderId: "159277988582",
            appId: "1:159277988582:web:1024db59f3eebe21549927"
        };

        let db = null;
        let auth = null;
        let appId = 'default-app-id';

        try {
            let firebaseConfig = null;
            if (manualConfig.apiKey && manualConfig.apiKey.length > 0) {
                firebaseConfig = manualConfig;
                console.log("Using manual Firebase config");
            } else if (typeof __firebase_config !== 'undefined') {
                firebaseConfig = JSON.parse(__firebase_config);
                appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                console.log("Using environment Firebase config");
            }

            if (firebaseConfig) {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
            } else {
                console.warn("Firebase config not found. Cloud features disabled.");
            }
        } catch (e) {
            console.error("Firebase init failed:", e);
        }

        const GLOBAL_CONFIG_ID = 'global_release_v1';
        const REST_DURATION = 60; 
        const PARTNER_UNLOCK_LEVEL = 3; 
        const PARTNER_COOLDOWN_BASE = 150; 
        const INVITE_CODES = ["517", "520", "1314", "qiqi", "guoguo", "admin"]; 
        const SHOP_REFRESH_INTERVAL = 2 * 60 * 60 * 1000; 
        const SHOP_REFRESH_COST = 250; 

        // --- é»˜è®¤æ•°æ® ---
        const DEFAULT_CHARACTERS_DATA = [
          { id: 'xie_huaian', name: "è°¢æ·®å®‰", realName: "åˆ˜çŸ¥", desc: "ç™½å‘è°‹å£«ï¼Œæ­¥æ­¥ä¸ºè¥ã€‚", baseHp: 120, baseAtk: 12, baseCrit: 20, visual: 'xie_huaian' },
          { id: 'li_lianhua', name: "æè²èŠ±", realName: "æç›¸å¤·", desc: "ç¥ç§˜ç¥åŒ»ï¼Œæ˜”æ—¥å‰‘ç¥ã€‚", baseHp: 140, baseAtk: 15, baseCrit: 10, visual: 'li_lianhua' }
        ];

        // é»˜è®¤è£…å¤‡æ± 
        const DEFAULT_EQUIPMENT = {
          'xie_huaian': [
            { id: 'xh_1', name: "å‰Šæ¢¨å°åˆ€", type: "weapon", visual: "knife", atk: 12, hp: 0, rarity: 1, price: 50, dropWeight: 50, desc: "éšèº«æºå¸¦ï¼Œé”‹åˆ©å¼‚å¸¸" },
            { id: 'xh_2', name: "æ—§é“é”¹", type: "weapon", visual: "shovel", atk: 45, hp: 50, rarity: 2, price: 500, dropWeight: 5, desc: "ä¼ è¯´ä¸­çš„ç¥å…µï¼Œç®¡æ€ç®¡åŸ‹" },
            { id: 'xh_3', name: "ç‹¼æ¯«ç¬”", type: "weapon", visual: "brush", atk: 10, hp: 0, rarity: 1, price: 40, dropWeight: 50, desc: "ç¬”é”‹å¦‚åˆ€ï¼Œæ€äººæ— å½¢" },
            { id: 'xh_4', name: "ç²¾é’¢ä¼éª¨", type: "weapon", visual: "umbrella_rib", atk: 15, hp: 0, crit: 5, rarity: 1, price: 100, dropWeight: 30, desc: "ä»æ²¹çº¸ä¼ä¸­æŠ½å‡ºçš„åˆ©å™¨" },
            { id: 'xh_5', name: "äºŒåå››è®¡æ‰‹æœ­", type: "weapon", visual: "scroll", atk: 25, hp: 20, crit: 10, rarity: 2, price: 300, dropWeight: 10, desc: "è®°è½½ç€ç»ä¸–è®¡è°‹" },
            { id: 'xh_6', name: "ç´ éº»è¡£", type: "clothes", visual: "robe_gray", atk: 0, hp: 50, rarity: 1, price: 50, dropWeight: 50, desc: "ç²—å¸ƒéº»è¡£ï¼Œæ©äººè€³ç›®" },
            { id: 'xh_7', name: "é¹¤æ°…", type: "clothes", visual: "robe_white", atk: 2, hp: 80, rarity: 2, price: 200, dropWeight: 15, desc: "åå£«ä¹‹é£ï¼Œè¶…å‡¡è„±ä¿—" },
            { id: 'xh_8', name: "æŠ¤è…•", type: "guard", visual: "bracer", atk: 1, hp: 30, rarity: 1, price: 60, dropWeight: 40, desc: "è—åœ¨è¢–ä¸­çš„çš®è´¨æŠ¤è…•" },
            { id: 'xh_9', name: "å¹³å®‰æ‰£", type: "guard", visual: "jade", atk: 0, hp: 40, rarity: 1, price: 80, dropWeight: 30, desc: "å¹¶ä¸ä¿å¹³å®‰çš„æ—§ç‰©" },
            { id: 'xh_10', name: "é‡‘ç–®è¯", type: "consumable", visual: "pill", heal: 80, rarity: 1, price: 30, dropWeight: 100, desc: "æ­¢è¡€ç”Ÿè‚Œï¼Œå›å¤80ç‚¹ç”Ÿå‘½" },
            { id: 'xh_11', name: "åŠè¾¹æ¥›", type: "consumable", visual: "herb", heal: 50, cure: true, rarity: 2, price: 60, dropWeight: 30, desc: "ç¨€ä¸–è‰è¯ï¼Œè§£æ¯’å¹¶å›å¤50ç‚¹ç”Ÿå‘½" },
            { id: 'xh_12', name: "æ–­æœ¨å‰‘", type: "weapon", visual: "stick", atk: 3, hp: 0, rarity: 1, price: 10, dropWeight: 60, desc: "å°å­©å­è¿‡å®¶å®¶çš„ç©å…·" },
            { id: 'xh_13', name: "çŸ³å­", type: "weapon", visual: "stone", atk: 5, hp: 0, rarity: 1, price: 5, dropWeight: 80, desc: "è·¯è¾¹éšå¤„å¯è§çš„çŸ³å¤´" }
          ],
          'li_lianhua': [
            { id: 'll_1', name: "å°‘å¸ˆå‰‘", type: "weapon", visual: "sword_shaoshi", atk: 35, hp: 0, crit: 10, rarity: 2, price: 600, dropWeight: 5, desc: "æ˜”æ—¥å‰‘ç¥ä½©å‰‘" },
            { id: 'll_2', name: "åˆé¢ˆè½¯å‰‘", type: "weapon", visual: "sword_wenjing", atk: 30, hp: 0, crit: 15, rarity: 2, price: 500, dropWeight: 5, desc: "æŸ”éŸ§è‡³æï¼Œé˜²ä¸èƒœé˜²" },
            { id: 'll_3', name: "é’é’¢å‰‘", type: "weapon", visual: "sword", atk: 15, hp: 0, rarity: 1, price: 80, dropWeight: 40, desc: "æ±Ÿæ¹–å¸¸è§çš„å…µå™¨" },
            { id: 'll_4', name: "ä¸€è¢‹ç³–", type: "guard", visual: "candy", atk: 0, hp: 50, rarity: 1, price: 30, dropWeight: 60, desc: "å¿ƒæƒ…ä¸å¥½æ—¶åƒä¸€é¢—" },
            { id: 'll_5', name: "ç‹ç‹¸ç²¾é¡¹åœˆ", type: "guard", visual: "collar", atk: 5, hp: 60, rarity: 1, price: 120, dropWeight: 20, desc: "ç‹—ä¹Ÿæ˜¯å¾ˆå‡¶çš„" },
            { id: 'll_6', name: "æ¸¸åŒ»å¸ƒè¢", type: "clothes", visual: "robe_green", atk: 0, hp: 80, rarity: 1, price: 100, dropWeight: 30, desc: "è™½ç„¶æ—§äº†ç‚¹ï¼Œä½†å¾ˆå¹²å‡€" },
            { id: 'll_7', name: "è²èŠ±ç‰ä½©", type: "guard", visual: "jade_lotus", atk: 2, hp: 40, rarity: 1, price: 150, dropWeight: 20, desc: "æ¸©æ¶¦å…»äºº" },
            { id: 'll_8', name: "é‡‘ç–®è¯", type: "consumable", visual: "pill", heal: 80, rarity: 1, price: 30, dropWeight: 100, desc: "æ­¢è¡€ç”Ÿè‚Œï¼Œå›å¤80ç‚¹ç”Ÿå‘½" },
            { id: 'll_9', name: "åŠè¾¹æ¥›", type: "consumable", visual: "herb", heal: 50, cure: true, rarity: 2, price: 60, dropWeight: 30, desc: "ç¨€ä¸–è‰è¯ï¼Œè§£æ¯’å¹¶å›å¤50ç‚¹ç”Ÿå‘½" },
            { id: 'll_10', name: "ç”Ÿé”ˆå‰ªåˆ€", type: "weapon", visual: "scissors", atk: 5, hp: 0, rarity: 1, price: 10, dropWeight: 50, desc: "ç”¨æ¥å‰ªè¯æçš„" },
            { id: 'll_11', name: "è‰é‹", type: "guard", visual: "shoes", atk: 0, hp: 10, rarity: 1, price: 5, dropWeight: 80, desc: "èµ°ä¸¤æ­¥å°±ç£¨ç ´äº†" }
          ]
        };

        // é»˜è®¤å°è¯é…ç½®
        const DEFAULT_DIALOGUES = {
          xie_huaian: {
            attack: ["æ­¤å±€å·²å®šã€‚", "è¿™æ‹›å¦‚ä½•ï¼Ÿ", "é“é”¹...æ˜¯ç”¨æ¥åŸ‹ä½ çš„ã€‚", "äººå¿ƒï¼Œæœ€æ˜¯éš¾æµ‹ã€‚", "å€Ÿåˆ€æ€äººã€‚"],
            hit: ["è¿˜åœ¨è®¡ç®—ä¹‹ä¸­ã€‚", "è¿™ç‚¹ä»£ä»·...å€¼å¾—ã€‚", "å“å“Ÿï¼Œè½»ç‚¹ï¼", "æ— å¦¨ã€‚"],
            win: ["æ¸…ç†å¹²å‡€ã€‚", "ä¸‹ä¸€ä¸ªã€‚", "ä¸è¿‡æ˜¯å¼ƒå­ã€‚", "é•¿å®‰çš„é›ªï¼Œåˆçº¢äº†å‡ åˆ†ã€‚"]
          },
          li_lianhua: {
            attack: ["å»å»é‡å»å»ï¼Œæ¥æ¥æ¥æ¥æ¥ã€‚", "ä»Šæ—¥å®œè§£ç­¾ï¼Œå¤§å‰ã€‚", "è¿™æ‹›å«...å°æ¥¼ä¸œé£ã€‚", "å©†å¨‘æ­¥ï¼"],
            hit: ["å’³å’³...ç¢§èŒ¶ä¹‹æ¯’åˆçŠ¯äº†...", "åˆ«å¼„è„äº†æˆ‘çš„è¡£æœã€‚", "å“å‘€ï¼Œå¥½ç–¼ã€‚"],
            win: ["æ‰¿è®©ã€‚", "è¿˜æ˜¯ç§èåœæœ‰è¶£ã€‚", "è¿™æ±Ÿæ¹–ï¼Œä¸æ··ä¹Ÿç½¢ã€‚"]
          },
          enemies: {
              default: {
                  intro: ["æ¥è€…ä½•äººï¼", "è¿™å¯æ˜¯æˆ‘çš„åœ°ç›˜ã€‚", "æŠŠå‘½ç•™ä¸‹ï¼"],
                  attack: ["å—æ­»å§ï¼", "çœ‹æ‹›ï¼", "å¤ªæ…¢äº†ï¼", "ç»™æˆ‘å€’ä¸‹ï¼"],
                  hit: ["å¯æ¶...", "æ€ä¹ˆå¯èƒ½...", "å¥½ç—›ï¼", "ä½ ç­‰ç€ï¼"]
              },
              "é’¦å·®å¤§è‡£": { intro: ["è°¢å¤§äººï¼Œè¿™è´¦æœ¬å¥½åƒä¸å¯¹å•Šã€‚", "å®˜åœºå¦‚æˆï¼Œå…¨é æ¼”æŠ€ã€‚"], attack: ["æœ¬å®˜ä¹Ÿæ˜¯ç»ƒè¿‡çš„ï¼"], hit: ["åˆ«æ‰“è„¸ï¼"] },
              "è§æ–‡æ•¬": { intro: ["åˆ˜çŸ¥ï¼Œä½ æœç„¶æ²¡æ­»ï¼", "åªè¦æˆ‘æ´»ç€ï¼Œä½ å°±æ°¸è¿œæ˜¯é€ƒçŠ¯ã€‚"], attack: ["è®©ä½ è§è¯†è§å®¶çš„æ‰‹æ®µï¼"], hit: ["æˆ‘ä¸ç”˜å¿ƒï¼"] },
              "å•å­¤åˆ€": { intro: ["å¸ˆå¼Ÿï¼Œä½ è¿˜æ˜¯è¿™ä¹ˆå¤©çœŸã€‚", "è¿™å¤©ä¸‹ï¼Œç»ˆç©¶æ˜¯æˆ‘çš„ï¼"], attack: ["ä½ ä¹Ÿé…ç”¨å‰‘ï¼Ÿ"], hit: ["ä¸å¯èƒ½ï¼"] },
              "ç¬›é£å£°(å½±)": { intro: ["æç›¸å¤·ï¼Œå‡ºå‰‘ï¼", "å¤ªæ…¢äº†ï¼"], attack: ["æ‚²é£ç™½æ¨ï¼"], hit: ["å¥½å‰‘æ³•ï¼"] }
          }
        };

        // é»˜è®¤è¡¨æƒ…åŒ…é…ç½®
        const DEFAULT_MEMES = {
            xie_huaian: {
                crit: { type: 'text', content: 'ç¥æœºå¦™ç®—ï¼', enabled: true },
                dodge: { type: 'text', content: 'å°½åœ¨æŒæ¡', enabled: true },
                beaten: { type: 'text', content: 'è‹¦è‚‰è®¡...', enabled: true },
                win: { type: 'text', content: 'æ”¶ç½‘', enabled: true }
            },
            li_lianhua: {
                crit: { type: 'text', content: 'å‰‘ç¥ä¸€å‡»ï¼', enabled: true },
                dodge: { type: 'text', content: 'æºœäº†æºœäº†', enabled: true },
                beaten: { type: 'text', content: 'æˆ‘è¦åè¡€äº†', enabled: true },
                win: { type: 'text', content: 'å›å®¶åƒé¥­', enabled: true }
            },
            enemies: {
                default: {
                    crit: { type: 'text', content: 'ç—›å—ï¼Ÿ', enabled: true },
                    dodge: { type: 'text', content: 'æƒ³æ‰“ä¸­æˆ‘ï¼Ÿ', enabled: true },
                    beaten: { type: 'text', content: 'åˆ«æ‰“äº†åˆ«æ‰“äº†', enabled: true }
                },
                "åˆ˜å­è¨€": {
                    crit: { type: 'text', content: 'è¼èšï¼', enabled: true },
                    dodge: { type: 'text', content: 'å¤ªæ…¢äº†', enabled: true },
                    beaten: { type: 'text', content: 'å²‚æœ‰æ­¤ç†', enabled: true }
                }
            }
        };

        // --- å‰§æƒ…é…ç½® ---
        const STORY_CONFIGS = {
          'xie_huaian': {
            1: { enemyName: "é’¦å·®å¤§è‡£", title: "åˆå…¥é•¿å®‰", hpScale: 1.5, atkScale: 1.2 },
            2: { enemyName: "å¥½å‹å‘¨å¢¨", title: "æ—§å‹é‡é€¢", hpScale: 2.0, atkScale: 1.5 },
            3: { enemyName: "ç‹æ ¡å°‰", title: "æš—æµæ¶ŒåŠ¨", hpScale: 2.5, atkScale: 1.8 },
            4: { enemyName: "è§æ–‡æ•¬", title: "ç¬‘é¢è™", hpScale: 3.5, atkScale: 2.2 },
            5: { enemyName: "è§æ­¦é˜³", title: "ç¬¬ä¸€å±€Â·ç»ˆ", boss: true, hpScale: 10.0, atkScale: 5.0 },
            6: { enemyName: "è™è´²æš—å«", title: "é€ä¸ªå‡»ç ´", hpScale: 5.0, atkScale: 3.0 },
            7: { enemyName: "è’²é€†å·", title: "é¬¼é¢å¤ä»‡", hpScale: 6.0, atkScale: 3.5 },
            8: { enemyName: "è™è´²æš—å«", title: "é‡é‡åŒ…å›´", hpScale: 7.0, atkScale: 4.0 },
            9: { enemyName: "é’è¡£", title: "é’è¡£ç´ è£¹", hpScale: 9.0, atkScale: 5.0 },
            10: { enemyName: "åˆ˜å­è¨€", title: "ç¬¬äºŒå±€Â·ç»ˆ", boss: true, hpScale: 20.0, atkScale: 10.0 },
          },
          'li_lianhua': {
            1: { enemyName: "æ±Ÿæ¹–éƒä¸­", title: "ä¸œæµ·ä¹‹æ»¨", hpScale: 1.5, atkScale: 1.2 },
            2: { enemyName: "é£ç«å ‚æ¶éœ¸", title: "åˆéœ²é”‹èŠ’", hpScale: 2.0, atkScale: 1.5 },
            3: { enemyName: "æœ´é”„å±±å°¸", title: "è¯¡æ¡ˆè¿·è¸ª", hpScale: 2.5, atkScale: 1.8 },
            4: { enemyName: "å¦™æ‰‹ç©ºç©º", title: "æ•…äººç›¸è§", hpScale: 3.5, atkScale: 2.2 },
            5: { enemyName: "ç¬›é£å£°(å½±)", title: "å®¿å‘½ä¹‹æ•Œ", boss: true, hpScale: 10.0, atkScale: 5.0 },
            6: { enemyName: "é‡‘é¸³ç›Ÿä¼—", title: "ç™¾å·å½’æµ·", hpScale: 5.0, atkScale: 3.0 },
            7: { enemyName: "ä¸‡åœ£é“æ­»å£«", title: "é˜´è°‹æµ®ç°", hpScale: 6.0, atkScale: 3.5 },
            8: { enemyName: "è§’ä¸½è°¯", title: "çº¢è¡£å¦–å¥³", hpScale: 7.0, atkScale: 4.0 },
            9: { enemyName: "å°ç£¬", title: "è¡€æµ·æ·±ä»‡", hpScale: 9.0, atkScale: 5.0 },
            10: { enemyName: "å•å­¤åˆ€", title: "å¸ˆé—¨æ©æ€¨", boss: true, hpScale: 20.0, atkScale: 10.0 },
          }
        };

        // åˆå§‹æ•Œäººåˆ—è¡¨
        const INITIAL_ENEMIES_LIST = [...new Set([
            ...Object.values(STORY_CONFIGS.xie_huaian).map(c => c.enemyName),
            ...Object.values(STORY_CONFIGS.li_lianhua).map(c => c.enemyName)
        ])];

        // æŠ€èƒ½æ ‘
        const SKILLS_DB = {
          'xie_huaian': {
            1: { id: 'jiedao', name: "å€Ÿåˆ€æ€äºº", desc: "å€ŸåŠ›æ‰“åŠ›ï¼Œå—å‡»æ—¶åå¼¹ 30% ä¼¤å®³", type: "passive_reflect" },
            3: { id: 'diaohu', name: "è°ƒè™ç¦»å±±", desc: "èº«æ³•è¯¡è°²ï¼Œé—ªé¿ç‡æå‡ 15%", type: "passive_dodge" },
            6: { id: 'fudi', name: "é‡œåº•æŠ½è–ª", desc: "æ”»å¿ƒä¸ºä¸Šï¼Œæ”»å‡»å‰Šå‡æ•Œäººæ”»å‡»åŠ›", type: "passive_debuff" },
            9: { id: 'jinchan', name: "é‡‘è‰è„±å£³", desc: "è‡´å‘½ä¸€å‡»æ—¶å…æ­»å¹¶å›è¡€ (æ¯åœºä¸€æ¬¡)", type: "passive_resurrect" },
            12: { id: 'lianhuan', name: "è¿ç¯è®¡", desc: "è®¡è®¡ç›¸æ‰£ï¼Œ40% å‡ ç‡è¿½åŠ è°‹ç•¥ä¼¤å®³", type: "passive_double" },
            15: { id: 'manutian', name: "ç’å¤©è¿‡æµ·", desc: "ç»ˆæå¸ƒå±€ï¼Œæ•Œäººè¡€é‡<40% ç›´æ¥æ–©æ€", type: "passive_execute" }
          },
          'li_lianhua': {
            1: { id: 'yangzhouman', name: "æ‰¬å·æ…¢", desc: "è‡³çº¯å†…åŠŸï¼Œæš´å‡»æ—¶æ¢å¤ 15 ç‚¹ç”Ÿå‘½", type: "passive_heal" },
            3: { id: 'posuobu', name: "å©†å¨‘æ­¥", desc: "ç‹¬é—¨è½»åŠŸï¼Œé—ªé¿ç‡æå‡ 15%", type: "passive_dodge" },
            6: { id: 'xiangyi', name: "ç›¸å¤·å¤ªå‰‘", desc: "å¤©ä¸‹æœ€å¿«ï¼Œæ”»å‡»æœ‰ 30% å‡ ç‡äºŒè¿å‡»", type: "passive_double" },
            9: { id: 'bi_cha', name: "ç¢§èŒ¶å‹åˆ¶", desc: "ä»¥æ¯’æ”»æ¯’ï¼Œç”Ÿå‘½è¶Šä½æ”»å‡»è¶Šé«˜", type: "passive_low_hp" },
            12: { id: 'xiaolou', name: "å°æ¥¼ä¸œé£", desc: "ç»ä¸–å‰‘æ‹›ï¼Œæš´å‡»ä¼¤å®³æå‡ 50%", type: "passive_crit_dmg" },
            15: { id: 'mingyue', name: "æ˜æœˆè¥¿æµ·", desc: "å‰‘æ„æµ©ç€šï¼Œæ™®æ”»é™„åŠ çœŸå®ä¼¤å®³", type: "passive_true_dmg" }
          }
        };

        // ä¼™ä¼´é…ç½®
        const PARTNERS_DB = {
          'xie_huaian': [
            { id: 'ye_zheng', name: "å¶é“®", title: "å­¤å‚²å‰‘å®¢", unlockLevel: 3, desc: "ä¸€å‰‘å…‰å¯’ï¼Œç”Ÿæ­»æ— æ‚”", visual: 'ye_zheng', skillName: "ç»å°˜å‰‘", skillDesc: "æé«˜ä¼¤å®³ï¼Œå†·å´æ—¶é—´ç¿»å€", duration: 60000, cooldown: PARTNER_COOLDOWN_BASE * 2, color: "#18181b" },
            { id: 'zhang_mo', name: "å¼ é»˜", title: "åŸè§æ–‡æ•¬", unlockLevel: 4, desc: "æ”¹å¤´æ¢é¢ï¼Œä»¥æ–§è¯é“", visual: 'zhang_mo', skillName: "å¼€å±±æ–§", skillDesc: "åŠ¿å¤§åŠ›æ²‰çš„åŠˆç ", duration: 60000, cooldown: PARTNER_COOLDOWN_BASE, color: "#52525b" },
            { id: 'pu_nichuan', name: "è’²é€†å·", title: "é¬¼é¢äºº", unlockLevel: 7, desc: "æ©æ€¨åˆ†æ˜ï¼Œä¸æ­»ä¸ä¼‘", visual: 'pu_nichuan', skillName: "è¡€ç¥­", skillDesc: "ç‡ƒçƒ§ç”Ÿå‘½ï¼Œç–¯ç‹‚æ”»å‡»", duration: 60000, cooldown: PARTNER_COOLDOWN_BASE, color: "#7f1d1d" },
            { id: 'bai_wan', name: "ç™½çš–", title: "ç¥ç§˜äºº", unlockLevel: 8, desc: "æ¥å»æ— è¸ªï¼Œäº¦æ­£äº¦é‚ª", visual: 'bai_wan', skillName: "è¿·è¸ª", skillDesc: "ååŠ©æ”»å‡»ï¼Œå¹²æ‰°æ•Œäºº", duration: 60000, cooldown: PARTNER_COOLDOWN_BASE, color: "#e5e7eb" }
          ],
          'li_lianhua': [
            { id: 'fang_duobing', name: "æ–¹å¤šç—…", title: "å¤©æœºå ‚å°‘ä¸»", unlockLevel: 3, desc: "å¤šæ„å…¬å­ï¼Œæœºå…³ç™¾å˜", visual: 'fang_duobing', skillName: "å°”é›…å‰‘", skillDesc: "é€ æˆä¼¤å®³å¹¶æä¾›æŠ¤ç›¾", duration: 60000, cooldown: PARTNER_COOLDOWN_BASE, color: "#3b82f6" },
            { id: 'di_feisheng', name: "ç¬›é£å£°", title: "é‡‘é¸³ç›Ÿä¸»", unlockLevel: 6, desc: "æ‚²é£ç™½æ¨ï¼Œå”¯å¿«ä¸ç ´", visual: 'di_feisheng', skillName: "æ‚²é£ç™½æ¨", skillDesc: "é€ æˆ800%æš´å‡»ä¼¤å®³ï¼Œæ— è§†é˜²å¾¡", duration: 45000, cooldown: PARTNER_COOLDOWN_BASE * 1.5, color: "#b91c1c" }
          ]
        };

        const randomInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
        
        // æƒé‡éšæœºé€‰æ‹©å‡½æ•° (ç”¨äºæ‰è½å’Œå•†åº—)
        const getWeightedItem = (items) => {
            if (!items || items.length === 0) return null;
            const totalWeight = items.reduce((sum, item) => sum + (item.dropWeight || 10), 0);
            let random = Math.random() * totalWeight;
            for (const item of items) {
                random -= (item.dropWeight || 10);
                if (random < 0) return item;
            }
            return items[0]; // Fallback
        };
        const randomItem = (arr) => arr[Math.floor(Math.random() * arr.length)]; // ç®€å•éšæœºï¼ˆç”¨äºå¯¹è¯ï¼‰

        // --- Components ---
        const PaperStickman = ({ color = "black", isEnemy = false, slots = {}, isSleeping = false, charVisual = 'hero' }) => {
          const weapon = slots.weapon?.visual;
          const clothes = slots.clothes?.visual;
          const guard = slots.guard?.visual;
          
          return (
            <svg viewBox="0 0 100 150" className={`w-full h-full drop-shadow-md overflow-visible transition-transform duration-500 ${isSleeping ? 'rotate-90 translate-y-10' : ''}`}>
              <g stroke={color} strokeWidth="3" fill="none" strokeLinecap="round" strokeLinejoin="round">
                {isEnemy ? (
                  <>
                      {charVisual === 'é’è¡£' || charVisual === 'è§’ä¸½è°¯' ? (
                        <g stroke="none">
                            <path d="M30 45 L70 45 L80 125 L20 125 Z" fill={charVisual==='è§’ä¸½è°¯'?'#b91c1c':'#d1fae5'} stroke="#333" strokeWidth="1.5" />
                            <circle cx="50" cy="28" r="14" fill="#fce4d4" stroke="#333" strokeWidth="1.5" />
                            <path d="M30 20 L50 40 L70 20 L50 0 Z" fill="#333" /> 
                            <path d="M20 20 Q50 60 80 20" fill="none" stroke="#333" strokeWidth="10" opacity="0.8" /> 
                        </g>
                      ) : (
                        <>
                           <path d="M50 30 L30 60 L70 60 Z" fill="#333" fillOpacity="0.2" />
                           <path d="M50 30 L50 90 L30 140 M50 90 L70 140 M30 60 L70 60" />
                           <circle cx="50" cy="30" r="15" fill={charVisual === 'è’²é€†å·' ? '#7f1d1d' : '#333'} />
                           <path d="M40 25 L60 25" stroke="gold" strokeWidth="2" />
                           <circle cx="42" cy="30" r="2" fill="red" stroke="none" />
                           <circle cx="58" cy="30" r="2" fill="red" stroke="none" />
                           <line x1="20" y1="40" x2="80" y2="30" stroke="#555" strokeWidth="3" />
                        </>
                      )}
                  </>
                ) : (
                  <g stroke="none">
                    {charVisual === 'ye_zheng' ? (
                      <g>
                          <path d="M30 45 L70 45 L75 120 L25 120 Z" fill="#18181b" stroke="#52525b" strokeWidth="1.5" /> 
                          <path d="M20 25 L80 25 L50 10 Z" fill="#3f3f46" stroke="#000" /> 
                          <circle cx="50" cy="35" r="12" fill="#fce4d4" stroke="#333" strokeWidth="1.5" />
                          <path d="M30 50 Q15 65 10 90" stroke="#333" strokeWidth="1" fill="#27272a" /> 
                          <path d="M70 50 Q85 65 90 90" stroke="#333" strokeWidth="1" fill="#27272a" />
                          <g transform="translate(85, 80) rotate(-60)">
                             <rect x="-2" y="-10" width="4" height="60" fill="#e4e4e7" stroke="#000" />
                          </g>
                      </g>
                    ) : charVisual === 'zhang_mo' ? (
                      <g>
                          <path d="M25 45 L75 45 L80 120 L20 120 Z" fill="#78716c" stroke="#44403c" strokeWidth="1.5" /> 
                          <circle cx="50" cy="28" r="15" fill="#fce4d4" stroke="#333" strokeWidth="1.5" />
                          <path d="M35 15 Q50 5 65 15" fill="#44403c" />
                          <path d="M25 50 Q15 60 15 85" stroke="#333" strokeWidth="1" fill="#a8a29e" /> 
                          <path d="M75 50 Q85 60 85 85" stroke="#333" strokeWidth="1" fill="#a8a29e" />
                          <g transform="translate(85, 85) rotate(-20)">
                             <rect x="-2" y="-10" width="4" height="40" fill="#573a2e" />
                             <path d="M-2 5 L-10 0 L-10 20 L-2 15 Z" fill="#9ca3af" stroke="#000" />
                          </g>
                      </g>
                    ) : charVisual === 'pu_nichuan' ? (
                      <g>
                          <path d="M30 45 L70 45 L80 120 L20 120 Z" fill="#450a0a" stroke="#b91c1c" strokeWidth="1.5" /> 
                          <circle cx="50" cy="28" r="14" fill="#991b1b" stroke="#000" strokeWidth="1.5" /> 
                          <circle cx="44" cy="28" r="3" fill="#000" /> 
                          <circle cx="56" cy="28" r="3" fill="#000" />
                          <path d="M45 38 Q50 30 55 38" stroke="#fff" strokeWidth="2" fill="none" /> 
                          <path d="M30 50 Q15 65 10 90" stroke="#333" strokeWidth="1" fill="#7f1d1d" /> 
                          <path d="M70 50 Q85 65 90 90" stroke="#333" strokeWidth="1" fill="#7f1d1d" />
                      </g>
                    ) : charVisual === 'bai_wan' ? (
                      <g>
                          <path d="M35 45 L65 45 L75 125 L25 125 Z" fill="#fff" stroke="#e5e7eb" strokeWidth="1.5" /> 
                          <circle cx="50" cy="28" r="14" fill="#fce4d4" stroke="#333" strokeWidth="1.5" />
                          <path d="M36 20 Q50 5 64 20" fill="none" stroke="#333" strokeWidth="2" />
                          <path d="M35 50 Q20 60 20 85" stroke="#e5e7eb" strokeWidth="1" fill="#fff" />
                          <path d="M65 50 Q80 60 80 85" stroke="#e5e7eb" strokeWidth="1" fill="#fff" />
                      </g>
                    ) : charVisual === 'li_lianhua' ? (
                      <g>
                          <path d="M30 45 L70 45 L80 120 L20 120 Z" fill={clothes==='robe_green'?'#f0fdf4':'#ecfdf5'} stroke="#065f46" strokeWidth="1.5" /> 
                          <circle cx="50" cy="30" r="18" fill="#fce4d4" stroke="#333" strokeWidth="1.5" />
                          <path d="M32 25 Q35 12 50 12 Q65 12 68 25 Q68 18 50 18 Q32 18 32 25" fill="#2d2d2d" />
                          <rect x="40" y="8" width="20" height="4" fill="#10b981" rx="2" />
                          <circle cx="44" cy="30" r="2" fill="#333" />
                          <circle cx="56" cy="30" r="2" fill="#333" />
                          <path d="M48 36 Q50 38 52 36" stroke="#333" strokeWidth="1" fill="none" />
                          <path d="M30 50 Q15 65 10 90" stroke="#333" strokeWidth="1" fill="#d1fae5" /> 
                          <path d="M70 50 Q85 65 90 90" stroke="#333" strokeWidth="1" fill="#d1fae5" />
                          
                          {weapon === 'sword_shaoshi' && (
                            <g transform="translate(85, 95) rotate(-45)">
                               <rect x="-3" y="-15" width="6" height="50" fill="#e2e8f0" stroke="#1e293b" strokeWidth="0.5" />
                               <path d="M0 36 Q5 45 0 55" stroke="blue" strokeWidth="1.5" fill="none" />
                            </g>
                          )}
                          {weapon === 'sword_wenjing' && (
                          <g transform="translate(85, 95) rotate(-30)">
                             <path d="M0 30 Q-10 10 0 -10 Q10 10 0 30" fill="#cbd5e1" stroke="#334155" strokeWidth="0.5" />
                             <rect x="-5" y="25" width="10" height="3" fill="#b91c1c" stroke="#333" strokeWidth="0.5" />
                          </g>
                          )}
                          {guard === 'candy' && (
                             <circle cx="35" cy="80" r="4" fill="#f472b6" stroke="#db2777" />
                          )}
                      </g>
                    ) : (
                      <g>
                        {clothes === 'robe_white' ? (
                           <path d="M35 45 L65 45 L80 125 L20 125 Z" fill="#f8fafc" stroke="#94a3b8" strokeWidth="1.5" /> 
                        ) : clothes === 'robe_gray' ? (
                           <path d="M35 45 L65 45 L75 125 L25 125 Z" fill="#a8a29e" stroke="#57534e" strokeWidth="1.5" /> 
                        ) : (
                           <path d="M35 45 L65 45 L75 125 L25 125 Z" fill="#e0f2fe" stroke="#334155" strokeWidth="1.5" /> 
                        )}
                        <path d="M35 45 L50 75 L65 45" fill="none" stroke="#333" strokeWidth="1" />
                        
                        <circle cx="50" cy="28" r="14" fill="#fce4d4" stroke="#333" strokeWidth="1.5" />
                        <path d="M36 20 Q50 10 64 20 Q64 35 60 45" stroke="#d1d5db" strokeWidth="3" fill="none" />
                        <path d="M36 20 Q30 35 32 45" stroke="#d1d5db" strokeWidth="3" fill="none" />
                        <path d="M36 20 Q50 5 64 20 Q64 15 50 12 Q36 15 36 20" fill="#d1d5db" />
                        <circle cx="50" cy="15" r="5" fill="#d1d5db" />
                        <line x1="42" y1="15" x2="58" y2="15" stroke="#9ca3af" strokeWidth="1" />

                        <path d="M44 29 L48 28" stroke="#333" strokeWidth="1" /> 
                        <path d="M56 28 L52 29" stroke="#333" strokeWidth="1" />
                        <circle cx="45" cy="31" r="1.5" fill="#333" />
                        <circle cx="55" cy="31" r="1.5" fill="#333" />
                        <path d="M48 37 L52 37" stroke="#333" strokeWidth="1" /> 

                        <path d="M35 50 Q20 60 20 85" stroke="#333" strokeWidth="1" fill={clothes==='robe_gray'?'#a8a29e':clothes==='robe_white'?'#f8fafc':'#bfdbfe'} />
                        <path d="M35 60 Q30 70 30 85" stroke="#333" strokeWidth="1" fill={clothes==='robe_gray'?'#a8a29e':clothes==='robe_white'?'#f8fafc':'#bfdbfe'} />
                        <circle cx="25" cy="90" r="3" fill="#fce4d4" stroke="#333" strokeWidth="1" /> 

                        <path d="M65 50 Q80 60 80 85" stroke="#333" strokeWidth="1" fill={clothes==='robe_gray'?'#a8a29e':clothes==='robe_white'?'#f8fafc':'#bfdbfe'} />
                        <path d="M65 60 Q70 70 70 85" stroke="#333" strokeWidth="1" fill={clothes==='robe_gray'?'#a8a29e':clothes==='robe_white'?'#f8fafc':'#bfdbfe'} />
                        <circle cx="75" cy="90" r="3" fill="#fce4d4" stroke="#333" strokeWidth="1" />

                        <circle cx="35" cy="50" r="1.5" fill="#fbbf24" stroke="#b45309" strokeWidth="0.5" />
                        <circle cx="65" cy="50" r="1.5" fill="#fbbf24" stroke="#b45309" strokeWidth="0.5" />

                        {weapon === 'knife' && (
                          <g transform="translate(80, 85) rotate(150)">
                             <rect x="-2" y="0" width="4" height="15" fill="#9ca3af" stroke="#333" strokeWidth="0.5" />
                             <path d="M-2 15 L2 15 L0 25 Z" fill="#9ca3af" stroke="#333" strokeWidth="0.5" />
                             <rect x="-3" y="-5" width="6" height="5" fill="#78350f" />
                          </g>
                        )}
                        {weapon === 'shovel' && (
                          <g transform="translate(85, 95) rotate(-10)">
                             <rect x="-1.5" y="-45" width="3" height="60" fill="#3e2723" stroke="#000" strokeWidth="0.5" /> 
                             <path d="M-8 15 L8 15 L8 35 Q0 38 -8 35 Z" fill="#64748b" stroke="#000" strokeWidth="0.5" /> 
                             <circle cx="0" cy="20" r="2" fill="red" /> 
                          </g>
                        )}
                        {weapon === 'brush' && (
                          <g transform="translate(80, 85) rotate(-30)">
                             <rect x="-1.5" y="-20" width="3" height="30" fill="#3f2c22" stroke="#000" strokeWidth="0.5" />
                             <path d="M-2 10 Q0 20 2 10 Z" fill="#333" />
                          </g>
                        )}
                        {weapon === 'umbrella_rib' && (
                          <g transform="translate(80, 85) rotate(-45)">
                             <rect x="-0.5" y="-10" width="1" height="45" fill="#d1d5db" stroke="#333" strokeWidth="0.5" />
                             <path d="M-1 35 L1 35 L0 45 Z" fill="#d1d5db" /> 
                          </g>
                        )}
                        {weapon === 'scroll' && (
                          <g transform="translate(25, 85) rotate(10)">
                             <rect x="-5" y="-10" width="10" height="25" fill="#fef3c7" stroke="#b45309" strokeWidth="1" />
                             <line x1="-3" y1="-5" x2="3" y2="-5" stroke="#b45309" strokeWidth="0.5" />
                          </g>
                        )}
                        {weapon === 'stick' && (
                           <rect x="80" y="70" width="4" height="40" fill="#a16207" transform="rotate(-30 82 90)" />
                        )}
                        {guard === 'shoes' && (
                           <>
                             <rect x="36" y="125" width="12" height="5" fill="#fcd34d" />
                             <rect x="54" y="125" width="12" height="5" fill="#fcd34d" />
                           </>
                        )}
                        {guard === 'bracer' && (
                           <rect x="20" y="75" width="10" height="8" fill="#573a2e" opacity="0.8" transform="rotate(-10 25 79)" />
                        )}
                        {guard === 'jade' && (
                           <circle cx="35" cy="75" r="3" fill="#86efac" stroke="#166534" strokeWidth="1" />
                        )}
                      </g>
                    )}
                    
                    {isSleeping && (
                       <g className="animate-pulse opacity-70">
                          <text x="65" y="15" fontSize="14" fill="blue" stroke="none">...</text>
                       </g>
                    )}
                  </g>
                )}
              </g>
            </svg>
          );
        };

        // --- è¡¨æƒ…åŒ…å±•ç¤ºç»„ä»¶ (ä½ç½®è°ƒæ•´ï¼šä½¿ç”¨ pt è€Œé pb å®šä½) ---
        const MemeOverlay = ({ meme }) => {
            if (!meme) return null;
            
            // ç®€å•çš„ç±»å‹åˆ¤æ–­ (å›é€€é€»è¾‘)
            const hasImage = meme.type === 'image' && meme.content;
            const hasText = meme.type === 'text' && meme.content;
            
            if (!hasImage && !hasText) return null;

            // æ ¹æ®æ¥æºè®¾å®šå¯¹é½æ–¹å¼
            // ä½¿ç”¨ justify-start/end åŒºåˆ†å·¦å³
            // ä½¿ç”¨ pt-[30vh] è®¾å®šè·ç¦»é¡¶éƒ¨çš„è·ç¦»ï¼Œè¿™æ ·æ¯” items-end æ›´ç¨³å®šï¼Œä¸éšå±å¹•é«˜åº¦å‰§çƒˆå˜åŒ–
            let positionClasses = "justify-center";
            let containerClasses = "";
            
            if (meme.source === 'enemy') {
                positionClasses = "justify-end pr-[15%] md:pr-[25%]"; 
                containerClasses = "items-end"; // å†…å®¹å³å¯¹é½
            } else if (meme.source === 'player') {
                positionClasses = "justify-start pl-[20%] md:pl-[25%]";
                containerClasses = "items-start"; // å†…å®¹å·¦å¯¹é½
            }

            return (
                <div className={`absolute inset-0 z-50 flex items-start ${positionClasses} pointer-events-none overflow-hidden pt-[30vh]`}>
                    <div className={`animate-meme transform origin-center flex flex-col gap-2 ${containerClasses}`}>
                        {hasImage && (
                            <div className="relative">
                                <img src={meme.content} alt="Meme" className="max-w-[180px] max-h-[180px] rounded-lg shadow-2xl border-4 border-white transform rotate-3" />
                                <div className="absolute inset-0 border-4 border-black/10 rounded-lg"></div>
                            </div>
                        )}
                        {hasText && (
                            <div className="bg-white/95 text-black px-5 py-3 rounded-2xl border-4 border-black shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] text-xl font-black tracking-widest min-w-[150px] max-w-[250px] text-center whitespace-pre-wrap transform -rotate-1">
                                {meme.content}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // --- ç®¡ç†é¢æ¿ç»„ä»¶ ---
        const AdminPanel = ({ customData, setCustomData, onClose }) => {
            const [tab, setTab] = useState('characters');
            const [selectedEnemy, setSelectedEnemy] = useState('default');
            const [selectedProtagonist, setSelectedProtagonist] = useState('xie_huaian'); 
            
            const allEnemies = Array.from(new Set([
                'default',
                ...INITIAL_ENEMIES_LIST,
                ...Object.keys(customData.dialogues.enemies || {})
            ]));

            useEffect(() => {
                if (tab.includes('enemy')) {
                    const enemyDialogues = customData.dialogues.enemies[selectedEnemy];
                    const enemyMemes = customData.memes.enemies[selectedEnemy];

                    if (!enemyDialogues || !enemyMemes) {
                        setCustomData(prev => ({
                            ...prev,
                            dialogues: {
                                ...prev.dialogues,
                                enemies: {
                                    ...prev.dialogues.enemies,
                                    [selectedEnemy]: prev.dialogues.enemies[selectedEnemy] || { intro: [], attack: [], hit: [] }
                                }
                            },
                            memes: {
                                ...prev.memes,
                                enemies: {
                                    ...prev.memes.enemies,
                                    [selectedEnemy]: prev.memes.enemies[selectedEnemy] || { 
                                        crit: { type: 'text', content: '', enabled: false },
                                        dodge: { type: 'text', content: '', enabled: false },
                                        beaten: { type: 'text', content: '', enabled: false }
                                    }
                                }
                            }
                        }));
                    }
                }
            }, [selectedEnemy, tab, customData]);

            const handleCharChange = (idx, field, value) => {
                const newChars = [...customData.characters];
                newChars[idx] = { ...newChars[idx], [field]: value };
                setCustomData({ ...customData, characters: newChars });
            };

            const handlePlayerDialogueChange = (type, index, value) => {
                const newDialogues = { ...customData.dialogues };
                newDialogues[selectedProtagonist][type][index] = value;
                setCustomData({ ...customData, dialogues: newDialogues });
            };

            const handleEnemyDialogueChange = (type, index, value) => {
                const newDialogues = { ...customData.dialogues };
                if (!newDialogues.enemies[selectedEnemy]) return; 
                newDialogues.enemies[selectedEnemy][type][index] = value;
                setCustomData({ ...customData, dialogues: newDialogues });
            };

            const addDialogue = (target, type) => {
                const newDialogues = { ...customData.dialogues };
                if (target === 'player') {
                    newDialogues[selectedProtagonist][type].push("æ–°å°è¯...");
                } else {
                    if (!newDialogues.enemies[selectedEnemy][type]) newDialogues.enemies[selectedEnemy][type] = [];
                    newDialogues.enemies[selectedEnemy][type].push("æ–°å°è¯...");
                }
                setCustomData({ ...customData, dialogues: newDialogues });
            };

            const removeDialogue = (target, type, index) => {
                const newDialogues = { ...customData.dialogues };
                if (target === 'player') {
                    newDialogues[selectedProtagonist][type].splice(index, 1);
                } else {
                    newDialogues.enemies[selectedEnemy][type].splice(index, 1);
                }
                setCustomData({ ...customData, dialogues: newDialogues });
            };
            
            const handlePlayerMemeChange = (key, field, value) => {
                const newMemes = { ...customData.memes };
                newMemes[selectedProtagonist][key] = { ...newMemes[selectedProtagonist][key], [field]: value };
                setCustomData({ ...customData, memes: newMemes });
            };

            const handleEnemyMemeChange = (key, field, value) => {
                setCustomData(prev => {
                    const enemiesMemes = prev.memes.enemies[selectedEnemy] 
                        ? { ...prev.memes.enemies } 
                        : { ...prev.memes.enemies, [selectedEnemy]: { ...DEFAULT_MEMES.enemies.default } };
                    
                    return {
                        ...prev,
                        memes: {
                            ...prev.memes,
                            enemies: {
                                ...enemiesMemes,
                                [selectedEnemy]: {
                                    ...enemiesMemes[selectedEnemy],
                                    [key]: {
                                        ...enemiesMemes[selectedEnemy][key],
                                        [field]: value
                                    }
                                }
                            }
                        }
                    };
                });
            };

            // æ–°å¢ï¼šè£…å¤‡ç®¡ç†é€»è¾‘
            const handleEquipmentChange = (idx, field, value) => {
                setCustomData(prev => {
                    // å®‰å…¨è®¿é—®
                    const currentList = prev.equipment?.[selectedProtagonist] || [];
                    const newEquipment = [...currentList];
                    if (newEquipment[idx]) {
                        newEquipment[idx] = { ...newEquipment[idx], [field]: value };
                    }
                    return { ...prev, equipment: { ...prev.equipment, [selectedProtagonist]: newEquipment } };
                });
            };

            const addEquipment = () => {
                setCustomData(prev => {
                    // å®‰å…¨è®¿é—®
                    const currentList = prev.equipment?.[selectedProtagonist] || [];
                    const newEquip = { 
                        id: Date.now().toString(), 
                        name: "æ–°è£…å¤‡", 
                        type: "weapon", 
                        visual: "sword", 
                        atk: 10, hp: 0, rarity: 1, 
                        price: 100, 
                        dropWeight: 50, 
                        desc: "ä¸€ä»¶ç¥ç§˜çš„è£…å¤‡" 
                    };
                    return { ...prev, equipment: { ...prev.equipment, [selectedProtagonist]: [...currentList, newEquip] } };
                });
            };

            const deleteEquipment = (idx) => {
                if (confirm("ç¡®å®šåˆ é™¤è¿™ä»¶è£…å¤‡å—ï¼Ÿ")) {
                    setCustomData(prev => {
                        const currentList = prev.equipment?.[selectedProtagonist] || [];
                        const newEquipment = [...currentList];
                        newEquipment.splice(idx, 1);
                        return { ...prev, equipment: { ...prev.equipment, [selectedProtagonist]: newEquipment } };
                    });
                }
            };

            const handleFileUpload = (e, callback) => {
                const file = e.target.files[0];
                if (!file) return;
                
                if (file.size > 1024 * 1024) {
                    alert("å›¾ç‰‡å¤ªå¤§ï¼è¯·ä¸Šä¼ å°äº 1MB çš„å›¾ç‰‡ã€‚");
                    return;
                }

                const reader = new FileReader();
                reader.onload = (event) => {
                    callback(event.target.result);
                };
                reader.readAsDataURL(file);
            };

            // åˆ†äº«åŠŸèƒ½ (å‘å¸ƒåˆ°å…¨æœ)
            const handleShare = async () => {
                if (!db) {
                    alert("æ— æ³•è¿æ¥äº‘ç«¯ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–é…ç½®");
                    return;
                }
                if (!auth.currentUser) {
                    alert("æœªç™»å½•ï¼Œæ— æ³•å‘å¸ƒ");
                    return;
                }
                if (confirm("ç¡®å®šè¦å‘å¸ƒå½“å‰é…ç½®åˆ°å…¨æœå—ï¼Ÿæ‰€æœ‰åœ¨çº¿ç©å®¶å°†ç«‹å³åŒæ­¥ã€‚")) {
                    try {
                        await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'game_configs', GLOBAL_CONFIG_ID), customData);
                        alert("ğŸš€ å‘å¸ƒæˆåŠŸï¼å…¨æœå·²åŒæ­¥ã€‚");
                    } catch (e) {
                        console.error(e);
                        alert("å‘å¸ƒå¤±è´¥: " + e.message);
                    }
                }
            };

            const handleAddEnemy = () => {
                const name = prompt("è¯·è¾“å…¥æ–°æ•Œäººçš„åå­—ï¼š");
                if (!name) return;
                
                if (allEnemies.includes(name)) {
                    alert("è¯¥æ•Œäººå·²å­˜åœ¨åˆ—è¡¨ä¸­ï¼");
                    setSelectedEnemy(name);
                    return;
                }

                setCustomData(prev => ({
                    ...prev,
                    dialogues: {
                        ...prev.dialogues,
                        enemies: {
                            ...prev.dialogues.enemies,
                            [name]: { intro: ["..."], attack: ["..."], hit: ["..."] }
                        }
                    },
                    memes: {
                        ...prev.memes,
                        enemies: {
                            ...prev.memes.enemies,
                            [name]: { 
                                crit: { type: 'text', content: 'ç—›å—ï¼Ÿ', enabled: true },
                                dodge: { type: 'text', content: 'æ‰“ä¸ç€', enabled: true },
                                beaten: { type: 'text', content: 'åˆ«æ‰“äº†', enabled: true }
                            }
                        }
                    }
                }));
                setSelectedEnemy(name);
            };

            const resetData = () => {
                if(confirm("ç¡®å®šè¦é‡ç½®æ‰€æœ‰é…ç½®ä¸ºé»˜è®¤å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚")) {
                    setCustomData({ characters: DEFAULT_CHARACTERS_DATA, dialogues: DEFAULT_DIALOGUES, memes: DEFAULT_MEMES, equipment: DEFAULT_EQUIPMENT });
                    localStorage.removeItem('paper_duel_custom_data_v7');
                }
            };

            return (
                <div className="absolute inset-0 z-[100] bg-black/90 flex items-center justify-center backdrop-blur-md p-4 animate-pop-in text-[#e6dcca] font-serif">
                    <div className="bg-[#2a231d] w-full max-w-4xl h-[90vh] border-4 border-[#d4af37] shadow-2xl rounded-lg flex flex-col overflow-hidden relative">
                         <div className="p-4 border-b border-[#5d4d3d] flex justify-between items-center bg-[#3e342b]">
                             <h2 className="text-xl font-bold text-[#d4af37] flex items-center gap-2"><Settings size={20}/> æ±Ÿæ¹–å¤©é“ (åå°ç®¡ç†)</h2>
                             <div className="flex gap-2">
                                <button onClick={handleShare} className="px-3 py-1 bg-blue-600 border border-blue-400 rounded text-xs hover:bg-blue-500 flex items-center gap-1 text-white"><Share2 size={12}/> å…¨æœå‘å¸ƒ</button>
                                <button onClick={resetData} className="px-3 py-1 bg-red-900 border border-red-700 rounded text-xs hover:bg-red-700 flex items-center gap-1"><RefreshCw size={12}/> é‡ç½®é»˜è®¤</button>
                                <button onClick={onClose} className="px-3 py-1 bg-[#57534e] border border-[#a89f91] rounded text-xs hover:bg-[#a89f91] text-white">å…³é—­ / ä¿å­˜</button>
                             </div>
                         </div>
                         
                         <div className="flex flex-wrap border-b border-[#5d4d3d] text-xs">
                             <button onClick={() => setTab('characters')} className={`flex-1 py-3 px-2 font-bold transition-colors whitespace-nowrap ${tab==='characters'?'bg-[#d4af37] text-[#2a231d]':'bg-[#2a231d] text-[#888] hover:text-[#d6d3cd]'}`}>è§’è‰²è®¾å®š</button>
                             <button onClick={() => setTab('equipment')} className={`flex-1 py-3 px-2 font-bold transition-colors whitespace-nowrap ${tab==='equipment'?'bg-[#d4af37] text-[#2a231d]':'bg-[#2a231d] text-[#888] hover:text-[#d6d3cd]'}`}>ç¥å…µå®åº“</button>
                             <button onClick={() => setTab('dialogues_player')} className={`flex-1 py-3 px-2 font-bold transition-colors whitespace-nowrap ${tab==='dialogues_player'?'bg-[#d4af37] text-[#2a231d]':'bg-[#2a231d] text-[#888] hover:text-[#d6d3cd]'}`}>ä¸»è§’å°è¯</button>
                             <button onClick={() => setTab('memes_player')} className={`flex-1 py-3 px-2 font-bold transition-colors whitespace-nowrap ${tab==='memes_player'?'bg-[#d4af37] text-[#2a231d]':'bg-[#2a231d] text-[#888] hover:text-[#d6d3cd]'}`}>ä¸»è§’è¡¨æƒ…åŒ…</button>
                             <button onClick={() => setTab('dialogues_enemy')} className={`flex-1 py-3 px-2 font-bold transition-colors whitespace-nowrap ${tab==='dialogues_enemy'?'bg-[#b91c1c] text-[#e6dcca]':'bg-[#2a231d] text-[#888] hover:text-[#b91c1c]'}`}>æ•Œäººå°è¯</button>
                             <button onClick={() => setTab('memes_enemy')} className={`flex-1 py-3 px-2 font-bold transition-colors whitespace-nowrap ${tab==='memes_enemy'?'bg-[#b91c1c] text-[#e6dcca]':'bg-[#2a231d] text-[#888] hover:text-[#b91c1c]'}`}>æ•Œäººè¡¨æƒ…åŒ…</button>
                         </div>

                         <div className="flex-1 overflow-y-auto p-6 custom-scrollbar bg-[#1c1917]">
                             {tab === 'characters' && (
                                 <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                     {customData.characters.map((char, idx) => (
                                         <div key={idx} className="bg-[#2a231d] p-4 rounded border border-[#5d4d3d]">
                                             <h3 className="font-bold text-[#fbbf24] mb-3 border-b border-[#5d4d3d] pb-1">è§’è‰²: {char.id === 'xie_huaian' ? 'è°¢æ·®å®‰' : 'æè²èŠ±'}</h3>
                                             <div className="space-y-3">
                                                 <div>
                                                     <label className="text-xs text-[#888]">æ˜¾ç¤ºåç§°</label>
                                                     <input type="text" value={char.name} onChange={(e) => handleCharChange(idx, 'name', e.target.value)} className="w-full bg-[#1c1917] border border-[#5d4d3d] rounded p-2 text-[#e6dcca] mt-1" />
                                                 </div>
                                                 <div>
                                                     <label className="text-xs text-[#888]">çœŸå/ç§°å·</label>
                                                     <input type="text" value={char.realName} onChange={(e) => handleCharChange(idx, 'realName', e.target.value)} className="w-full bg-[#1c1917] border border-[#5d4d3d] rounded p-2 text-[#e6dcca] mt-1" />
                                                 </div>
                                                 <div>
                                                     <label className="text-xs text-[#888]">äººç‰©æè¿°</label>
                                                     <textarea value={char.desc} onChange={(e) => handleCharChange(idx, 'desc', e.target.value)} className="w-full bg-[#1c1917] border border-[#5d4d3d] rounded p-2 text-[#e6dcca] mt-1 h-20 resize-none" />
                                                 </div>
                                             </div>
                                         </div>
                                     ))}
                                 </div>
                             )}

                             {tab === 'equipment' && (
                                 <div className="space-y-4">
                                     <div className="flex gap-2 mb-4 bg-[#3e342b] p-2 rounded">
                                        <button onClick={() => setSelectedProtagonist('xie_huaian')} className={`flex-1 py-1 rounded transition-colors ${selectedProtagonist === 'xie_huaian' ? 'bg-[#d4af37] text-black font-bold' : 'text-[#888]'}`}>è°¢æ·®å®‰çš„è£…å¤‡</button>
                                        <button onClick={() => setSelectedProtagonist('li_lianhua')} className={`flex-1 py-1 rounded transition-colors ${selectedProtagonist === 'li_lianhua' ? 'bg-[#d4af37] text-black font-bold' : 'text-[#888]'}`}>æè²èŠ±çš„è£…å¤‡</button>
                                     </div>
                                     
                                     <button onClick={addEquipment} className="w-full py-2 bg-[#b45309] text-white font-bold rounded hover:bg-[#92400e] flex items-center justify-center gap-2"><Plus size={16}/> æ·»åŠ æ–°è£…å¤‡</button>

                                     <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                         {/* ä½¿ç”¨å¯é€‰é“¾å’Œé»˜è®¤ç©ºæ•°ç»„é˜²æ­¢æŠ¥é”™ */}
                                         {(customData.equipment?.[selectedProtagonist] || []).map((item, idx) => (
                                             <div key={item.id || idx} className="bg-[#2a231d] p-3 rounded border border-[#5d4d3d] relative group">
                                                 <button onClick={() => deleteEquipment(idx)} className="absolute top-2 right-2 text-red-500 hover:text-red-300 opacity-50 group-hover:opacity-100 transition-opacity"><Trash2 size={16}/></button>
                                                 <div className="grid grid-cols-2 gap-2 mb-2">
                                                     <div><label className="text-[10px] text-[#888]">åç§°</label><input type="text" value={item.name} onChange={(e) => handleEquipmentChange(idx, 'name', e.target.value)} className="w-full bg-[#1c1917] border border-[#5d4d3d] rounded px-1 py-0.5 text-xs text-[#e6dcca]" /></div>
                                                     <div>
                                                         <label className="text-[10px] text-[#888]">ç±»å‹</label>
                                                         <select value={item.type} onChange={(e) => handleEquipmentChange(idx, 'type', e.target.value)} className="w-full bg-[#1c1917] border border-[#5d4d3d] rounded px-1 py-0.5 text-xs text-[#e6dcca]">
                                                             <option value="weapon">æ­¦å™¨</option><option value="clothes">è¡£æœ</option><option value="guard">æŠ¤å…·</option><option value="consumable">æ¶ˆè€—å“</option>
                                                         </select>
                                                     </div>
                                                 </div>
                                                 <div className="grid grid-cols-4 gap-2 mb-2">
                                                     <div><label className="text-[10px] text-red-400">æ”»</label><input type="number" value={item.atk||0} onChange={(e) => handleEquipmentChange(idx, 'atk', parseInt(e.target.value))} className="w-full bg-[#1c1917] border border-[#5d4d3d] rounded px-1 py-0.5 text-xs text-[#e6dcca]" /></div>
                                                     <div><label className="text-[10px] text-green-400">è¡€</label><input type="number" value={item.hp||0} onChange={(e) => handleEquipmentChange(idx, 'hp', parseInt(e.target.value))} className="w-full bg-[#1c1917] border border-[#5d4d3d] rounded px-1 py-0.5 text-xs text-[#e6dcca]" /></div>
                                                     <div><label className="text-[10px] text-orange-400">æš´</label><input type="number" value={item.crit||0} onChange={(e) => handleEquipmentChange(idx, 'crit', parseInt(e.target.value))} className="w-full bg-[#1c1917] border border-[#5d4d3d] rounded px-1 py-0.5 text-xs text-[#e6dcca]" /></div>
                                                     <div><label className="text-[10px] text-blue-400">å›</label><input type="number" value={item.heal||0} onChange={(e) => handleEquipmentChange(idx, 'heal', parseInt(e.target.value))} className="w-full bg-[#1c1917] border border-[#5d4d3d] rounded px-1 py-0.5 text-xs text-[#e6dcca]" /></div>
                                                 </div>
                                                 <div className="grid grid-cols-2 gap-2 mb-2">
                                                     <div><label className="text-[10px] text-[#fbbf24]">ä»·æ ¼</label><input type="number" value={item.price} onChange={(e) => handleEquipmentChange(idx, 'price', parseInt(e.target.value))} className="w-full bg-[#1c1917] border border-[#5d4d3d] rounded px-1 py-0.5 text-xs text-[#e6dcca]" /></div>
                                                     <div><label className="text-[10px] text-purple-400" title="æ‰è½æƒé‡ï¼šè¶Šé«˜è¶Šå®¹æ˜“æ‰">æ‰è½æƒé‡</label><input type="number" value={item.dropWeight || (item.rarity===2?5:50)} onChange={(e) => handleEquipmentChange(idx, 'dropWeight', parseInt(e.target.value))} className="w-full bg-[#1c1917] border border-[#5d4d3d] rounded px-1 py-0.5 text-xs text-[#e6dcca]" /></div>
                                                 </div>
                                                 <div><label className="text-[10px] text-[#888]">æè¿°</label><input type="text" value={item.desc} onChange={(e) => handleEquipmentChange(idx, 'desc', e.target.value)} className="w-full bg-[#1c1917] border border-[#5d4d3d] rounded px-1 py-0.5 text-xs text-[#e6dcca]" /></div>
                                             </div>
                                         ))}
                                     </div>
                                 </div>
                             )}

                             {(tab === 'dialogues_player' || tab === 'memes_player') && (
                                <div className="space-y-4">
                                    <div className="flex gap-2 mb-4 bg-[#3e342b] p-2 rounded">
                                        <button onClick={() => setSelectedProtagonist('xie_huaian')} className={`flex-1 py-1 rounded transition-colors ${selectedProtagonist === 'xie_huaian' ? 'bg-[#d4af37] text-black font-bold' : 'text-[#888]'}`}>è°¢æ·®å®‰</button>
                                        <button onClick={() => setSelectedProtagonist('li_lianhua')} className={`flex-1 py-1 rounded transition-colors ${selectedProtagonist === 'li_lianhua' ? 'bg-[#d4af37] text-black font-bold' : 'text-[#888]'}`}>æè²èŠ±</button>
                                    </div>

                                    {tab === 'dialogues_player' && (
                                        <div className="space-y-6">
                                            {['attack', 'hit', 'win'].map((type) => (
                                                <div key={type} className="bg-[#2a231d] p-4 rounded border border-[#5d4d3d]">
                                                    <div className="flex justify-between items-center mb-3 border-b border-[#5d4d3d] pb-1">
                                                        <h3 className="font-bold text-[#fbbf24] capitalize">{type === 'attack' ? 'æ”»å‡»è¯­éŸ³' : type === 'hit' ? 'å—å‡»è¯­éŸ³' : 'èƒœåˆ©è¯­éŸ³'}</h3>
                                                        <button onClick={() => addDialogue('player', type)} className="text-xs bg-[#15803d] px-2 py-1 rounded text-white hover:bg-[#166534]">+ æ–°å¢</button>
                                                    </div>
                                                    <div className="space-y-2">
                                                        {customData.dialogues[selectedProtagonist] && customData.dialogues[selectedProtagonist][type].map((line, idx) => (
                                                            <div key={idx} className="flex gap-2">
                                                                <input type="text" value={line} onChange={(e) => handlePlayerDialogueChange(type, idx, e.target.value)} className="flex-1 bg-[#1c1917] border border-[#5d4d3d] rounded p-2 text-[#e6dcca]" />
                                                                <button onClick={() => removeDialogue('player', type, idx)} className="px-3 bg-red-900/50 hover:bg-red-900 border border-red-900 rounded text-red-200"><X size={14}/></button>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    )}

                                    {tab === 'memes_player' && (
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                            {['crit', 'dodge', 'beaten', 'win'].map((subKey) => {
                                                const config = customData.memes[selectedProtagonist] ? customData.memes[selectedProtagonist][subKey] : null;
                                                if (!config) return null;
                                                return (
                                                <div key={subKey} className="bg-[#2a231d] p-4 rounded border border-[#5d4d3d]">
                                                    <div className="flex justify-between items-center mb-3 border-b border-[#5d4d3d] pb-1">
                                                        <h3 className="font-bold text-[#e6dcca] text-sm">{subKey === 'crit' ? 'æš´å‡»æ—¶åˆ»' : subKey === 'dodge' ? 'é—ªé¿æ—¶åˆ»' : subKey === 'win' ? 'èƒœåˆ©æ—¶åˆ»' : 'æ®‹è¡€å—å‡»'}</h3>
                                                        <label className="flex items-center gap-2 cursor-pointer">
                                                            <input type="checkbox" checked={config.enabled} onChange={(e) => handlePlayerMemeChange(subKey, 'enabled', e.target.checked)} className="rounded border-gray-600 bg-[#1c1917] text-[#d4af37] focus:ring-[#d4af37]" />
                                                            <span className="text-xs text-[#888]">å¯ç”¨</span>
                                                        </label>
                                                    </div>
                                                    <div className="space-y-3 opacity-90">
                                                        <div className="flex gap-4 mb-2">
                                                            <label className="flex items-center gap-2 cursor-pointer">
                                                                <input type="radio" name={`type-player-${selectedProtagonist}-${subKey}`} checked={config.type === 'text'} onChange={() => handlePlayerMemeChange(subKey, 'type', 'text')} className="text-[#d4af37]" />
                                                                <span className="text-sm text-[#888]">æ–‡å­—</span>
                                                            </label>
                                                            <label className="flex items-center gap-2 cursor-pointer">
                                                                <input type="radio" name={`type-player-${selectedProtagonist}-${subKey}`} checked={config.type === 'image'} onChange={() => handlePlayerMemeChange(subKey, 'type', 'image')} className="text-[#d4af37]" />
                                                                <span className="text-sm text-[#888]">å›¾ç‰‡</span>
                                                            </label>
                                                        </div>
                                                        <div>
                                                            <input type="text" value={config.content} onChange={(e) => handlePlayerMemeChange(subKey, 'content', e.target.value)} className="w-full bg-[#1c1917] border border-[#5d4d3d] rounded p-2 text-[#e6dcca] mt-1 text-sm" placeholder={config.type==='image'?'å›¾ç‰‡åœ°å€æˆ–ä¸Šä¼ ...':'è¾“å…¥æ–‡å­—...'} />
                                                            {config.type === 'image' && (
                                                                <div className="flex gap-2 mt-2">
                                                                    <label className="flex-1 flex items-center justify-center gap-2 bg-[#3e342b] hover:bg-[#57534e] text-xs py-2 px-3 rounded cursor-pointer border border-[#5d4d3d] transition-colors">
                                                                        <Upload size={14}/> ä¸Šä¼ 
                                                                        <input type="file" accept="image/*" className="hidden" onChange={(e) => handleFileUpload(e, (val) => handlePlayerMemeChange(subKey, 'content', val))} />
                                                                    </label>
                                                                    {config.content && (
                                                                        <button onClick={() => handlePlayerMemeChange(subKey, 'content', '')} className="bg-red-900/50 hover:bg-red-900 border border-red-800 text-red-200 px-3 rounded flex items-center justify-center" title="æ¸…é™¤å›¾ç‰‡">
                                                                            <Trash2 size={14}/>
                                                                        </button>
                                                                    )}
                                                                </div>
                                                            )}
                                                        </div>
                                                        <div className="mt-2 bg-[#1c1917] p-2 rounded border border-[#5d4d3d] border-dashed flex items-center justify-center min-h-[60px]">
                                                            {config.type === 'image' && config.content ? (
                                                                <img src={config.content} alt="Preview" className="max-h-20 object-contain" onError={(e) => e.target.style.display='none'} />
                                                            ) : (
                                                                <span className="text-sm font-bold text-[#e6dcca]">{config.content || "é¢„è§ˆ"}</span>
                                                            )}
                                                        </div>
                                                    </div>
                                                </div>
                                            )})}
                                        </div>
                                    )}
                                </div>
                             )}

                             {(tab === 'dialogues_enemy' || tab === 'memes_enemy') && (
                                 <div className="space-y-4">
                                     <div className="bg-[#3e342b] p-3 rounded border border-[#b91c1c] flex flex-col md:flex-row items-center gap-4">
                                         <div className="flex-1 w-full flex items-center gap-2">
                                             <label className="font-bold text-[#e6dcca] whitespace-nowrap">é€‰æ‹©æ•Œäºº:</label>
                                             <select 
                                                value={selectedEnemy} 
                                                onChange={(e) => setSelectedEnemy(e.target.value)}
                                                className="bg-[#1c1917] text-[#e6dcca] p-2 rounded border border-[#5d4d3d] outline-none focus:border-[#b91c1c] flex-1"
                                             >
                                                 {allEnemies.map(name => (
                                                     <option key={name} value={name}>{name === 'default' ? '== é»˜è®¤é…ç½® (é€šç”¨) ==' : name}</option>
                                                 ))}
                                             </select>
                                         </div>
                                         <button onClick={handleAddEnemy} className="bg-[#b91c1c] hover:bg-[#991b1b] text-white px-3 py-2 rounded text-xs font-bold flex items-center gap-1 whitespace-nowrap">
                                             <Plus size={14}/> æ–°å¢æ•Œäºº
                                         </button>
                                     </div>

                                     {tab === 'dialogues_enemy' && (
                                         <div className="space-y-6">
                                             {['intro', 'attack', 'hit'].map((type) => (
                                                 <div key={type} className="bg-[#2a231d] p-4 rounded border border-[#5d4d3d]">
                                                     <div className="flex justify-between items-center mb-3 border-b border-[#5d4d3d] pb-1">
                                                         <h3 className="font-bold text-[#b91c1c] capitalize">{type === 'intro' ? 'å¼€åœºç™½' : type === 'attack' ? 'æ”»å‡»è¯­éŸ³' : 'å—å‡»è¯­éŸ³'}</h3>
                                                         <button onClick={() => addDialogue('enemy', type)} className="text-xs bg-[#15803d] px-2 py-1 rounded text-white hover:bg-[#166534]">+ æ–°å¢</button>
                                                     </div>
                                                     <div className="space-y-2">
                                                         {customData.dialogues.enemies[selectedEnemy] && customData.dialogues.enemies[selectedEnemy][type] ? (
                                                             customData.dialogues.enemies[selectedEnemy][type].map((line, idx) => (
                                                                 <div key={idx} className="flex gap-2">
                                                                     <input type="text" value={line} onChange={(e) => handleEnemyDialogueChange(type, idx, e.target.value)} className="flex-1 bg-[#1c1917] border border-[#5d4d3d] rounded p-2 text-[#e6dcca]" />
                                                                     <button onClick={() => removeDialogue('enemy', type, idx)} className="px-3 bg-red-900/50 hover:bg-red-900 border border-red-900 rounded text-red-200"><X size={14}/></button>
                                                                 </div>
                                                             ))
                                                         ) : <div className="text-sm text-gray-500">è¯¥æ•Œäººæš‚æ— é…ç½®ï¼Œå°†ä½¿ç”¨é»˜è®¤é…ç½®ã€‚ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æ–°å¢ä»¥è¦†ç›–é»˜è®¤ã€‚</div>}
                                                     </div>
                                                 </div>
                                             ))}
                                         </div>
                                     )}

                                     {tab === 'memes_enemy' && (
                                         <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                             {['crit', 'dodge', 'beaten'].map((subKey) => {
                                                 const config = customData.memes.enemies[selectedEnemy] ? customData.memes.enemies[selectedEnemy][subKey] : null;
                                                 if (!config) return <div key={subKey} className="text-gray-500 text-sm p-4">åŠ è½½ä¸­æˆ–åˆå§‹åŒ–é…ç½®...</div>;
                                                 return (
                                                 <div key={subKey} className="bg-[#2a231d] p-4 rounded border border-[#5d4d3d]">
                                                     <div className="flex justify-between items-center mb-3 border-b border-[#5d4d3d] pb-1">
                                                         <h3 className="font-bold text-[#e6dcca] text-sm">{subKey === 'crit' ? 'æ•Œäººæš´å‡»' : subKey === 'dodge' ? 'æ•Œäººé—ªé¿' : 'æ•Œäººå—å‡»'}</h3>
                                                         <label className="flex items-center gap-2 cursor-pointer">
                                                             <input type="checkbox" checked={config.enabled} onChange={(e) => handleEnemyMemeChange(subKey, 'enabled', e.target.checked)} className="rounded border-gray-600 bg-[#1c1917] text-[#d4af37] focus:ring-[#d4af37]" />
                                                             <span className="text-xs text-[#888]">å¯ç”¨</span>
                                                         </label>
                                                     </div>
                                                     <div className="space-y-3 opacity-90">
                                                         <div className="flex gap-4 mb-2">
                                                             <label className="flex items-center gap-2 cursor-pointer">
                                                                 <input type="radio" name={`type-enemy-${subKey}`} checked={config.type === 'text'} onChange={() => handleEnemyMemeChange(subKey, 'type', 'text')} className="text-[#d4af37]" />
                                                                 <span className="text-sm text-[#888]">æ–‡å­—</span>
                                                             </label>
                                                             <label className="flex items-center gap-2 cursor-pointer">
                                                                 <input type="radio" name={`type-enemy-${subKey}`} checked={config.type === 'image'} onChange={() => handleEnemyMemeChange(subKey, 'type', 'image')} className="text-[#d4af37]" />
                                                                 <span className="text-sm text-[#888]">å›¾ç‰‡</span>
                                                             </label>
                                                         </div>
                                                         <div>
                                                             <input type="text" value={config.content} onChange={(e) => handleEnemyMemeChange(subKey, 'content', e.target.value)} className="w-full bg-[#1c1917] border border-[#5d4d3d] rounded p-2 text-[#e6dcca] mt-1 text-sm" placeholder={config.type==='image'?'å›¾ç‰‡åœ°å€æˆ–ä¸Šä¼ ...':'è¾“å…¥æ–‡å­—...'} />
                                                             {config.type === 'image' && (
                                                                <div className="flex gap-2 mt-2">
                                                                    <label className="flex-1 flex items-center justify-center gap-2 bg-[#3e342b] hover:bg-[#57534e] text-xs py-2 px-3 rounded cursor-pointer border border-[#5d4d3d] transition-colors">
                                                                        <Upload size={14}/> ä¸Šä¼ 
                                                                        <input type="file" accept="image/*" className="hidden" onChange={(e) => handleFileUpload(e, (val) => handleEnemyMemeChange(subKey, 'content', val))} />
                                                                    </label>
                                                                    {config.content && (
                                                                        <button onClick={() => handleEnemyMemeChange(subKey, 'content', '')} className="bg-red-900/50 hover:bg-red-900 border border-red-800 text-red-200 px-3 rounded flex items-center justify-center" title="æ¸…é™¤å›¾ç‰‡">
                                                                            <Trash2 size={14}/>
                                                                        </button>
                                                                    )}
                                                                </div>
                                                            )}
                                                         </div>
                                                         <div className="mt-2 bg-[#1c1917] p-2 rounded border border-[#5d4d3d] border-dashed flex items-center justify-center min-h-[60px]">
                                                             {config.type === 'image' && config.content ? (
                                                                 <img src={config.content} alt="Preview" className="max-h-20 object-contain" onError={(e) => e.target.style.display='none'} />
                                                             ) : (
                                                                 <span className="text-sm font-bold text-[#e6dcca]">{config.content || "é¢„è§ˆ"}</span>
                                                             )}
                                                         </div>
                                                     </div>
                                                 </div>
                                             )})}
                                         </div>
                                     )}
                                 </div>
                             )}
                         </div>
                    </div>
                </div>
            );
        };

        const PasswordModal = ({ onClose, onSuccess }) => {
            const [pass, setPass] = useState('');
            const [error, setError] = useState(false);

            const check = () => {
                if (pass === 'Ym') {
                    onSuccess();
                } else {
                    setError(true);
                    setPass('');
                }
            };

            return (
                <div className="absolute inset-0 z-[200] bg-black/95 flex items-center justify-center p-4">
                    <div className="bg-[#1c1917] border border-[#333] p-8 rounded shadow-2xl text-center w-full max-w-sm">
                        <Lock size={32} className="mx-auto text-[#555] mb-4"/>
                        <h3 className="text-[#e6dcca] mb-4 font-serif text-lg tracking-widest">å¤©æœºé˜ Â· éªŒè¯</h3>
                        <input 
                            type="password" 
                            value={pass} 
                            onChange={(e) => { setPass(e.target.value); setError(false); }}
                            onKeyDown={(e) => e.key === 'Enter' && check()}
                            placeholder="å£ä»¤" 
                            className="w-full bg-black border border-[#333] text-[#e6dcca] p-2 text-center rounded focus:border-[#d4af37] outline-none mb-4"
                            autoFocus
                        />
                        {error && <div className="text-red-800 text-xs mb-4">å£ä»¤é”™è¯¯</div>}
                        <div className="flex gap-2">
                            <button onClick={onClose} className="flex-1 py-2 bg-[#333] text-[#888] rounded hover:bg-[#444]">å–æ¶ˆ</button>
                            <button onClick={check} className="flex-1 py-2 bg-[#d4af37] text-black font-bold rounded hover:bg-[#b45309]">è¿›å…¥</button>
                        </div>
                    </div>
                </div>
            );
        };

        const PaperDuel = () => {
             const loadCustomData = () => {
                const saved = localStorage.getItem('paper_duel_custom_data_v7');
                if (saved) {
                    try {
                        const parsed = JSON.parse(saved);
                        return {
                            characters: parsed.characters || DEFAULT_CHARACTERS_DATA,
                            dialogues: {
                                xie_huaian: { ...DEFAULT_DIALOGUES.xie_huaian, ...(parsed.dialogues?.xie_huaian || {}) },
                                li_lianhua: { ...DEFAULT_DIALOGUES.li_lianhua, ...(parsed.dialogues?.li_lianhua || {}) },
                                enemies: { ...DEFAULT_DIALOGUES.enemies, ...(parsed.dialogues?.enemies || {}) }
                            },
                            memes: {
                                xie_huaian: { ...DEFAULT_MEMES.xie_huaian, ...(parsed.memes?.xie_huaian || {}) },
                                li_lianhua: { ...DEFAULT_MEMES.li_lianhua, ...(parsed.memes?.li_lianhua || {}) },
                                enemies: { ...DEFAULT_MEMES.enemies, ...(parsed.memes?.enemies || {}) }
                            },
                            equipment: {
                                xie_huaian: parsed.equipment?.xie_huaian || DEFAULT_EQUIPMENT.xie_huaian,
                                li_lianhua: parsed.equipment?.li_lianhua || DEFAULT_EQUIPMENT.li_lianhua
                            }
                        };
                    } catch (e) {
                        console.error("Loaded corrupted data", e);
                        // Fallback with complete structure
                        return { 
                            characters: DEFAULT_CHARACTERS_DATA, 
                            dialogues: DEFAULT_DIALOGUES, 
                            memes: DEFAULT_MEMES, 
                            equipment: DEFAULT_EQUIPMENT 
                        };
                    }
                }
                return { characters: DEFAULT_CHARACTERS_DATA, dialogues: DEFAULT_DIALOGUES, memes: DEFAULT_MEMES, equipment: DEFAULT_EQUIPMENT };
             };

             const [customData, setCustomData] = useState(loadCustomData);
             const [gameState, setGameState] = useState('LOGIN'); 
             const [inputCode, setInputCode] = useState('');
             const [loginError, setLoginError] = useState('');
             
             const [showAdmin, setShowAdmin] = useState(false);
             const [showPasswordModal, setShowPasswordModal] = useState(false);
             const [adminClickCount, setAdminClickCount] = useState(0);
             const [activeMeme, setActiveMeme] = useState(null); 
             
             const stateRef = useRef({
                player: null,
                enemy: null,
                gameState: 'LOGIN',
                showShop: false,
                showPartnerSelect: false,
                showStats: false,
                showMap: false,
                isAutoBattle: true,
                partnerActive: false,
                currentPartner: null,
                stage: 1,
                maxUnlockedStage: 1, 
                unlockedPartners: [],
                processingVictory: false,
                shop: { items: [], nextRefresh: 0 },
                customData: customData 
             });

             const [player, setPlayer] = useState({
                id: 'xie_huaian', name: "æœªå‘½å", baseHp: 100, currentHp: 100, baseAtk: 10, baseCrit: 20,
                level: 1, exp: 0, maxExp: 100, money: 100, bag: [],
                slots: { weapon: null, clothes: null, guard: null },
                skills: [], visual: 'xie_huaian', partnerUnlocked: false, lastPartnerUseTime: 0
             });

             const [enemy, setEnemy] = useState({ name: "æ•Œäºº", maxHp: 100, currentHp: 100, atk: 8, level: 1, isBoss: false, visual: 'enemy' });
             const [stage, setStage] = useState(1);
             const [maxUnlockedStage, setMaxUnlockedStage] = useState(1);
             const [logs, setLogs] = useState([]);
             const [chats, setChats] = useState([]);
             const [floatingTexts, setFloatingTexts] = useState([]);
             const [restTime, setRestTime] = useState(0); 
             const [resurrected, setResurrected] = useState(false);
             const [partnerActive, setPartnerActive] = useState(false);
             const [currentPartner, setCurrentPartner] = useState(null);
             const [partnerCooldownTimer, setPartnerCooldownTimer] = useState(0);
             const [unlockedPartners, setUnlockedPartners] = useState([]); 
             const [showShop, setShowShop] = useState(false); 
             const [showPartnerSelect, setShowPartnerSelect] = useState(false); 
             const [showStats, setShowStats] = useState(false); 
             const [showMap, setShowMap] = useState(false); 
             const [isAutoBattle, setIsAutoBattle] = useState(true);
             const [shopState, setShopState] = useState({ items: [], nextRefresh: 0 }); 
             
             const logsEndRef = useRef(null);
             const chatsEndRef = useRef(null);
             const playerRef = useRef(null);
             const enemyRef = useRef(null);
             const partnerRef = useRef(null);
             const battleLoopRef = useRef(null); 
             
             // --- Firebase Auth & Sync ---
             const [user, setUser] = useState(null);

             useEffect(() => {
                if(!auth) return;
                const init = async () => {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (e) { console.error("Login failed", e); }
                };
                init();
                return onAuthStateChanged(auth, setUser);
             }, []);
             
             // Auto-sync effect with Robust Data Merging
             useEffect(() => {
                if (!user || !db) return;
                
                const unsub = onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'game_configs', GLOBAL_CONFIG_ID), (snapshot) => {
                    if (snapshot.exists()) {
                        const newData = snapshot.data();
                        
                        // Robust merge: ensure all root keys exist even if cloud data is partial/old
                        const safeData = {
                            characters: newData.characters || DEFAULT_CHARACTERS_DATA,
                            dialogues: {
                                xie_huaian: { ...DEFAULT_DIALOGUES.xie_huaian, ...(newData.dialogues?.xie_huaian || {}) },
                                li_lianhua: { ...DEFAULT_DIALOGUES.li_lianhua, ...(newData.dialogues?.li_lianhua || {}) },
                                enemies: { ...DEFAULT_DIALOGUES.enemies, ...(newData.dialogues?.enemies || {}) }
                            },
                            memes: {
                                xie_huaian: { ...DEFAULT_MEMES.xie_huaian, ...(newData.memes?.xie_huaian || {}) },
                                li_lianhua: { ...DEFAULT_MEMES.li_lianhua, ...(newData.memes?.li_lianhua || {}) },
                                enemies: { ...DEFAULT_MEMES.enemies, ...(newData.memes?.enemies || {}) }
                            },
                            equipment: {
                                xie_huaian: newData.equipment?.xie_huaian || DEFAULT_EQUIPMENT.xie_huaian,
                                li_lianhua: newData.equipment?.li_lianhua || DEFAULT_EQUIPMENT.li_lianhua
                            }
                        };

                        setCustomData(safeData);
                        localStorage.setItem('paper_duel_custom_data_v7', JSON.stringify(safeData));
                        addLog("å·²è‡ªåŠ¨åŒæ­¥äº‘ç«¯æœ€æ–°é…ç½®", "success");
                    }
                }, (err) => {
                    console.error("Sync failed:", err);
                });
                
                return () => unsub();
             }, [user]);
             // -----------------------------

             useEffect(() => {
                stateRef.current = { 
                    player, enemy, gameState, showShop, showPartnerSelect, showStats, showMap, 
                    isAutoBattle, partnerActive, currentPartner, stage, unlockedPartners, 
                    maxUnlockedStage, processingVictory: stateRef.current.processingVictory,
                    shop: shopState,
                    customData
                };
             }, [player, enemy, gameState, showShop, showPartnerSelect, showStats, showMap, isAutoBattle, partnerActive, currentPartner, stage, unlockedPartners, maxUnlockedStage, shopState, customData]);
             
             useEffect(() => { logsEndRef.current?.scrollIntoView({ behavior: "smooth" }); }, [logs]);
             useEffect(() => { chatsEndRef.current?.scrollIntoView({ behavior: "smooth" }); }, [chats]);

             useEffect(() => {
                 localStorage.setItem('paper_duel_custom_data_v7', JSON.stringify(customData));
             }, [customData]);
             
             useEffect(() => {
                 if (activeMeme) {
                     const timer = setTimeout(() => {
                         setActiveMeme(null);
                     }, 3000); 
                     return () => clearTimeout(timer);
                 }
             }, [activeMeme]);
             
             useEffect(() => {
                if (player.lastPartnerUseTime > 0) {
                  const interval = setInterval(() => {
                      const now = Date.now();
                      const diff = (now - player.lastPartnerUseTime) / 1000;
                      const remaining = Math.max(0, (currentPartner?.cooldown || PARTNER_COOLDOWN_BASE) - diff); 
                      setPartnerCooldownTimer(remaining);
                  }, 1000);
                  return () => clearInterval(interval);
                }
             }, [player.lastPartnerUseTime, currentPartner]);

             useEffect(() => {
                if (gameState === 'VICTORY' && !showShop && !showPartnerSelect && !showStats && !showMap && isAutoBattle) {
                  const timer = setTimeout(() => {
                      if (stateRef.current.gameState === 'VICTORY') {
                          nextStage();
                          stateRef.current.processingVictory = false; 
                      }
                  }, 2000); 
                  return () => clearTimeout(timer);
                }
             }, [gameState, showShop, showPartnerSelect, showStats, showMap, isAutoBattle]);
             
             useEffect(() => {
                 const interval = setInterval(() => {
                     if (showShop && shopState.nextRefresh > 0) {
                         if (Date.now() > shopState.nextRefresh) {
                            refreshShop(player.id);
                         }
                         setShopState(prev => ({...prev}));
                     }
                 }, 1000);
                 return () => clearInterval(interval);
             }, [showShop, shopState.nextRefresh, player.id]);


             const updatePlayer = (updater) => setPlayer(prev => (typeof updater === 'function' ? updater(prev) : updater));
             const updateEnemy = (updater) => setEnemy(prev => (typeof updater === 'function' ? updater(prev) : updater));
             const addLog = (text, type = 'info') => setLogs(prev => [...prev.slice(-19), { id: Date.now() + Math.random(), text, type }]);
             const addChat = (speaker, text) => setChats(prev => [...prev.slice(-9), { id: Date.now() + Math.random(), speaker, text }]);
             const addFloatingText = (value, type, target) => { 
                const id = Date.now() + Math.random();
                setFloatingTexts(prev => [...prev, { id, value, type, target }]);
                setTimeout(() => setFloatingTexts(prev => prev.filter(ft => ft.id !== id)), 1000);
             };

             const triggerMeme = (targetType, action) => {
                 let config;
                 const currentData = stateRef.current.customData;
                 const currentPlayerId = stateRef.current.player.id;
                 
                 if (targetType === 'player') {
                     config = currentData.memes[currentPlayerId]?.[action];
                 } else {
                     const enemyName = stateRef.current.enemy.name;
                     const enemyMemes = currentData.memes.enemies[enemyName] || currentData.memes.enemies.default;
                     config = enemyMemes[action];
                 }
                 
                 if (config && config.enabled) {
                     setActiveMeme({ ...config, source: targetType });
                 }
             };

             const handleLogin = () => {
                if (INVITE_CODES.includes(inputCode)) {
                  if (inputCode === 'admin') {
                      setShowPasswordModal(true);
                  } else {
                      setGameState('GACHA'); 
                  }
                } else {
                  // Fallback login
                  setLoginError("é‚€è¯·ç é”™è¯¯ï¼Œè¯·è”ç³»æ·‡æ·‡è·å–");
                }
             };
             
             const handleTitleClick = () => {
                 setAdminClickCount(prev => {
                     const next = prev + 1;
                     if (next >= 5) {
                         setShowPasswordModal(true);
                         setAdminClickCount(0);
                         return 0;
                     }
                     return next;
                 });
             };

             const handleAdminLoginSuccess = () => {
                 setShowPasswordModal(false);
                 setShowAdmin(true);
             };

             const getPlayerStats = (p) => {
                let bonusAtk = 0; let bonusHp = 0; let bonusCrit = 0;
                Object.values(p.slots).forEach(item => {
                  if (item) { bonusAtk += (item.atk || 0); bonusHp += (item.hp || 0); bonusCrit += (item.crit || 0); }
                });
                if (p.skills.some(s => s.type === 'passive_crit_buff')) bonusCrit += 20; 
                const baseHp = p.baseHp || 100; const baseAtk = p.baseAtk || 10; const baseCrit = p.baseCrit || 0;
                return { maxHp: baseHp + bonusHp + (p.level - 1) * 15, atk: baseAtk + bonusAtk + (p.level - 1) * 2, crit: baseCrit + bonusCrit, bonusAtk, bonusHp, bonusCrit };
             };
             
             // --- Generate Shop Items (Using customData) ---
             const generateShopItems = (pid) => {
                 // Use customData.equipment if available, fallback to defaults just in case
                 const currentData = stateRef.current.customData;
                 const pool = (currentData.equipment && currentData.equipment[pid]) ? currentData.equipment[pid] : DEFAULT_EQUIPMENT[pid];
                 
                 // Separate by rarity roughly based on dropWeight for shop generation logic
                 // We will simplify: use weighted random to pick 6 items
                 const items = [];
                 for (let i = 0; i < 6; i++) {
                     const picked = getWeightedItem(pool);
                     if (picked) {
                        items.push({ ...picked, id: Date.now() + i }); 
                     }
                 }
                 return items;
             };
             
             const refreshShop = (pid, manual = false) => {
                 if (manual) {
                     if (player.money < SHOP_REFRESH_COST) { addLog("é“¶ä¸¤ä¸è¶³ï¼Œæ— æ³•æ‰“ç‚¹", "error"); return; }
                     updatePlayer(prev => ({...prev, money: prev.money - SHOP_REFRESH_COST}));
                     addLog(`èŠ±è´¹${SHOP_REFRESH_COST}ä¸¤ï¼Œé¬¼å¸‚ç„•ç„¶ä¸€æ–°`, "success");
                 }
                 const newItems = generateShopItems(pid);
                 const nextTime = Date.now() + (2 * 60 * 60 * 1000); 
                 setShopState({ items: newItems, nextRefresh: nextTime });
             };
             
             const openShop = () => {
                 if (Date.now() > shopState.nextRefresh || shopState.items.length === 0) {
                     refreshShop(player.id);
                 }
                 setShowShop(true);
             };
             
             const handleBuy = (item) => {
                  if (player.money >= item.price) {
                      if (item.type !== 'consumable' && player.bag.some(i => i.name === item.name)) {
                          addLog("å·²æ‹¥æœ‰æ­¤ç‰©å“", "error");
                          return;
                      }
                      updatePlayer(prev => ({
                          ...prev,
                          money: prev.money - item.price,
                          bag: [...prev.bag, item]
                      }));
                      setShopState(prev => ({
                          ...prev,
                          items: prev.items.filter(i => i.id !== item.id)
                      }));
                      addLog(`è´­å¾— [${item.name}]`, 'success');
                  } else {
                      addLog("é“¶ä¸¤ä¸è¶³", "error");
                  }
              };

             const rollCharacter = () => {
                const charData = randomItem(customData.characters); 
                const skillDB = SKILLS_DB[charData.id]; 
                const initialSkills = [skillDB[1]]; 
                updatePlayer({ id: charData.id, name: charData.name, baseHp: charData.baseHp, currentHp: charData.baseHp, baseAtk: charData.baseAtk, baseCrit: charData.baseCrit, level: 1, exp: 0, maxExp: 100, money: 100, bag: [], slots: { weapon: null, clothes: null, guard: null }, skills: initialSkills, visual: charData.visual, partnerUnlocked: false, lastPartnerUseTime: 0 });
                setStage(1); setMaxUnlockedStage(1); setLogs([]); setChats([]); setResurrected(false); setPartnerCooldownTimer(0); setIsAutoBattle(true); setUnlockedPartners([]); 
                
                refreshShop(charData.id);
                setGameState('MENU'); addLog(`å¤©å‘½æ‰€å½’ã€‚ä½ æ˜¯ [${charData.name}]`, 'system'); addLog(`åˆå§‹ç»å­¦: [${skillDB[1].name}]`, 'loot');
             };

             const unlockPartner = (partnerId) => {
                  if (!unlockedPartners.includes(partnerId)) {
                      const partnerList = PARTNERS_DB[player.id];
                      if (!partnerList) return;
                      const partner = partnerList.find(p => p.id === partnerId);
                      if (partner) {
                         setUnlockedPartners(prev => [...prev, partnerId]);
                         addLog(`ç»“è¯†è±ªæ°: [${partner.name}]`, 'success');
                         updatePlayer(p => ({...p, partnerUnlocked: true}));
                      }
                  }
             };

             const removePartner = (partnerId) => {
                  setUnlockedPartners(prev => prev.filter(id => id !== partnerId));
                  if (currentPartner?.id === partnerId) { setPartnerActive(false); setCurrentPartner(null); }
                  const partnerList = PARTNERS_DB[player.id];
                  const partner = partnerList?.find(p => p.id === partnerId);
                  if (partner) addLog(`[${partner.name}] ç¦»å¼€äº†é˜Ÿä¼`, 'info');
             };

             const spawnEnemy = (currentStage) => {
                if (currentStage > 10) { setGameState('GAME_COMPLETED'); return; }
                const storyConfig = STORY_CONFIGS[player.id] || STORY_CONFIGS['xie_huaian'];
                const config = storyConfig[currentStage] || { enemyName: "ç¥ç§˜äºº", hpScale: 1, atkScale: 1 };
                
                if (currentStage === 10 && unlockedPartners.includes('pu_nichuan')) {
                    setTimeout(() => { forcedSummon('pu_nichuan', 10000); addLog("è’²é€†å·ï¼šæ‹¿å‘½æ¥ï¼", 'loot'); setTimeout(() => { removePartner('pu_nichuan'); addLog("è’²é€†å· åŠ›ç«­ç‰ºç‰²...", 'error'); }, 10000); }, 500);
                }
                if (currentStage === 9 && unlockedPartners.includes('bai_wan')) {
                     setTimeout(() => { forcedSummon('bai_wan', 60000); addLog("ç™½çš–ï¼šæˆ‘æ¥åŠ©ä½ ä¸€è‡‚ä¹‹åŠ›ã€‚", 'loot'); }, 500);
                }

                const hp = Math.floor(100 * config.hpScale); const atk = Math.floor(8 * config.atkScale);  
                updateEnemy({ name: config.enemyName, maxHp: hp, currentHp: hp, atk: atk, level: currentStage, isBoss: config.boss, visual: config.enemyName });
                setResurrected(false);
                stateRef.current.processingVictory = false; 
                addLog(`--- ${config.title} ---`, 'system');
                
                const enemyName = config.enemyName;
                const enemyDialogues = stateRef.current.customData.dialogues.enemies[enemyName] || stateRef.current.customData.dialogues.enemies.default;
                
                const introLines = (enemyDialogues && enemyDialogues.intro && enemyDialogues.intro.length > 0) 
                    ? enemyDialogues.intro 
                    : stateRef.current.customData.dialogues.enemies.default.intro;
                    
                addChat('Enemy', randomItem(introLines));
                
                setGameState('BATTLE');
             };

             const forcedSummon = (partnerId, duration) => {
                  const partnerList = PARTNERS_DB[player.id];
                  const partner = partnerList.find(p => p.id === partnerId);
                  if (!partner) return;
                  setCurrentPartner(partner); setPartnerActive(true);
                  setTimeout(() => { setPartnerActive(false); setCurrentPartner(null); }, duration);
             };

             const handleAttackRound = () => {
                const { player, enemy, gameState, partnerActive, currentPartner, processingVictory, customData } = stateRef.current;
                if (processingVictory || gameState !== 'BATTLE') return;
                if (enemy.currentHp <= 0) { handleVictory(enemy); return; }
                if (player.currentHp <= 0) { handleDefeat(); return; }

                const stats = getPlayerStats(player); 
                if (Math.random() < 0.25) {
                    const enemyDialogues = customData.dialogues.enemies[enemy.name] || customData.dialogues.enemies.default;
                    const enemyAttackLines = (enemyDialogues.attack && enemyDialogues.attack.length > 0) 
                        ? enemyDialogues.attack 
                        : customData.dialogues.enemies.default.attack;

                    const speaker = Math.random() > 0.5 ? 'Player' : 'Enemy';
                    const playerLines = customData.dialogues[player.id]?.attack || customData.dialogues.xie_huaian.attack; 
                    const text = speaker === 'Player' ? randomItem(playerLines) : randomItem(enemyAttackLines);
                    addChat(speaker, text);
                }

                triggerAnimation(playerRef, 'animate-lunge-right');
                if (partnerActive && currentPartner) {
                    triggerAnimation(partnerRef, 'animate-lunge-right');
                    setTimeout(() => {
                        const partnerDmg = Math.ceil(stats.atk * 0.8);
                        updateEnemy(prev => {
                            const newHp = Math.max(0, prev.currentHp - partnerDmg);
                            addFloatingText(`-${partnerDmg}`, 'loot', 'enemy');
                            return { ...prev, currentHp: newHp };
                        });
                    }, 100); 
                }
                setTimeout(() => triggerAnimation(enemyRef, 'animate-lunge-left'), 200);

                setTimeout(() => {
                  const { enemy: currEnemy, player: currPlayer } = stateRef.current;
                  if (currEnemy.currentHp <= 0) { handleVictory(currEnemy); return; }
                  let damage = stats.atk; let hitCount = 1;
                  const hasSkill = (skills, type) => skills.some(s => s.type === type);
                  if (hasSkill(currPlayer.skills, 'passive_double') && Math.random() < 0.4) { hitCount = 2; addFloatingText('è¿ç¯è®¡!', 'loot', 'player'); }
                  if (hasSkill(currPlayer.skills, 'passive_debuff')) { updateEnemy(prev => ({...prev, atk: Math.max(1, prev.atk - 2)})); if(Math.random()<0.2) addFloatingText('æ”»å¿ƒ', 'info', 'player'); }
                  
                  let totalDamage = 0;
                  for (let i = 0; i < hitCount; i++) {
                      let currentHitDmg = damage;
                      let isCrit = Math.random() * 100 < stats.crit;
                      if (isCrit) {
                          currentHitDmg = Math.floor(currentHitDmg * 1.8); 
                          triggerMeme('player', 'crit'); 
                      }
                      currentHitDmg = Math.floor(currentHitDmg * (randomInt(90, 110) / 100));
                      if (hasSkill(currPlayer.skills, 'passive_execute') && (currEnemy.currentHp / currEnemy.maxHp < 0.4)) { currentHitDmg = 9999; addFloatingText('æ–©æ€!', 'crit', 'player'); }
                      totalDamage += currentHitDmg;
                      updateEnemy(prev => {
                          const newHp = prev.currentHp - currentHitDmg;
                          if (newHp / prev.maxHp < 0.3 && Math.random() < 0.3) {
                              triggerMeme('enemy', 'beaten');
                          }
                          setTimeout(() => { addFloatingText(`-${currentHitDmg}${isCrit ? '!' : ''}`, isCrit ? 'crit' : 'damage', 'enemy'); }, i * 200);
                          return { ...prev, currentHp: newHp }; 
                      });
                  }
                  addLog(`é€ æˆ ${totalDamage} ä¼¤å®³${hitCount > 1 ? '(è¿ç¯)' : ''}`);
                  triggerAnimation(enemyRef, 'animate-shake');
                }, 300);

                setTimeout(() => {
                  const { enemy: currEnemy, player: currPlayer } = stateRef.current;
                  if (currEnemy.currentHp <= 0) { handleVictory(currEnemy); return; }
                  if (currPlayer.currentHp <= 0) { handleDefeat(); return; }

                  updateEnemy(latestEnemy => {
                      let damage = latestEnemy.atk;
                      damage = Math.floor(damage * (randomInt(90, 110) / 100));
                      const hasSkill = (skills, type) => skills.some(s => s.type === type);

                      if (hasSkill(player.skills, 'passive_dodge') && Math.random() < 0.15) { 
                          addFloatingText('é—ªé¿!', 'info', 'player'); 
                          triggerMeme('player', 'dodge');
                          damage = 0; 
                      } else {
                          if (Math.random() < 0.2) {
                              damage = Math.floor(damage * 1.5);
                              triggerMeme('enemy', 'crit');
                              addFloatingText('æš´å‡»!', 'crit', 'player');
                          } else if (Math.random() < 0.1) {
                              triggerMeme('enemy', 'dodge');
                          }
                      }

                      if (damage > 0) {
                          if (hasSkill(player.skills, 'passive_reflect')) {
                              const reflectDmg = Math.floor(damage * 0.3);
                              setTimeout(() => { updateEnemy(prev => { const newHp = Math.max(0, prev.currentHp - reflectDmg); if (reflectDmg > 0) addFloatingText(`åä¼¤-${reflectDmg}`, 'loot', 'enemy'); return {...prev, currentHp: newHp}; }); }, 50);
                          }
                          updatePlayer(prev => {
                            let newHp = prev.currentHp - damage;
                            addFloatingText(`-${damage}`, 'damage', 'player');
                            if (newHp <= 0 && hasSkill(prev.skills, 'passive_resurrect') && !resurrected) {
                                const maxHp = getPlayerStats(prev).maxHp; newHp = Math.floor(maxHp * 0.3); setResurrected(true); addFloatingText('é‡ç”Ÿ!', 'crit', 'player'); addLog('ç»å¤„é€¢ç”Ÿï¼', 'success');
                            }
                            if (newHp / getPlayerStats(prev).maxHp < 0.3 && Math.random() < 0.3) {
                                triggerMeme('player', 'beaten');
                            }
                            return { ...prev, currentHp: newHp };
                          });
                          triggerAnimation(playerRef, 'animate-shake');
                      }
                      return latestEnemy;
                  });
                }, 800);
             };

             const triggerAnimation = (ref, className) => { if (ref.current) { ref.current.classList.remove(className); void ref.current.offsetWidth; ref.current.classList.add(className); setTimeout(() => { if(ref.current) ref.current.classList.remove(className); }, 500); } };

             const handleVictory = (defeatedEnemy) => {
                const { gameState, processingVictory, stage, customData, player } = stateRef.current;
                if (gameState === 'VICTORY' || processingVictory) return;
                stateRef.current.processingVictory = true; stateRef.current.gameState = 'VICTORY'; setGameState('VICTORY');
                
                triggerMeme('player', 'win');

                const winLines = customData.dialogues[player.id]?.win || customData.dialogues.xie_huaian.win;
                addChat('Player', randomItem(winLines)); 
                
                addLog(`${defeatedEnemy.name} å·²è¢«æ¸…é™¤`, 'success');
                const partnerList = PARTNERS_DB[player.id];
                if (partnerList) { partnerList.forEach(p => { if (stage === p.unlockLevel) unlockPartner(p.id); }); }
                if (stage < 10 && stage >= stateRef.current.maxUnlockedStage) { setMaxUnlockedStage(s => s + 1); addLog('æ–°åŒºåŸŸå·²åœ¨èˆ†å›¾ä¸Šè§£é”', 'system'); }
                const xpGain = 40 + (stage * 15) + (defeatedEnemy.isBoss ? 150 : 0); const moneyGain = randomInt(20, 50) + (defeatedEnemy.isBoss ? 100 : 0);
                handleGainExp(xpGain); updatePlayer(prev => ({...prev, money: prev.money + moneyGain})); addLog(`è·å¾— ${xpGain} é˜…å†, ${moneyGain} é“¶ä¸¤`, 'info');
                
                // --- ä½¿ç”¨è‡ªå®šä¹‰è£…å¤‡æ± æ‰è½é€»è¾‘ ---
                if (Math.random() < 0.25) {
                  const currentData = stateRef.current.customData;
                  const pool = (currentData.equipment && currentData.equipment[player.id]) ? currentData.equipment[player.id] : DEFAULT_EQUIPMENT[player.id];
                  
                  const newItem = getWeightedItem(pool);
                  
                  if (newItem) {
                      let canAdd = true; 
                      if (newItem.type !== 'consumable') { 
                          if (player.bag.some(i => i.name === newItem.name)) canAdd = false; 
                      }
                      if (canAdd) { 
                          addLog(`ç¼´è·: [${newItem.name}]`, 'loot'); 
                          updatePlayer(prev => ({ ...prev, bag: [...prev.bag, newItem] })); 
                      } else { 
                          const sellPrice = Math.floor(newItem.price / 2); 
                          addLog(`å‘ç° [${newItem.name}] (æŠ˜ç®— ${sellPrice} ä¸¤)`, 'info'); 
                          updatePlayer(prev => ({...prev, money: prev.money + sellPrice})); 
                      }
                  }
                }
             };

             const handleGainExp = (amount) => {
                updatePlayer(prev => {
                    let { exp, maxExp, level, name, skills, partnerUnlocked, id } = prev; exp += amount; let leveledUp = false; let newSkill = null;
                    while (exp >= maxExp) { exp -= maxExp; level += 1; maxExp = Math.floor(maxExp * 1.3); leveledUp = true; const skillTree = SKILLS_DB[id]; if (skillTree && skillTree[level]) { const skill = skillTree[level]; skills = [...skills, skill]; newSkill = skill; } if (level >= PARTNER_UNLOCK_LEVEL && !partnerUnlocked) { partnerUnlocked = true; } }
                    let nextState = { ...prev, exp, maxExp, level, skills, partnerUnlocked }; if (level >= 3) nextState.partnerUnlocked = true;
                    if (leveledUp) { const stats = getPlayerStats(nextState); nextState.currentHp = stats.maxHp; addLog(`å¿ƒæ™ºç²¾è¿›ï¼${name} å‡è‡³ Lv.${level}`, 'loot'); addFloatingText('LEVEL UP!', 'crit', 'player'); if (newSkill) { addLog(`é¢†æ‚Ÿæ–°è®¡: [${newSkill.name}]`, 'success'); } }
                    return nextState;
                });
             };

             const handleEquip = (item, index) => {
                  if (item.type === 'consumable') { handleUseItem(item, index); return; }
                  updatePlayer(prev => { const newSlots = { ...prev.slots }; if (item.type === 'weapon') newSlots.weapon = item; if (item.type === 'clothes') newSlots.clothes = item; if (item.type === 'guard') newSlots.guard = item; addLog(`è£…å¤‡äº† [${item.name}]`, 'info'); return { ...prev, slots: newSlots }; });
             };
             const handleUseItem = (item, index) => {
                  const stats = getPlayerStats(player); if (player.currentHp >= stats.maxHp && !item.cure) { addLog("æ°”è¡€å·²æ»¡ï¼Œæ— éœ€ä½¿ç”¨", "info"); return; }
                  updatePlayer(prev => { const newBag = [...prev.bag]; newBag.splice(index, 1); let recovered = 0; let newHp = prev.currentHp; if (item.heal) { newHp = Math.min(stats.maxHp, prev.currentHp + item.heal); recovered = newHp - prev.currentHp; } addLog(`ä½¿ç”¨äº† [${item.name}]ï¼Œæ¢å¤ ${recovered} ç‚¹æ°”è¡€`, 'success'); if (item.cure) { addLog(`[${item.name}] å‘æŒ¥è¯æ•ˆï¼Œæ¯’ç´ å·²è§£`, 'success'); } return { ...prev, currentHp: newHp, bag: newBag }; });
             };
             const handleUnequip = (type) => { updatePlayer(prev => { const newSlots = { ...prev.slots }; const item = newSlots[type]; if (item) { addLog(`å¸ä¸‹äº† [${item.name}]`, 'info'); newSlots[type] = null; } return { ...prev, slots: newSlots }; }); };
             const handleSell = (e, item, index) => { e.stopPropagation(); const sellPrice = Math.floor(item.price / 2); updatePlayer(prev => { const newSlots = { ...prev.slots }; if (newSlots.weapon === item) newSlots.weapon = null; if (newSlots.clothes === item) newSlots.clothes = null; if (newSlots.guard === item) newSlots.guard = null; const newBag = [...prev.bag]; newBag.splice(index, 1); return { ...prev, money: prev.money + sellPrice, bag: newBag, slots: newSlots }; }); addLog(`å”®å‡º [${item.name}]ï¼Œè·å¾— ${sellPrice} é“¶ä¸¤`, 'info'); };
             
             const handleDefeat = () => { if (gameState === 'RESTING') return; setGameState('RESTING'); setRestTime(REST_DURATION); addLog('å¸ƒå±€è¢«ç ´ï¼Œæš‚é¿é”‹èŠ’...', 'error'); };
             const nextStage = () => { if (stage >= 10) { setGameState('GAME_COMPLETED'); return; } setStage(s => s + 1); const nextS = stage + 1; spawnEnemy(nextS); };
             const selectStage = (s) => { setShowMap(false); setStage(s); spawnEnemy(s); };
             const summonSelectedPartner = (partner) => { setShowPartnerSelect(false); setCurrentPartner(partner); if (gameState !== 'BATTLE') return; const stats = getPlayerStats(player); let damage = stats.atk * 4; setPartnerActive(true); updatePlayer(prev => ({ ...prev, lastPartnerUseTime: Date.now() })); setPartnerCooldownTimer(partner.cooldown); addLog(`${partner.name} åŠ©æˆ˜ï¼å‘åŠ¨ [${partner.skillName}]`, 'loot'); addFloatingText(`${partner.skillName}!`, 'crit', 'player'); updateEnemy(prev => { const newHp = Math.max(0, prev.currentHp - damage); setTimeout(() => addFloatingText(`-${damage}`, 'crit', 'enemy'), 300); return { ...prev, currentHp: newHp }; }); setTimeout(() => { setPartnerActive(false); setCurrentPartner(null); addLog(`${partner.name}ï¼šæš‚ä¸”é€€ä¸‹ã€‚`, 'info'); }, partner.duration); };
             const manualAttack = () => { if (gameState === 'BATTLE' && !showShop && !showPartnerSelect && !showStats && !showMap && !isAutoBattle) { handleAttackRound(); } };
             const openPartnerSelect = () => { if (!player.partnerUnlocked) return; if (partnerCooldownTimer > 0) { addLog(`ä¼™ä¼´ä¼‘æ•´ä¸­...`, 'error'); return; } setShowPartnerSelect(true); };
             const finishRest = () => { const { player, stage } = stateRef.current; const stats = getPlayerStats(player); updatePlayer(p => ({...p, currentHp: stats.maxHp})); addLog('ä¼‘æ•´å®Œæ¯•ï¼Œé‡å›æ£‹å±€ï¼', 'system'); spawnEnemy(stage); };
             const instantRevive = () => { const { player } = stateRef.current; const stats = getPlayerStats(player); updatePlayer(p => ({...p, currentHp: stats.maxHp})); setRestTime(0); };

             useEffect(() => { battleLoopRef.current = handleAttackRound; });
             useEffect(() => { const battleInterval = setInterval(() => { const { gameState, showShop, showPartnerSelect, showStats, showMap, isAutoBattle } = stateRef.current; if (gameState === 'BATTLE' && !showShop && !showPartnerSelect && !showStats && !showMap && isAutoBattle) { if (battleLoopRef.current) battleLoopRef.current(); } }, 1500); return () => clearInterval(battleInterval); }, []); 
             useEffect(() => { const restInterval = setInterval(() => { const { gameState, player } = stateRef.current; if (gameState !== 'RESTING') return; setRestTime(prev => { if (prev <= 0) return 0; const stats = getPlayerStats(player); updatePlayer(p => ({ ...p, currentHp: Math.min(stats.maxHp, p.currentHp + (stats.maxHp / REST_DURATION)) })); return prev - 1; }); }, 1000); return () => clearInterval(restInterval); }, []);
             useEffect(() => { if (gameState === 'RESTING' && restTime === 0) { finishRest(); } }, [restTime, gameState]);

             // Render Logic
             const stats = getPlayerStats(player);
             const charData = customData.characters.find(c => c.id === player.id) || customData.characters[0];
             const currentPartnerList = PARTNERS_DB[player.id] || [];
             
             // --- JSX ---
             if (gameState === 'LOGIN') {
                 return (
                    <div className="w-full h-screen bg-[#3e2323] flex items-center justify-center relative">
                        {/* äº‘ç«¯çŠ¶æ€æŒ‡ç¤ºå™¨ */}
                        <div className="absolute bottom-4 left-4 flex items-center gap-2 text-xs opacity-70">
                            {user ? <Wifi size={14} className="text-green-500" /> : <WifiOff size={14} className="text-red-500" />}
                            <span className="text-[#a89f91]">{user ? "äº‘ç«¯å·²è¿æ¥" : "ç¦»çº¿æ¨¡å¼"}</span>
                        </div>

                        {showPasswordModal && <PasswordModal onClose={() => setShowPasswordModal(false)} onSuccess={handleAdminLoginSuccess} />}
                        {showAdmin && <AdminPanel customData={customData} setCustomData={setCustomData} onClose={() => setShowAdmin(false)} />}
                        
                        <div className="bg-[#f4f0e6] p-10 rounded-sm border-8 border-[#2a231d] shadow-2xl text-center max-w-md w-full relative z-10">
                            <h1 onClick={handleTitleClick} className="text-4xl font-black mb-4 text-[#8b2e2e] tracking-widest font-serif cursor-pointer select-none">çº¸ä¸Šæ±Ÿæ¹–</h1>
                            <p className="text-[#57534e] mb-8 text-sm italic">æ­¤æ¸¸æˆä¸º <span className="font-bold text-[#b91c1c]">æ·‡æ·‡</span> æ‰€æœ‰ï¼Œä¸“ä¸º <span className="font-bold text-[#b91c1c]">æœæœ</span> è‡ªå—¨</p>
                            <input type="text" value={inputCode} onChange={(e) => setInputCode(e.target.value)} placeholder="è¯·è¾“å…¥é‚€è¯·ç " className="w-full p-3 border-2 border-[#a89f91] rounded bg-white text-center mb-4 focus:outline-none focus:border-[#d4af37] text-black" />
                            {loginError && <div className="text-red-500 text-xs mb-4">{loginError}</div>}
                            <button onClick={handleLogin} className="w-full bg-[#d4af37] text-[#3e2323] py-3 rounded font-bold hover:bg-[#b45309] transition-all flex items-center justify-center gap-2"><KeyRound size={20} /> å¼€å¯ç”»å·</button>
                        </div>
                    </div>
                 );
             }
             
             if (gameState === 'GACHA') {
                return (
                    <div className="w-full h-screen bg-[#2a231d] flex flex-col items-center justify-center font-serif text-[#e6dcca] z-50">
                        <h2 className="text-2xl mb-8 animate-pulse tracking-widest">å‘½è¿è½®è½¬ï¼Œä½•äººå…¥å±€ï¼Ÿ</h2>
                        <button onClick={rollCharacter} className="w-32 h-32 rounded-full border-4 border-[#d4af37] flex items-center justify-center text-4xl hover:scale-110 transition-transform bg-[#3e342b] shadow-[0_0_30px_rgba(212,175,55,0.5)] cursor-pointer">æŠ½</button>
                    </div>
                );
             }

             if (gameState === 'MENU') {
                 return (
                    <div className="w-full h-screen bg-[#1c1917]/90 flex items-center justify-center backdrop-blur-sm relative">
                        {showPasswordModal && <PasswordModal onClose={() => setShowPasswordModal(false)} onSuccess={handleAdminLoginSuccess} />}
                        {showAdmin && <AdminPanel customData={customData} setCustomData={setCustomData} onClose={() => setShowAdmin(false)} />}
                        
                        <div className="bg-[#f4f0e6] p-10 rounded-sm border-8 border-[#2a231d] shadow-2xl text-center max-w-md w-full transform rotate-1 relative">
                            <h1 onClick={handleTitleClick} className="text-5xl font-black mb-4 text-[#2a231d] tracking-widest font-serif cursor-pointer select-none" style={{textShadow: '2px 2px 0px rgba(0,0,0,0.1)'}}>{player.id === 'xie_huaian' ? 'é•¿å®‰äºŒåå››è®¡' : 'è²èŠ±æ¥¼å¥‡é—»'}</h1>
                            <p className="text-[#78716c] mb-8 font-serif italic text-lg">â€” çº¸ä¸Šæƒè°‹ â€”</p>
                            <div className="bg-[#e6ded5] p-4 rounded-sm border border-[#d6d3cd] text-left text-sm mb-8 font-serif leading-loose text-[#444]">
                                <p><span className="font-bold text-[#8b2e2e]">ä¸»è§’ï¼š</span> {player.name}</p>
                                <p><span className="font-bold text-[#8b2e2e]">èƒ½åŠ›ï¼š</span> {player.id === 'xie_huaian' ? 'è¿ç­¹å¸·å¹„ï¼Œå€Ÿåˆ€æ€äºº' : 'ç›¸å¤·å¤ªå‰‘ï¼Œæ‰¬å·æ…¢'}</p>
                            </div>
                            <button onClick={() => { spawnEnemy(1); }} className="w-full bg-[#8b2e2e] text-[#f4f0e6] py-3 rounded-sm font-bold hover:bg-[#7f1d1d] hover:scale-[1.02] transition-all flex items-center justify-center gap-2 border-2 border-[#fecaca] shadow-lg text-lg font-serif"><Feather size={20} /> å…¥å±€</button>
                        </div>
                    </div>
                 );
             }

             return (
                <div className="w-full h-screen bg-[#f4f0e6] text-[#4a3b32] font-serif overflow-hidden flex flex-col md:flex-row select-none relative">
                    {showPasswordModal && <PasswordModal onClose={() => setShowPasswordModal(false)} onSuccess={handleAdminLoginSuccess} />}
                    {showAdmin && <AdminPanel customData={customData} setCustomData={setCustomData} onClose={() => setShowAdmin(false)} />}
                    {activeMeme && <MemeOverlay meme={activeMeme} />}

                    {/* å·¦ä¾§ */}
                    <div className="w-full md:w-72 bg-[#2a231d] text-[#e6dcca] p-5 flex flex-col border-r-4 border-[#3e342b] shadow-2xl z-20 relative">
                        {/* éšå½¢å…¥å£ï¼šç‚¹å‡» "çº¸ä¸Šæ±Ÿæ¹–" æ ‡é¢˜ */}
                        <div className="absolute top-0 right-0 p-2 opacity-10 cursor-pointer" onClick={handleTitleClick}><Scroll size={64} /></div>
                        
                        {/* ... Stats Block ... */}
                        <div className="mb-4 border-b border-[#5d4d3d] pb-2 cursor-pointer group hover:bg-[#3e3228] p-2 -mx-2 rounded transition-colors relative" onClick={() => setShowStats(true)} title="ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…">
                           <div className="absolute inset-0 border-2 border-transparent group-hover:border-[#d4af37]/30 rounded pointer-events-none animate-pulse"></div>
                           <div className="flex justify-between items-center mb-2"><h2 className="text-xl font-bold flex items-center gap-2 text-[#d4af37]"><User size={20} className="stroke-[#d4af37]" /> {player.id === 'xie_huaian' ? 'æ¡ˆå·' : 'åŒ»æ¡ˆ'}</h2><MousePointer size={14} className="text-[#a89f91] opacity-50 group-hover:opacity-100" /></div>
                           <div className="space-y-1 text-sm group-hover:text-[#fbbf24] transition-colors">
                             <div className="flex justify-between items-center"><span className="text-[#a89f91]">å§“å:</span> <span className="text-[#f5f5f5] font-bold text-lg">{player.name}</span></div>
                             <div className="flex justify-between items-center"><span className="text-[#a89f91]">å“é˜¶:</span> <span className="text-[#fbbf24]">Lv.{player.level}</span></div>
                             <div className="grid grid-cols-2 gap-2 mt-2"><div className="bg-[#1e1915] p-1 px-2 rounded border border-[#3e342b] flex justify-between"><span>æ­¦/æ™º</span><span className="text-red-400">{stats.atk}</span></div><div className="bg-[#1e1915] p-1 px-2 rounded border border-[#3e342b] flex justify-between"><span>æ´å¯Ÿ</span><span className="text-orange-400">{stats.crit}%</span></div></div>
                             <div className="flex items-center gap-2 mt-2 bg-[#1e1915] p-1 px-2 rounded border border-[#3e342b] text-[#fbbf24]"><Coins size={14} /> <span>{player.money} ä¸¤</span></div>
                             <div className="mt-2"><div className="flex justify-between text-xs mb-1 text-[#a89f91]"><span>ç²¾åŠ›</span><span>{Math.floor(player.currentHp)}/{stats.maxHp}</span></div><div className="w-full h-3 bg-[#1a1612] rounded border border-[#5d4d3d] p-[1px] relative"><div className="bg-gradient-to-r from-red-800 to-red-600 h-full rounded-sm transition-all duration-500" style={{width: `${Math.min(100, (player.currentHp / stats.maxHp) * 100)}%`}}></div></div></div>
                           </div>
                        </div>
                        {/* Equipment, Skills, Bag ... (Same as before) */}
                        <div className="mb-4"><h2 className="text-sm font-bold flex items-center gap-2 mb-2 text-[#a89f91]"><Shield size={14} /> å½“å‰è£…å¤‡ (ç‚¹å‡»å¸ä¸‹)</h2><div className="grid grid-cols-3 gap-2">{['weapon', 'clothes', 'guard'].map(type => (<div key={type} className="aspect-square bg-[#1e1915] border border-[#5d4d3d] rounded flex flex-col items-center justify-center relative cursor-pointer hover:border-[#d4af37] transition-all group" title={player.slots[type]?.desc} onClick={() => handleUnequip(type)}><span className="text-[10px] text-[#555] absolute top-0.5">{type === 'weapon' ? 'æ­¦å™¨' : type === 'clothes' ? 'è¡£è£…' : 'æŠ¤å…·'}</span>{player.slots[type] ? (<><div className="text-xs text-[#d4af37] text-center font-bold px-1 mt-2">{player.slots[type].name}</div><div className="text-[9px] text-[#888] scale-90">{player.slots[type].atk > 0 ? `æ”»+${player.slots[type].atk}` : `è¡€+${player.slots[type].hp}`}</div><div className="absolute inset-0 bg-black/50 hidden group-hover:flex items-center justify-center text-xs text-white">å¸ä¸‹</div></>) : <div className="text-[#333]">-</div>}</div>))}</div></div>
                        <div className="flex-1 overflow-hidden flex flex-col mb-4"><h2 className="text-sm font-bold flex items-center gap-2 mb-2 text-[#a89f91] border-b border-[#5d4d3d] pb-1"><BookOpen size={14} /> å·²é¢†æ‚Ÿ</h2><div className="overflow-y-auto space-y-2 pr-1 custom-scrollbar">{player.skills.length === 0 && <div className="text-xs text-[#555] italic">æš‚æ— </div>}{player.skills.map((skill) => (<div key={skill.id} className="bg-[#352b22] p-2 rounded-sm border-l-2 border-[#8b2e2e]"><div className="font-bold text-[#e6dcca] text-xs flex justify-between">{skill.name}<span className="text-[9px] text-[#888]">{skill.type.includes('passive') ? 'è¢«åŠ¨' : 'ä¸»åŠ¨'}</span></div><div className="text-[9px] text-[#a89f91] leading-tight mt-1">{skill.desc}</div></div>))}</div></div>
                        <div className="h-1/4 overflow-hidden flex flex-col border-t border-[#5d4d3d] pt-3"><h2 className="text-sm font-bold flex items-center gap-2 mb-2 text-[#a89f91]"><Briefcase size={14} /> è¡Œå›Š</h2><div className="overflow-y-auto space-y-1.5 pr-2 custom-scrollbar">{player.bag.length === 0 && <div className="text-xs text-[#555] text-center mt-4">ç©ºç©ºå¦‚ä¹Ÿ</div>}{player.bag.map((item, idx) => { const isEquipped = player.slots.weapon === item || player.slots.clothes === item || player.slots.guard === item; const isConsumable = item.type === 'consumable'; return (<div key={idx} onClick={() => handleEquip(item, idx)} className={`px-2 py-1.5 rounded-sm border text-xs flex justify-between items-center cursor-pointer transition-all hover:bg-[#3e3228] ${isEquipped ? 'bg-[#3e2323] border-[#8b2e2e]' : 'bg-[#352b22] border-[#4a3b32]'}`}><span className={`${item.rarity===2 ? 'text-[#eebbcb]' : 'text-[#d6d3cd]'} ${isEquipped ? 'font-bold' : ''}`}>{item.name} {isEquipped && <span className="text-[8px] text-[#8b2e2e] bg-[#000]/20 px-1 rounded ml-1">[å·²è£…å¤‡]</span>}{isConsumable && <span className="text-[8px] text-[#10b981] bg-[#000]/20 px-1 rounded ml-1">[è¯å“]</span>}</span><div className="flex items-center gap-2"><span className="text-[#888] scale-90">{item.type === 'consumable' ? `å›+${item.heal}` : item.atk > 0 ? `+${item.atk}æ”»` : `+${item.hp}è¡€`}</span>{!isEquipped && <button onClick={(e) => handleSell(e, item, idx)} className="bg-[#5d4d3d] text-[#d6d3cd] px-1 rounded text-[9px] hover:bg-[#b91c1c]">[å”®]</button>}</div></div>);})}</div></div>
                    </div>

                    {/* ä¸­é—´ */}
                    <div className="flex-1 flex flex-col relative bg-[#f4f0e6] shadow-inner">
                         <div className="absolute inset-0 opacity-20 pointer-events-none" style={{backgroundImage: `url("data:image/svg+xml,%3Csvg width='200' height='200' viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.4'/%3E%3C/svg%3E")`}}></div>
                         {gameState === 'RESTING' && <div className="absolute inset-0 bg-[#2a303c]/60 z-10 pointer-events-none backdrop-grayscale-[0.5] transition-all duration-1000"></div>}
                         <div className="absolute top-8 w-full text-center z-10"><div className="inline-block border-2 border-[#8b2e2e] text-[#8b2e2e] px-6 py-2 font-serif font-bold text-xl tracking-widest bg-[#f4f0e6]/80 shadow-sm transform -rotate-1 rounded-sm relative cursor-pointer" onClick={handleTitleClick}><div className="absolute inset-0 border border-[#8b2e2e] m-1 pointer-events-none"></div>{STORY_CONFIGS[player.id]?.[stage]?.title || `ç¬¬ ${stage} å±€`}</div></div>
                         <div className="flex-1 relative flex items-center justify-center overflow-hidden">
                             <div className="absolute bottom-1/4 w-3/4 h-[1px] bg-[#4a3b32]/20"></div>
                             {/* Player */}
                             <div className="absolute left-[15%] bottom-[20%] md:bottom-[25%] transition-transform duration-300 z-10" ref={playerRef}>
                                 <div className="absolute -top-12 left-1/2 -translate-x-1/2 text-sm font-bold text-[#4a3b32] bg-[#f4f0e6] border border-[#a89f91] px-3 py-1 shadow-sm whitespace-nowrap rounded-sm">{player.name} <span className="text-[#b45309] text-xs">Lv.{player.level}</span></div>
                                 
                                 {/* åˆ é™¤äº†æ­¤å¤„é‡å¤è°ƒç”¨çš„è¡¨æƒ…åŒ…ç»„ä»¶ï¼Œä¿®å¤æ®‹ç•™é˜´å½±é—®é¢˜ */}
                                 
                                 {partnerActive && currentPartner && (<div ref={partnerRef} className="absolute left-[-80px] bottom-0 w-24 h-32 md:w-32 md:h-40 transition-all duration-500" style={{zIndex: 5}}><PaperStickman color={currentPartner.color} equipment={{}} charVisual={currentPartner.visual}/></div>)}
                                 <div className="w-24 h-32 md:w-32 md:h-40 relative transform -rotate-2 origin-bottom transition-all duration-500 hover:scale-105"><PaperStickman color="#2d2d2d" slots={player.slots} isSleeping={gameState === 'RESTING'} charVisual={player.visual} /><div className="absolute -bottom-3 left-2 right-2 h-3 bg-black/10 rounded-[50%] blur-sm transform scale-x-125"></div></div>
                                 {floatingTexts.filter(t => t.target === 'player').map(t => (<div key={t.id} className={`absolute -top-20 left-1/2 -translate-x-1/2 font-bold animate-float-up pointer-events-none whitespace-nowrap font-serif ${t.type==='success'?'text-[#15803d] text-3xl drop-shadow-sm':'text-[#b91c1c] text-3xl drop-shadow-sm'}`}>{t.value}</div>))}
                             </div>
                             {gameState === 'BATTLE' && (<div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-8xl font-black text-[#8b2e2e]/10 pointer-events-none select-none font-serif">{player.id === 'xie_huaian' ? 'è°‹' : 'å‰‘'}</div>)}
                             {/* Enemy */}
                             {gameState !== 'MENU' && gameState !== 'RESTING' && (<div className="absolute right-[15%] bottom-[20%] md:bottom-[25%] transition-transform duration-300 z-10" ref={enemyRef}>
                                <div className="absolute -top-12 left-1/2 -translate-x-1/2 text-sm font-bold text-[#f4f0e6] bg-[#2a231d] px-3 py-1 shadow-sm whitespace-nowrap rounded-sm border border-[#4a3b32]">{enemy.name}</div>
                                
                                {/* åˆ é™¤äº†æ­¤å¤„é‡å¤è°ƒç”¨çš„è¡¨æƒ…åŒ…ç»„ä»¶ï¼Œä¿®å¤æ®‹ç•™é˜´å½±é—®é¢˜ */}
                                
                                <div className={`w-24 h-32 md:w-32 md:h-40 relative transform rotate-2 origin-bottom transition-all duration-500 ${enemy.isBoss ? 'scale-125' : ''}`}><PaperStickman color="#3e2323" isEnemy={true} charVisual={enemy.visual} /><div className="absolute -bottom-3 left-2 right-2 h-3 bg-black/10 rounded-[50%] blur-sm transform scale-x-125"></div></div><div className="absolute -bottom-6 w-full h-1.5 bg-[#d6d3cd] rounded-full overflow-hidden border border-[#a89f91]"><div className="h-full bg-[#b91c1c]" style={{width: `${(enemy.currentHp / enemy.maxHp) * 100}%`}}></div></div>{floatingTexts.filter(t => t.target === 'enemy').map(t => (<div key={t.id} className={`absolute -top-20 left-1/2 -translate-x-1/2 font-bold pointer-events-none animate-float-up whitespace-nowrap font-serif ${t.type === 'crit' ? 'text-5xl text-[#d97706] drop-shadow-md' : 'text-3xl text-[#1f2937]'}`}>{t.value}</div>))}</div>)}
                         </div>
                         {/* Bottom Logs */}
                         <div className="h-32 bg-[#e6ded5] border-t-2 border-[#d6d3cd] p-3 font-serif text-sm relative shadow-[inset_0_2px_4px_rgba(0,0,0,0.05)] flex justify-between"><div className="flex-1 overflow-y-auto custom-scrollbar">{logs.map(log => (<div key={log.id} className={`mb-1 ${log.type==='damage'?'text-[#991b1b]':log.type==='loot'?'text-[#7e22ce] font-bold':log.type==='error'?'text-red-700 font-bold':log.type==='success'?'text-[#15803d] font-bold':'text-[#57534e]'}`}>{log.text}</div>))}<div ref={logsEndRef} /></div><div className="ml-4 flex gap-3 items-center"><button onClick={() => updatePlayer(prev => { const newVal = !stateRef.current.isAutoBattle; setIsAutoBattle(newVal); return prev; })} className={`w-12 h-12 rounded-full border-2 shadow-md flex items-center justify-center transition-all ${isAutoBattle ? 'bg-[#15803d] border-[#166534] text-white' : 'bg-[#a8a29e] border-[#57534e] text-white'}`} title={isAutoBattle ? "åˆ‡æ¢ä¸ºæ‰‹åŠ¨" : "åˆ‡æ¢ä¸ºè‡ªåŠ¨"}>{isAutoBattle ? <Zap size={20} /> : <MousePointer size={20} />}</button><span className="text-[10px] text-[#57534e] mt-1 font-bold">{isAutoBattle ? "è‡ªåŠ¨ä¸­" : "æ‰‹åŠ¨"}</span>{!isAutoBattle && gameState === 'BATTLE' && (<button onClick={manualAttack} className="w-14 h-14 rounded-full bg-[#b91c1c] border-4 border-[#7f1d1d] shadow-lg flex flex-col items-center justify-center text-white hover:scale-110 active:scale-95 transition-all animate-pulse"><Sword size={24} /><span className="text-[10px] font-bold">å‡ºæ‹›</span></button>)}<button onClick={() => setShowMap(true)} className="w-12 h-12 rounded-full bg-[#57534e] border-2 border-[#a89f91] shadow-lg flex flex-col items-center justify-center text-[#e6dcca] hover:scale-110 active:scale-95 transition-all"><Map size={18} /><span className="text-[9px] font-bold">èˆ†å›¾</span></button><button onClick={() => openShop()} className="w-12 h-12 rounded-full bg-[#3e2323] border-2 border-[#8b2e2e] shadow-lg flex flex-col items-center justify-center text-[#e6dcca] hover:scale-110 active:scale-95 transition-all"><Store size={18} /><span className="text-[9px] font-bold">é¬¼å¸‚</span></button><button onClick={openPartnerSelect} disabled={partnerCooldownTimer > 0 || !player.partnerUnlocked || gameState !== 'BATTLE'} className={`w-12 h-12 rounded-full border-2 shadow-lg flex flex-col items-center justify-center relative overflow-hidden transition-all ${!player.partnerUnlocked ? 'bg-gray-400 border-gray-500 opacity-50 cursor-not-allowed' : partnerCooldownTimer > 0 ? 'bg-gray-300 border-gray-400 cursor-wait' : 'bg-[#d4af37] border-[#b45309] hover:scale-110 active:scale-95 cursor-pointer'}`}>{partnerCooldownTimer > 0 && <div className="absolute inset-0 bg-black/50 flex items-center justify-center text-white text-[10px] font-bold z-10">{Math.ceil(partnerCooldownTimer)}</div>}<Users size={18} className={player.partnerUnlocked ? "text-[#3e2323]" : "text-gray-600"} /><span className="text-[9px] text-[#57534e] mt-0.5 font-bold">{!player.partnerUnlocked ? "æœªè¯†" : "åŠ©æˆ˜"}</span></button></div></div>
                    </div>

                    {/* Right Side */}
                    <div className="w-full md:w-72 bg-[#fdfbf7] border-l-4 border-[#d6d3cd] flex flex-col shadow-xl z-20 relative">
                        <div className="p-4 bg-[#f4f0e6] border-b border-[#e5e7eb] font-bold text-[#8b2e2e] flex items-center justify-center gap-2 font-serif text-lg tracking-widest relative"><div className="absolute left-4 opacity-50"><MessageCircle size={18} /></div>{player.id === 'xie_huaian' ? 'é•¿å®‰å¯†è¯­' : 'æ±Ÿæ¹–ä¼ é—»'}</div>
                        <div className="flex-1 overflow-y-auto p-4 space-y-6 custom-scrollbar bg-[#fdfbf7]" style={{backgroundImage: 'radial-gradient(#e5e7eb 1px, transparent 1px)', backgroundSize: '20px 20px'}}>{chats.map(chat => { const isPlayer = chat.speaker === 'Player'; return (<div key={chat.id} className={`flex flex-col ${isPlayer ? 'items-end' : 'items-start'} animate-pop-in group`}><span className="text-[10px] text-[#a89f91] mb-1 px-1">{isPlayer ? player.name : enemy.name}</span><div className={`relative max-w-[90%] px-4 py-3 text-sm shadow-sm border ${isPlayer ? 'bg-white border-[#d6d3cd] text-[#4a3b32] rounded-l-xl rounded-br-sm rounded-tr-xl' : 'bg-[#2a231d] border-[#4a3b32] text-[#e6dcca] rounded-r-xl rounded-bl-sm rounded-tl-xl'}`}>{chat.text}</div></div>); })}<div ref={chatsEndRef} /></div>
                    </div>

                    {/* Modals */}
                    {showStats && (<div className="absolute inset-0 bg-black/80 z-50 flex items-center justify-center backdrop-blur-sm"><div className="bg-[#2a231d] p-0 rounded-sm border-4 border-[#8b2e2e] w-[90%] max-w-xl shadow-2xl relative text-[#e6dcca] flex overflow-hidden"><button onClick={() => setShowStats(false)} className="absolute top-4 right-4 text-[#888] hover:text-white z-10"><X size={24}/></button><div className="w-1/2 bg-[#3e342b] p-6 flex flex-col items-center justify-center border-r border-[#5d4d3d]"><div className="w-48 h-64 relative"><PaperStickman color="#2d2d2d" slots={player.slots} charVisual={player.visual} /></div><h2 className="text-2xl font-bold font-serif text-[#fbbf24] mt-4">{charData.name}</h2><p className="text-xs text-[#a89f91]">çœŸåï¼š{charData.realName}</p><p className="text-xs text-[#888] mt-2 italic text-center px-4">"{charData.desc}"</p></div><div className="w-1/2 p-6 flex flex-col bg-[url('https://www.transparenttextures.com/patterns/wood-pattern.png')]"><h3 className="text-lg font-bold text-[#d4af37] mb-4 flex items-center gap-2 border-b border-[#5d4d3d] pb-2"><Shield size={18} /> å±æ€§è¯¦æƒ…</h3><div className="space-y-3 text-sm mb-6"><div className="flex justify-between border-b border-[#5d4d3d]/30 pb-1"><span className="text-[#a89f91]">ç­‰çº§</span><span className="text-[#e6dcca] font-bold">Lv.{player.level}</span></div><div className="flex justify-between border-b border-[#5d4d3d]/30 pb-1"><span className="text-[#a89f91]">ç”Ÿå‘½å€¼</span><span className="text-[#10b981] font-bold">{Math.floor(player.currentHp)} / {stats.maxHp}</span></div><div className="flex justify-between border-b border-[#5d4d3d]/30 pb-1"><span className="text-[#a89f91]">æ­¦/æ™º</span><span className="text-[#ef4444] font-bold">{stats.atk} <span className="text-[10px] text-[#888] font-normal">({player.baseAtk} + {stats.bonusAtk})</span></span></div><div className="flex justify-between border-b border-[#5d4d3d]/30 pb-1"><span className="text-[#a89f91]">æ´å¯Ÿ</span><span className="text-[#f97316] font-bold">{stats.crit}% <span className="text-[10px] text-[#888] font-normal">({player.baseCrit} + {stats.bonusCrit})</span></span></div><div className="flex justify-between border-b border-[#5d4d3d]/30 pb-1"><span className="text-[#a89f91]">é˜…å†</span><span className="text-[#d4af37] font-bold">{player.exp} / {player.maxExp}</span></div></div><div className="mt-auto"><div className="border-2 border-dashed border-[#5d4d3d] bg-[#1a1612] p-4 rounded flex items-center justify-between opacity-60 cursor-not-allowed group relative"><div className="flex items-center gap-3"><Award size={24} className="text-[#888]" /><div><div className="font-bold text-[#888]">æˆå°±ç³»ç»Ÿ</div><div className="text-[10px] text-[#555]">è®°å½•ä½ çš„æ±Ÿæ¹–ä¼ è¯´</div></div></div><Lock size={18} className="text-[#888]" /><div className="absolute -top-8 left-1/2 -translate-x-1/2 bg-black text-white text-xs px-2 py-1 rounded hidden group-hover:block whitespace-nowrap">å¼€å‘ä¸­ï¼Œæ•¬è¯·æœŸå¾…</div></div></div></div></div></div>)}

                    {showShop && (<div className="absolute inset-0 bg-black/80 z-50 flex items-center justify-center backdrop-blur-sm"><div className="bg-[#2a231d] p-6 rounded-sm border-4 border-[#8b2e2e] w-[90%] max-w-2xl max-h-[80vh] flex flex-col shadow-2xl relative text-[#e6dcca]"><button onClick={() => setShowShop(false)} className="absolute top-4 right-4 text-[#888] hover:text-white"><X size={24}/></button><div className="text-center mb-6 border-b border-[#5d4d3d] pb-4"><h2 className="text-3xl font-bold font-serif text-[#d4af37] tracking-[0.5em]">é¬¼å¸‚</h2><div className="flex justify-center items-center gap-2 mt-1 text-[#fbbf24] font-mono bg-[#1e1915] rounded px-3 py-1 w-fit mx-auto border border-[#5d4d3d]"><Clock size={14}/> ä¸‹ä¸€æ¬¡è¿›è´§: {Math.floor(Math.max(0, shopState.nextRefresh - Date.now()) / 3600000)}æ—¶ {Math.floor((Math.max(0, shopState.nextRefresh - Date.now()) % 3600000) / 60000)}åˆ†</div><div className="mt-2 text-[#fbbf24] font-bold flex items-center justify-center gap-2"><Coins size={16}/> ä½™é¢: {player.money} ä¸¤</div><div className="mt-2"><button onClick={() => refreshShop(player.id, true)} className="text-[10px] text-[#a89f91] hover:text-white underline">èŠ±{SHOP_REFRESH_COST}ä¸¤æ‰“ç‚¹å…³ç³» (åˆ·æ–°)</button></div></div><div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 overflow-y-auto custom-scrollbar p-2">{shopState.items.map((item) => (<div key={item.id} className="bg-[#1e1915] p-3 rounded border border-[#3e342b] flex flex-col justify-between hover:border-[#d4af37] transition-all"><div><div className={`font-bold ${item.rarity===2?'text-[#eebbcb]':'text-[#d6d3cd]'}`}>{item.name}</div><div className="text-[10px] text-[#888] my-1">{item.desc}</div><div className="text-xs text-[#a89f91]">{item.type === 'consumable' ? `å›+${item.heal}` : <>{item.atk>0?`æ”»+${item.atk} `:''}{item.hp>0?`è¡€+${item.hp} `:''}{item.crit?`æš´+${item.crit}%`:''}</>}</div></div><button onClick={() => handleBuy(item)} className="mt-3 w-full bg-[#3e342b] hover:bg-[#8b2e2e] text-[#d6d3cd] py-1 rounded text-xs border border-[#5d4d3d] flex justify-between px-3 items-center"><span>è´­ä¹°</span><span className="text-[#fbbf24]">{item.price} ä¸¤</span></button></div>))}</div></div></div>)}

                    {showPartnerSelect && (<div className="absolute inset-0 bg-black/80 z-50 flex items-center justify-center backdrop-blur-sm"><div className="bg-[#2a231d] p-6 rounded-sm border-4 border-[#b45309] w-[90%] max-w-lg shadow-2xl relative text-[#e6dcca]"><button onClick={() => setShowPartnerSelect(false)} className="absolute top-4 right-4 text-[#888] hover:text-white"><X size={24}/></button><div className="text-center mb-6 border-b border-[#5d4d3d] pb-4"><h2 className="text-2xl font-bold font-serif text-[#d4af37] tracking-[0.3em]">æ±Ÿæ¹–è±ªæ°</h2><p className="text-[#a89f91] text-xs mt-1">æ‹©ä¸€çŸ¥å·±ï¼Œå…±èµ´ç”Ÿæ­»</p></div><div className="space-y-3 max-h-[60vh] overflow-y-auto custom-scrollbar p-1">{currentPartnerList.map((p) => { const isUnlocked = unlockedPartners.includes(p.id); return (<div key={p.id} className={`p-4 rounded border flex justify-between items-center transition-all ${isUnlocked ? 'bg-[#1e1915] border-[#3e342b] hover:border-[#d4af37]' : 'bg-[#1a1612] border-[#292524] opacity-60'}`}><div className="flex gap-4 items-center"><div className="w-12 h-12 rounded-full border-2 border-[#5d4d3d] bg-[#2a231d] flex items-center justify-center overflow-hidden"><div className="scale-[0.4] origin-center translate-y-2"><PaperStickman charVisual={p.visual} color={p.color} /></div></div><div><div className="font-bold text-[#e6dcca]">{p.name} <span className="text-xs text-[#a89f91] font-normal">[{p.title}]</span></div><div className="text-[10px] text-[#888] mt-1">{p.desc}</div></div></div>{isUnlocked ? <button onClick={() => summonSelectedPartner(p)} className="bg-[#b45309] hover:bg-[#92400e] text-white px-4 py-2 rounded text-sm font-bold border border-[#fcd34d] shadow-sm active:scale-95">å‡ºæˆ˜</button> : <div className="text-xs text-[#555] bg-[#0c0a09] px-3 py-1 rounded">Lv.{p.unlockLevel} è§£é”</div>}</div>); })}</div></div></div>)}

                    {showMap && (<div className="absolute inset-0 bg-black/80 z-50 flex items-center justify-center backdrop-blur-sm"><div className="bg-[#e6dcca] p-6 rounded-sm border-8 border-[#3e2323] w-[90%] max-w-2xl shadow-2xl relative text-[#3e2323] flex flex-col items-center"><button onClick={() => setShowMap(false)} className="absolute top-4 right-4 text-[#888] hover:text-[#b91c1c] z-10"><X size={24}/></button><h2 className="text-3xl font-bold font-serif text-[#8b2e2e] tracking-[0.5em] mb-2">{player.id === 'xie_huaian' ? 'é•¿å®‰èˆ†å›¾' : 'æ±Ÿæ¹–è¡Œè·¯'}</h2><div className="grid grid-cols-5 gap-4 w-full p-4">{Object.entries(STORY_CONFIGS[player.id] || STORY_CONFIGS['xie_huaian']).map(([lvl, config]) => { const levelNum = parseInt(lvl); const isUnlocked = levelNum <= maxUnlockedStage; const isCurrent = levelNum === stage; return (<button key={lvl} onClick={() => isUnlocked ? selectStage(levelNum) : null} disabled={!isUnlocked} className={`aspect-square rounded flex flex-col items-center justify-center border-2 transition-all relative ${isUnlocked ? 'bg-[#f4f0e6] border-[#8b2e2e] hover:bg-[#fed7aa] cursor-pointer shadow-md' : 'bg-[#a8a29e] border-[#57534e] cursor-not-allowed opacity-50 grayscale'} ${isCurrent ? 'ring-4 ring-[#d4af37]' : ''}`}><div className="font-bold text-lg font-serif">{lvl}</div><div className="text-[10px] text-center leading-tight px-1 mt-1">{config.title}</div>{config.boss && <div className="absolute top-1 right-1 text-[#b91c1c]"><Skull size={12}/></div>}</button>); })}</div></div></div>)}
                    
                    {gameState === 'RESTING' && (<div className="absolute inset-0 z-40 flex items-center justify-center pointer-events-none"><div className="bg-[#2a231d] p-8 rounded-lg shadow-2xl pointer-events-auto text-center border-4 border-[#5d4d3d] text-[#e6dcca] w-80 relative overflow-hidden"><Moon size={48} className="mx-auto mb-4 text-[#fbbf24] animate-pulse relative z-10" /><h2 className="text-2xl font-bold mb-2 font-serif relative z-10">é‡ä¼¤é¿é™©ä¸­...</h2><div className="text-4xl font-mono mb-4 text-[#fbbf24] relative z-10">{Math.floor(restTime / 60)}:{String(restTime % 60).padStart(2, '0')}</div><div className="w-full bg-[#1c1917] h-3 rounded-full mb-2 overflow-hidden border border-[#444] relative z-10"><div className="bg-[#15803d] h-full transition-all duration-1000" style={{width: `${(player.currentHp / stats.maxHp) * 100}%`}}></div></div><div className="text-xs text-[#a89f91] mb-6 relative z-10">é™å¾…æ—¶æœº: {Math.floor(player.currentHp)}/{stats.maxHp}</div><div className="flex gap-2"><button onClick={instantRevive} className="flex-1 bg-[#d4af37] hover:bg-[#b45309] text-[#2a231d] font-bold py-2 rounded text-xs border border-[#fcd34d]"><Zap size={14} className="inline mr-1"/> ç«‹å³å¤æ´»</button><button onClick={() => { setShowMap(true); }} className="flex-1 bg-[#57534e] hover:bg-[#44403c] text-white font-bold py-2 rounded text-xs border border-[#a89f91]"><Map size={14} className="inline mr-1"/> æ’¤è‡³èˆ†å›¾</button></div></div></div>)}

                    {gameState === 'VICTORY' && (<div className="absolute inset-0 z-40 flex items-center justify-center pointer-events-none"><div className="bg-[#fef3c7] border-4 border-[#b45309] p-8 rounded-sm shadow-xl pointer-events-auto animate-bounce-in flex flex-col items-center transform rotate-1"><Trophy size={56} className="text-[#d97706] mb-3 drop-shadow-md" /><h2 className="text-3xl font-bold mb-4 font-serif text-[#92400e] tracking-widest">èƒœå¤©åŠå­</h2><div className="w-full h-px bg-[#b45309]/30 mb-4"></div><div className="text-sm text-[#a89f91] mb-4 animate-pulse">2ç§’åè‡ªåŠ¨è¿›å…¥ä¸‹ä¸€å±€...</div><button onClick={nextStage} className="bg-[#b45309] text-[#fffbeb] px-8 py-2 rounded-sm font-bold hover:bg-[#92400e] border-2 border-[#fcd34d] shadow-md active:translate-y-1 transition-all font-serif text-lg pointer-events-auto">ä¸‹ä¸€å±€ (ç«‹å³)</button></div></div>)}
                    
                    {gameState === 'GAME_COMPLETED' && (<div className="absolute inset-0 bg-[#1c1917]/90 z-50 flex items-center justify-center backdrop-blur-sm"><div className="bg-[#f4f0e6] p-12 rounded-sm border-8 border-[#2a231d] shadow-2xl text-center max-w-lg w-full transform rotate-1 relative animate-pop-in"><Trophy size={64} className="mx-auto mb-6 text-[#d97706]" /><h1 className="text-5xl font-black mb-4 text-[#2a231d] tracking-widest font-serif" style={{textShadow: '2px 2px 0px rgba(0,0,0,0.1)'}}>å±€ç»ˆäººæ•£</h1><p className="text-[#78716c] mb-8 font-serif italic text-xl">â€” çº¸ä¸Šæ±Ÿæ¹– Â· å®Œ â€”</p><div className="bg-[#e6ded5] p-6 rounded-sm border border-[#d6d3cd] text-center text-sm mb-8 font-serif leading-loose text-[#444]"><p>æ©æ€¨æƒ…ä»‡ï¼Œçš†éšé£å»ã€‚</p><p>æ±Ÿæ¹–è·¯è¿œï¼Œæœ‰ç¼˜å†ä¼šã€‚</p><p className="text-lg font-bold text-[#8b2e2e] mt-4">åç»­å‰§æƒ… Â· æ­£åœ¨å¼€å‘ä¸­</p></div><button onClick={() => { setGameState('LOGIN'); }} className="w-full bg-[#3e342b] text-[#f4f0e6] py-3 rounded-sm font-bold hover:bg-[#2a231d] hover:scale-[1.02] transition-all flex items-center justify-center gap-2 border-2 border-[#a8a29e] shadow-lg text-lg font-serif">è¿”å›é¦–é¡µ</button></div></div>)}
                </div>
             );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(React.createElement(PaperDuel));
    </script>
</body>
</html>
